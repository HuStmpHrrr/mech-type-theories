{-# OPTIONS --without-K --safe #-}

open import Level hiding (_âŠ”_)
open import Axiom.Extensionality.Propositional

-- Semantic judgments for Î  types
module NonCumulative.Completeness.Pi (fext : Extensionality 0â„“ (suc 0â„“)) where

open import Data.Nat
open import Data.Nat.Properties

open import Lib
open import NonCumulative.Completeness.LogRel
open import NonCumulative.Completeness.Substitutions fext
open import NonCumulative.Completeness.Terms fext

open import NonCumulative.Semantics.Properties.PER fext


Î -[]â€² : âˆ€ {i j k} â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ S âˆ¶[ 1 + i ] Se i â†’
        (S â†™ i) âˆ· Î” âŠ¨ T âˆ¶[ 1 + j ] Se j â†’
        k â‰¡ max i j â†’
        -------------------------------------------------
        Î“ âŠ¨ Î  (S â†™ i) (T â†™ j) [ Ïƒ ] â‰ˆ Î  (S [ Ïƒ ] â†™ i) (T [ q (S â†™ i) Ïƒ ] â†™ j) âˆ¶[ 1 + k ] Se k
Î -[]â€² {_} {Ïƒ} {_} {S} {T} {i} {j} {k} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨S) (âˆ·-cong âŠ¨Î”â‚‚ rel _ , âŠ¨T) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------------------------------------------------
                 Î£ (RelTyp _ (Se k) Ï (Se k) Ïâ€²)
                 Î» rel â†’ RelExp (Î  (S â†™ i) (T â†™ j) [ Ïƒ ]) Ï (Î  (S [ Ïƒ ] â†™ i) (T [ q (S â†™ i) Ïƒ ] â†™ j)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp _ (Se k) Ï (Se k) Ïâ€²)
                       Î» rel â†’ RelExp (Î  (S â†™ i) (T â†™ j) [ Ïƒ ]) Ï (Î  (S [ Ïƒ ] â†™ i) (T [ q (S â†™ i) Ïƒ ] â†™ j)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = U eq _ }
                     , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eq)) = record
                        { âŸ¦TâŸ§   = U k
                        ; âŸ¦Tâ€²âŸ§  = U k
                        ; â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ k
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ k
                        ; Tâ‰ˆTâ€²  = Uâ€²
                        }
                     , record
                         { âŸ¦tâŸ§   = Î  i âŸ¦tâŸ§ (T â†™ j) Ïƒ.âŸ¦ÏƒâŸ§
                         ; âŸ¦tâ€²âŸ§  = Î  i âŸ¦tâ€²âŸ§ (T [ q (S â†™ i) Ïƒ ] â†™ j) Ïâ€²
                         ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§)
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                         ; tâ‰ˆtâ€²  = subst (Î  _ _ _ _ â‰ˆ Î  _ _ (T [ _ ] â†™ j) _ âˆˆ_) (sym (ğ•Œ-â‰¡-gen _ Î» z â†’ â‰¤-trans z (â‰¤-reflexive refl))) (result tâ‰ˆtâ€²)
                         }
                  where result : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ ğ•Œ i â†’
                                 ------------------------------------------
                                 Î  i âŸ¦tâŸ§ (T â†™ j) Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  i âŸ¦tâ€²âŸ§ (T [ q (S â†™ i) Ïƒ ] â†™ j) Ïâ€² âˆˆ ğ•Œ k
                        result Sâ‰ˆ = Î -ğ•Œ Sâ‰ˆ step refl
                          where step : a â‰ˆ aâ€² âˆˆ El i Sâ‰ˆ â†’
                                       -----------------------------------------------------------
                                       Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ â†¦ a) (T [ q (S â†™ i) Ïƒ ]) (Ïâ€² â†¦ aâ€²) (ğ•Œ j)
                                step {a} {aâ€²} aâ‰ˆaâ€²
                                  with Ïƒâ‰ˆÎ´â‚ â† âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ Ïƒ.Ïƒâ‰ˆÎ´ = answer
                                  where insert : a â‰ˆ aâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïƒâ‰ˆÎ´â‚))
                                        insert
                                          with record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† rel Ïƒâ‰ˆÎ´â‚
                                             rewrite âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                   | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦tâŸ§ = ğ•Œ-irrel Sâ‰ˆ Tâ‰ˆTâ€² aâ‰ˆaâ€²

                                        answer : Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ â†¦ a) (T [ q (S â†™ i) Ïƒ ]) (Ïâ€² â†¦ aâ€²) (ğ•Œ j)
                                        answer
                                          with âŠ¨T {Ïƒ.âŸ¦ÏƒâŸ§ â†¦ a} {Ïƒ.âŸ¦Î´âŸ§ â†¦ aâ€²} (Ïƒâ‰ˆÎ´â‚ , insert)
                                        ...  | record { âŸ¦TâŸ§ = .(U j) ; âŸ¦Tâ€²âŸ§ = .(U j) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .j) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .j) ; Tâ‰ˆTâ€² = U eq _ }
                                             , re = record
                                                      { âŸ¦TâŸ§   = re.âŸ¦tâŸ§
                                                      ; âŸ¦Tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                                      ; â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦qâŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§) re.â†˜âŸ¦tâ€²âŸ§
                                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eq))) re.tâ‰ˆtâ€²
                                                      }
                                          where module re = RelExp re


Î -congâ€² : âˆ€ {i j k} â†’
          Î“ âŠ¨ S â‰ˆ Sâ€² âˆ¶[ 1 + i ] Se i â†’
          (S â†™ i) âˆ· Î“ âŠ¨ T â‰ˆ Tâ€² âˆ¶[ 1 + j ] Se j â†’
          k â‰¡ max i j â†’
          ----------------------------------
          Î“ âŠ¨ Î  (S â†™ i) (T â†™ j) â‰ˆ Î  (Sâ€² â†™ i) (Tâ€² â†™ j) âˆ¶[ 1 + k ] Se k
Î -congâ€² {_} {S} {Sâ€²} {T} {Tâ€²} {i} {j} {k} (âŠ¨Î“ , Sâ‰ˆSâ€²) (âˆ·-cong âŠ¨Î“â‚ rel _ , Tâ‰ˆTâ€²) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------
                 Î£ (RelTyp _ (Se k) Ï (Se k) Ïâ€²)
                 Î» rel â†’ RelExp (Î  (S â†™ i) (T â†™ j)) Ï (Î  (Sâ€² â†™ i) (Tâ€² â†™ j)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Sâ‰ˆSâ€² Ïâ‰ˆÏâ€²
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eq _ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eq)) = record
                                                 { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                                                 ; Tâ‰ˆTâ€²  = Uâ€²
                                                 }
                                             , record
                                                 { â†˜âŸ¦tâŸ§  = âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§
                                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                 ; tâ‰ˆtâ€²  = subst (Î  _ _ _ _ â‰ˆ Î  _ _ _ _ âˆˆ_) (sym (ğ•Œ-â‰¡-gen _ Î» z â†’ â‰¤-trans z (â‰¤-reflexive refl))) (Î -ğ•Œ tâ‰ˆtâ€² result refl)
                                                 }
          where result : a â‰ˆ aâ€² âˆˆ El _ tâ‰ˆtâ€² â†’
                         ------------------------------------------------
                         Î RT T (Ï â†¦ a) Tâ€² (Ïâ€² â†¦ aâ€²) (ğ•Œ j)
                result {a} {aâ€²} aâ‰ˆaâ€²
                  with Ïâ‰ˆÏâ€²â‚ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€² = answer
                  where insert : a â‰ˆ aâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²â‚))
                        insert
                          with record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† rel Ïâ‰ˆÏâ€²â‚
                             rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦tâŸ§ = El-one-sided tâ‰ˆtâ€² Tâ‰ˆTâ€² aâ‰ˆaâ€²

                        answer : Î RT T (Ï â†¦ a) Tâ€² (Ïâ€² â†¦ aâ€²) (ğ•Œ j)
                        answer
                          with Tâ‰ˆTâ€² {Ï â†¦ a} {Ïâ€² â†¦ aâ€²} (Ïâ‰ˆÏâ€²â‚ , insert)
                        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eq _ }
                             , re = record
                                      { â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                      ; â†˜âŸ¦Tâ€²âŸ§ = re.â†˜âŸ¦tâ€²âŸ§
                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eq))) re.tâ‰ˆtâ€²
                                      }
                          where module re = RelExp re

Î›-congâ€² : âˆ€ {i j k} â†’
            (S â†™ i) âˆ· Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶[ j ] T â†’
            k â‰¡ max i j â†’
            -----------------------
            Î“ âŠ¨ Î› (S â†™ i) t â‰ˆ Î› (Sâ€² â†™ i) tâ€² âˆ¶[ k ] Î  (S â†™ i) (T â†™ j)
Î›-congâ€² {S} {_} {t} {tâ€²} {T} {_} {i} {j} {k} (âˆ·-cong âŠ¨Î“ rel _ , tâ‰ˆtâ€²) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------
                 Î£ (RelTyp (max i j) (Î  (S â†™ i) (T â†™ j)) Ï (Î  (S â†™ i) (T â†™ j)) Ïâ€²)
                 Î» rel â†’ RelExp (Î› (S â†™ i) t) Ï (Î› (Sâ€² â†™ i) tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with rel Ïâ‰ˆÏâ€²
        ... | record { âŸ¦TâŸ§ = âŸ¦SâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦SâŸ§â€² ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦SâŸ§â€² ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€² }
          = record
            { âŸ¦TâŸ§   = Î  i S.âŸ¦TâŸ§ (T â†™ j) Ï
            ; âŸ¦Tâ€²âŸ§  = Î  i S.âŸ¦Tâ€²âŸ§ (T â†™ j) Ïâ€²
            ; â†˜âŸ¦TâŸ§  = âŸ¦Î âŸ§ S.â†˜âŸ¦TâŸ§
            ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ S.â†˜âŸ¦Tâ€²âŸ§
            ; Tâ‰ˆTâ€²  = projâ‚ result
            }
          , record
            { âŸ¦tâŸ§   = Î› t Ï
            ; âŸ¦tâ€²âŸ§  = Î› tâ€² Ïâ€²
            ; â†˜âŸ¦tâŸ§  = âŸ¦Î›âŸ§ t
            ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ tâ€²
            ; tâ‰ˆtâ€²  = projâ‚‚ result
            }
             where module S = RelTyp (rel Ïâ‰ˆÏâ€²)
                   Tâ‰ˆTâ€² : S.âŸ¦TâŸ§ â‰ˆ S.âŸ¦Tâ€²âŸ§ âˆˆ PERDef.ğ•Œ i _
                   Tâ‰ˆTâ€² = subst (Î» f â†’ S.âŸ¦TâŸ§ â‰ˆ S.âŸ¦Tâ€²âŸ§ âˆˆ PERDef.ğ•Œ i (Î» {jâ€²} â†’ f {jâ€²})) (sym (ğ•Œ-wf-gen i Î» l<i â†’ (â‰¤-trans l<i (â‰¤-trans (mâ‰¤mâŠ”n i j) (â‰¤-reflexive refl))))) S.Tâ‰ˆTâ€²

                   Î res : a â‰ˆ b âˆˆ El i S.Tâ‰ˆTâ€² â†’
                          Î£ (Î RT T (Ï â†¦ a) T (Ïâ€² â†¦ b) (ğ•Œ j)) (Î» res â†’ Î Ì‚ (Î› t Ï) a (Î› tâ€² Ïâ€²) b (El j (Î RT.Tâ‰ˆTâ€² res)))
                   Î res {a} {b} aâ‰ˆb
                     with tâ‰ˆtâ€² {Ï â†¦ a} {Ïâ€² â†¦ b} (Ïâ‰ˆÏâ€² , aâ‰ˆb)
                   ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                        , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                        = record
                          { â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§
                          ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                          ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                          }
                        , record
                          { fa     = âŸ¦tâŸ§
                          ; faâ€²    = âŸ¦tâ€²âŸ§
                          ; â†˜fa    = Î›âˆ™ â†˜âŸ¦tâŸ§
                          ; â†˜faâ€²   = Î›âˆ™ â†˜âŸ¦tâ€²âŸ§
                          ; faâ‰ˆfaâ€² = tâ‰ˆtâ€²
                          }

                   result : Î£ (Î  i S.âŸ¦TâŸ§ (T â†™ j) Ï â‰ˆ Î  i S.âŸ¦Tâ€²âŸ§ (T â†™ j) Ïâ€² âˆˆ ğ•Œ k) (Î» R â†’ Î› t Ï â‰ˆ Î› tâ€² Ïâ€² âˆˆ El k R)
                   result = Î -bundle S.Tâ‰ˆTâ€² Î res refl


$-congâ€² : âˆ€ {i j k} â†’
          Î“ âŠ¨ r â‰ˆ râ€² âˆ¶[ k ] Î  (S â†™ i) (T â†™ j) â†’
          Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶[ i ] S â†’
          k â‰¡ max i j â†’
          -------------------------------
          Î“ âŠ¨ r $ s â‰ˆ râ€² $ sâ€² âˆ¶[ j ] T [| s âˆ¶ S â†™ i ]
$-congâ€² {_} {r} {râ€²} {S} {T} {s} {sâ€²} {i} {j} {k} (âŠ¨Î“ , râ‰ˆrâ€²) (âŠ¨Î“â‚ , sâ‰ˆsâ€²) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -----------------------------------------
                 Î£ (RelTyp j (T [| s âˆ¶ S â†™ i ]) Ï (T [| s âˆ¶ S â†™ i ]) Ïâ€²)
                 Î» rel â†’ RelExp (r $ s) Ï (râ€² $ sâ€²) Ïâ€² (El j (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²)
             | Ïâ€²â‰ˆÏ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
          with râ‰ˆrâ€² Ïâ‰ˆÏâ€²
             | sâ‰ˆsâ€² Ïâ‰ˆÏ
             | sâ‰ˆsâ€² Ïâ€²â‰ˆÏ
             | sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§â€² ; Tâ‰ˆTâ€² = Î  eq iA RT _ _ }
             , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite ğ•Œ-wf-gen i (Î Iâ‰¤ eq)
             rewrite ğ•Œ-wf-gen j (Î Oâ‰¤ eq)
             rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€² â†˜âŸ¦Tâ€²âŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦Tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§â‚ â†˜âŸ¦tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦tâŸ§ = record
                                           { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§) RT.â†˜âŸ¦TâŸ§
                                           ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§â‚‚) RT.â†˜âŸ¦Tâ€²âŸ§
                                           ; Tâ‰ˆTâ€²  = RT.Tâ‰ˆTâ€²
                                           }
                                       , record
                                           { â†˜âŸ¦tâŸ§  = âŸ¦$âŸ§ â†˜âŸ¦râŸ§ â†˜âŸ¦tâŸ§ rs.â†˜fa
                                           ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦$âŸ§ â†˜âŸ¦râ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ rs.â†˜faâ€²
                                           ; tâ‰ˆtâ€²  = El-transp RTâ€².Tâ‰ˆTâ€² RT.Tâ‰ˆTâ€² rs.faâ‰ˆfaâ€² (sym (âŸ¦âŸ§-det RT.â†˜âŸ¦TâŸ§ RTâ€².â†˜âŸ¦TâŸ§))
                                           }
          where Tâ‰ˆT  = ğ•Œ-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)
                srel = El-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) Tâ‰ˆT tâ‰ˆtâ€²â‚ (El-sym Tâ‰ˆTâ€²â‚‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) tâ‰ˆtâ€²â‚‚)

                module RT  = Î RT (RT (El-one-sided Tâ‰ˆT iA srel))
                module RTâ€² = Î RT (RT (El-one-sided Tâ‰ˆTâ€² iA tâ‰ˆtâ€²))
                module rs  = Î Ì‚ (râ‰ˆrâ€² (El-one-sided Tâ‰ˆTâ€² iA tâ‰ˆtâ€²))


Î›-Î²â€² : âˆ€ {i j} â†’
       (S â†™ i) âˆ· Î“ âŠ¨ t âˆ¶[ j ] T â†’
       Î“ âŠ¨ s âˆ¶[ i ] S â†’
       ----------------------------------
       Î“ âŠ¨ Î› (S â†™ i) t $ s â‰ˆ (t [| s âˆ¶ S â†™ i ]) âˆ¶[ j ] T [| s âˆ¶ S â†™ i ]
Î›-Î²â€² {S} {_} {t} {T} {s} {i} {j} (âˆ·-cong âŠ¨Î“ rel _ , âŠ¨t) (âŠ¨Î“â‚ , âŠ¨s) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 Î£ (RelTyp j (T [| s âˆ¶ S â†™ i ]) Ï (T [| s âˆ¶ S â†™ i ]) Ïâ€²)
                 Î» rel â†’ RelExp (Î› (S â†™ i) t $ s) Ï (t [| s âˆ¶ S â†™ i ]) Ïâ€² (El j (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€² }
             , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² } = helperâ€²
          where
            sâ‰ˆsâ€²â‚ : âŸ¦sâŸ§ â‰ˆ âŸ¦sâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²))
            sâ‰ˆsâ€²â‚
              with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€²â‚ } â† rel Ïâ‰ˆÏâ€²
                rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦SâŸ§â‚
                      | âŸ¦âŸ§-det â†˜âŸ¦Sâ€²âŸ§ â†˜âŸ¦Sâ€²âŸ§â‚
                      = ğ•Œ-irrel Sâ‰ˆSâ€² Sâ‰ˆSâ€²â‚ sâ‰ˆsâ€²

            helperâ€² : Î£ (RelTyp j (T [| s âˆ¶ S â†™ i ]) Ï (T [| s âˆ¶ S â†™ i ]) Ïâ€²)
                      Î» rel â†’ RelExp (Î› (S â†™ i) t $ s) Ï (t [| s âˆ¶ S â†™ i ]) Ïâ€² (El j (RelTyp.Tâ‰ˆTâ€² rel))
            helperâ€²
              with âŠ¨t (Ïâ‰ˆÏâ€² , sâ‰ˆsâ€²â‚)
            ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                 , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = record
                                         { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâŸ§) â†˜âŸ¦TâŸ§
                                         ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ ((âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                         ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                                         }
                                       , record
                                         { â†˜âŸ¦tâŸ§  = âŸ¦$âŸ§ (âŸ¦Î›âŸ§ _) â†˜âŸ¦sâŸ§ (Î›âˆ™ â†˜âŸ¦tâŸ§)
                                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâ€²âŸ§) â†˜âŸ¦tâ€²âŸ§
                                         ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                                         }

Î›-Î·â€² : âˆ€ {i j k} â†’
       Î“ âŠ¨ t âˆ¶[ k ] Î  (S â†™ i) (T â†™ j) â†’
       k â‰¡ max i j â†’
       ----------------------------------
       Î“ âŠ¨ t â‰ˆ Î› (S â†™ i) (t [ wk ] $ v 0) âˆ¶[ k ] Î  (S â†™ i) (T â†™ j)
Î›-Î·â€² {_} {t} {S} {T} {i} {j} {k} (âŠ¨Î“ , âŠ¨t) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -----------------------------------------------------------
                 Î£ (RelTyp k (Î  (S â†™ i) (T â†™ j)) Ï (Î  (S â†™ i) (T â†™ j)) Ïâ€²)
                 Î» rel â†’ RelExp t Ï (Î› (S â†™ i) (t [ wk ] $ v 0)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with âŠ¨t Ïâ‰ˆÏâ€²
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§â€² ; Tâ‰ˆTâ€² = Î  eq iS Tâ‰ˆTâ€² _ _ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite ğ•Œ-wf-gen i (Î Iâ‰¤â€² i j eq)
             rewrite ğ•Œ-wf-gen j (Î Oâ‰¤â€² i j eq) = record
                                              { â†˜âŸ¦TâŸ§  = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§
                                              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§â€²
                                              ; Tâ‰ˆTâ€²  = projâ‚ bund
                                              }
                                              , record
                                              { â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâŸ§
                                              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ _
                                              ; tâ‰ˆtâ€²  = projâ‚‚ bund
                                              }
          where
            helperâ€² : {a b : D} (inp : a â‰ˆ b âˆˆ El _ iS) â†’
                      -----------------------------------------------------------------------------------
                      Î Ì‚ (âŸ¦tâŸ§) a ((Î› (t [ wk ] $ v 0) Ïâ€²)) b (El _ (Î RT.Tâ‰ˆTâ€² (Tâ‰ˆTâ€² inp)))
            helperâ€² {a} {b} inp
              with record { â†˜fa = â†˜fa ; â†˜faâ€² = â†˜faâ€² ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€² } â† tâ‰ˆtâ€² inp = record
                                       { â†˜fa    = â†˜fa
                                       ; â†˜faâ€²   = Î›âˆ™ (âŸ¦$âŸ§ (âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦tâ€²âŸ§) (âŸ¦vâŸ§ 0) â†˜faâ€²)
                                       ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€²
                                       }

            bund = Î -bundle iS (Î» aâ‰ˆb â†’ Tâ‰ˆTâ€² aâ‰ˆb , helperâ€² aâ‰ˆb) eq

curry-helper-T : âˆ€ {i} â†’ âŠ¨ (S â†™ i) âˆ· Î“ â†’ Exp â†’ Exp â†’ Typ â†’ Set
curry-helper-T {i = i} âŠ¨SÎ“@(âˆ·-cong âŠ¨Î“ Srel _) t tâ€² T =
  âˆ€ {j} â†’ (âˆ€ {Ï Ïâ€²} (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨SÎ“ âŸ§Ï) â†’ Î£ (RelTyp j T Ï T Ïâ€²) Î» rel â†’ let open RelTyp rel in RelExp t Ï tâ€² Ïâ€² (El _ Tâ‰ˆTâ€²)) â†’
  âˆ€ {Ï Ïâ€²} (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’ âˆ€ {a b} â†’ a â‰ˆ b âˆˆ El i (RelTyp.Tâ‰ˆTâ€² (Srel Ïâ‰ˆÏâ€²)) â†’
  Î£ (RelTyp j T (Ï â†¦ a) T (Ïâ€² â†¦ b)) Î» rel â†’ let open RelTyp rel in RelExp t (Ï â†¦ a) tâ€² (Ïâ€² â†¦ b) (El _ Tâ‰ˆTâ€²)

curry-helper : âˆ€ {i} (âŠ¨SÎ“ : âŠ¨ (S â†™ i) âˆ· Î“) â†’ curry-helper-T âŠ¨SÎ“ t tâ€² T
curry-helper {i = i} âŠ¨SÎ“@(âˆ·-cong âŠ¨Î“ Srel _) orig Ïâ‰ˆÏâ€² aâ‰ˆb = orig (Ïâ‰ˆÏâ€² , aâ‰ˆb)


Î›-[]â€² :  âˆ€ {i j k} â†’
         Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
         (S â†™ i) âˆ· Î” âŠ¨ t âˆ¶[ j ] T â†’
         k â‰¡ max i j â†’
         --------------------------------------------
         Î“ âŠ¨ Î› (S â†™ i) t [ Ïƒ ] â‰ˆ Î› (S [ Ïƒ ] â†™ i) (t [ q (S â†™ i) Ïƒ ]) âˆ¶[ k ] Î  (S â†™ i) (T â†™ j) [ Ïƒ ]
Î›-[]â€² {_} {Ïƒ} {_} {S} {t} {T} {i} {j} {k} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨SÎ”@(âˆ·-cong âŠ¨Î”â‚ Srelâ‚ _) , âŠ¨t) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ------------------------------------------------------------------------------
                 Î£ (RelTyp k (Î  (S â†™ i) (T â†™ j) [ Ïƒ ]) Ï (Î  (S â†™ i) (T â†™ j) [ Ïƒ ]) Ïâ€²)
                 Î» rel â†’ RelExp (Î› (S â†™ i) t [ Ïƒ ]) Ï (Î› (S [ Ïƒ ] â†™ i) (t [ q (S â†™ i) Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ïƒ Ïâ‰ˆÏâ€²
          with Ïƒâ‰ˆÎ´â‚ â† âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´
             | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€² } â† Srelâ‚ (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´)
             | âŠ¨tâ€² â† curry-helper âŠ¨SÎ” âŠ¨t (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´) = record
                          { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§)
                          ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦Sâ€²âŸ§)
                          ; Tâ‰ˆTâ€²  = projâ‚ bund
                          }
                        , record
                          { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î›âŸ§ _)
                          ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ _
                          ; tâ‰ˆtâ€²  = projâ‚‚ bund
                          }
          where helperâ€² : a â‰ˆ b âˆˆ El i Sâ‰ˆSâ€² â†’
                          Î£ (Î RT T (âŸ¦ÏƒâŸ§ â†¦ a) T (âŸ¦Î´âŸ§ â†¦ b) (ğ•Œ j))
                          Î» res â†’ Î Ì‚ (Î› t âŸ¦ÏƒâŸ§) a (Î› (t [ q (S â†™ i) Ïƒ ]) Ïâ€²) b (El j (Î RT.Tâ‰ˆTâ€² res))
                helperâ€² {a} {b} aâ‰ˆb
                  with âŠ¨tâ€² aâ‰ˆb
                ... | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                    , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                    = record
                    { âŸ¦TâŸ§   = âŸ¦TâŸ§
                    ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
                    ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§
                    ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                    ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                    }
                    , record
                    { fa     = âŸ¦tâŸ§
                    ; faâ€²    = âŸ¦tâ€²âŸ§
                    ; â†˜fa    = Î›âˆ™ â†˜âŸ¦tâŸ§
                    ; â†˜faâ€²   = Î›âˆ™ (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦Î´âŸ§) â†˜âŸ¦tâ€²âŸ§)
                    ; faâ‰ˆfaâ€² = tâ‰ˆtâ€²
                    }

                bund = Î -bundle Sâ‰ˆSâ€² helperâ€² refl

$-[]â€² : âˆ€ {i j k} â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ r âˆ¶[ k ] Î  (S â†™ i) (T â†™ j) â†’
        Î” âŠ¨ s âˆ¶[ i ] S â†’
        k â‰¡ max i j â†’
        ---------------------------------------------------------
        Î“ âŠ¨ (r $ s) [ Ïƒ ] â‰ˆ r [ Ïƒ ] $ s [ Ïƒ ] âˆ¶[ j ] T [ Ïƒ , s [ Ïƒ ] âˆ¶ S â†™ i ]
$-[]â€² {_} {Ïƒ} {_} {r} {S} {T} {s} {i} {j} {k} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨r) (âŠ¨Î”â‚‚ , âŠ¨s) refl = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 Î£ (RelTyp j (T [ Ïƒ , s [ Ïƒ ] âˆ¶ S â†™ i ]) Ï (T [ Ïƒ , s [ Ïƒ ] âˆ¶ S â†™ i ]) Ïâ€²)
                 Î» rel â†’ RelExp ((r $ s) [ Ïƒ ]) Ï (r [ Ïƒ ] $ s [ Ïƒ ]) Ïâ€² (El j (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ïƒ Ïâ‰ˆÏâ€²
          with âŠ¨r (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´)
             | âŠ¨s (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´)
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Î  eq iS Trel _ _ }
             , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
             | record { âŸ¦TâŸ§ = âŸ¦SâŸ§â‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Sâ€²âŸ§â‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€²â‚ }
             , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
             rewrite ğ•Œ-wf-gen i (Î Iâ‰¤ eq)
             rewrite ğ•Œ-wf-gen j (Î Oâ‰¤ eq)
             rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦SâŸ§â‚
                   | âŸ¦âŸ§-det â†˜âŸ¦Sâ€²âŸ§ â†˜âŸ¦Sâ€²âŸ§â‚
                with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† Trel (ğ•Œ-irrel Sâ‰ˆSâ€²â‚ iS sâ‰ˆsâ€²)
                   | record { â†˜fa = â†˜fa ; â†˜faâ€² = â†˜faâ€² ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€² } â† râ‰ˆrâ€² (ğ•Œ-irrel Sâ‰ˆSâ€²â‚ iS sâ‰ˆsâ€²) = record
                                      { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦sâŸ§)) â†˜âŸ¦TâŸ§
                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                      ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                      }
                                    , record
                                      { â†˜âŸ¦tâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦$âŸ§ â†˜âŸ¦râŸ§ â†˜âŸ¦sâŸ§ â†˜fa)
                                      ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦$âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦râ€²âŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§) â†˜faâ€²
                                      ; tâ‰ˆtâ€² = faâ‰ˆfaâ€²
                                      }
