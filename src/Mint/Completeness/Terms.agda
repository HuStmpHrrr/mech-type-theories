{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

-- Semantic judgments for other term related rules
module Mint.Completeness.Terms (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Lib
open import Mint.Completeness.LogRel

open import Mint.Semantics.Properties.Domain fext
open import Mint.Semantics.Properties.PER fext


âŠ¨-lookup-gen : âˆ€ {x}
               (Î“â‰ˆÎ” : âŠ¨ Î“ â‰ˆ Î”) â†’
               x âˆ¶ T âˆˆ! Î“ â†’
               x âˆ¶ Tâ€² âˆˆ! Î” â†’
               -----------------------------------------------------------
               âˆƒ Î» i â†’
                 âˆ€ {Ï Ïâ€²} â†’
                 Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ Î“â‰ˆÎ” âŸ§Ï â†’
                 Î£ (RelTyp i T Ï Tâ€² Ïâ€²)
                 Î» rel â†’ RelExp (v x) Ï (v x) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
âŠ¨-lookup-gen {T = sub T _} {sub Tâ€² _} (âˆº-cong _ rel) here here
  = _ ,
  Î» (Ïâ‰ˆÏâ€² , Ï0â‰ˆÏâ€²0) â†’
    let open RelTyp (rel Ïâ‰ˆÏâ€²)
    in record
         { RelTyp (rel Ïâ‰ˆÏâ€²)
         ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦TâŸ§
         ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦Tâ€²âŸ§
         }
     , record
         { â†˜âŸ¦tâŸ§  = âŸ¦vâŸ§ 0
         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ 0
         ; tâ‰ˆtâ€²  = Ï0â‰ˆÏâ€²0
         }
âŠ¨-lookup-gen {T = sub T _} {sub Tâ€² _} {suc x} (âˆº-cong Î“â‰ˆÎ” rel) (there TâˆˆÎ“) (there Tâ€²âˆˆÎ”)
  with i , f â† âŠ¨-lookup-gen Î“â‰ˆÎ” TâˆˆÎ“ Tâ€²âˆˆÎ” = i , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âˆº-cong Î“â‰ˆÎ” rel âŸ§Ï â†’
                 ----------------------------------------------------------------------
                 Î£ (RelTyp i (T [ wk ]) Ï (Tâ€² [ wk ]) Ïâ€²)
                 Î» rel â†’ RelExp (v (suc x)) Ï (v (suc x)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper (Ïâ‰ˆÏâ€² , _)
          with f Ïâ‰ˆÏâ€²
        ...  | rt , record { â†˜âŸ¦tâŸ§ = âŸ¦vâŸ§ _ ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
          = record
              { RelTyp rt
              ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦TâŸ§
              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦Tâ€²âŸ§
              }
          , record
              { â†˜âŸ¦tâŸ§  = âŸ¦vâŸ§ _
              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _
              ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
              }
          where open RelTyp rt

âŠ¨-lookup : âˆ€ {x}
           (âŠ¨Î“ : âŠ¨ Î“) â†’
           x âˆ¶ T âˆˆ! Î“ â†’
           ------------------------------------------------------------
           âˆƒ Î» i â†’
             âˆ€ {Ï Ïâ€²} â†’
             Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             Î£ (RelTyp i T Ï T Ïâ€²)
             Î» rel â†’ RelExp (v x) Ï (v x) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
âŠ¨-lookup âŠ¨Î“ TâˆˆÎ“ = âŠ¨-lookup-gen âŠ¨Î“ TâˆˆÎ“ TâˆˆÎ“


v-â‰ˆâ€² : âˆ€ {x} â†’
       âŠ¨ Î“ â†’
       x âˆ¶ T âˆˆ! Î“ â†’
       -------------------
       Î“ âŠ¨ v x â‰ˆ v x âˆ¶ T
v-â‰ˆâ€² âŠ¨Î“ TâˆˆÎ“ = âŠ¨Î“ , âŠ¨-lookup âŠ¨Î“ TâˆˆÎ“


-- This judgment is slightly more difficult than it appears to be. The difficulty
-- comes from the asymmetry of Ïƒ and Ïƒâ€². Though they are given as equivalent in the
-- premise, in the conclusion, only Ïƒ is used. That implies that for two related Ï and
-- Ïâ€², we must derive âŸ¦ T[Ïƒ] âŸ§(Ï) â‰ˆ âŸ¦ T[Ïƒ] âŸ§(Ïâ€²) which evaluates to âŸ¦ T âŸ§(âŸ¦ Ïƒ âŸ§(Ï)) â‰ˆ âŸ¦ T âŸ§(âŸ¦ Ïƒ âŸ§(Ïâ€²)).
-- To arrive at this conclusion, we must first show âŸ¦ Ïƒ âŸ§(Ï) â‰ˆ âŸ¦ Ïƒ âŸ§(Ïâ€²). This is
-- achieved by the followin chain of transitivity:
--
-- âŸ¦ Ïƒ âŸ§(Ï)  â‰ˆ âŸ¦ Ïƒâ€² âŸ§(Ï)         Ï â‰ˆ Ï due to PER properties
-- âŸ¦ Ïƒâ€² âŸ§(Ï) â‰ˆ âŸ¦ Ïƒ âŸ§(Ïâ€²)         Ïâ€² â‰ˆ Ï due to symmetry
--
-- Hence we conclude âŸ¦ Ïƒ âŸ§(Ï) â‰ˆ âŸ¦ Ïƒ âŸ§(Ïâ€²). Then we conclude the goal by applying some
-- proof-irrelevant lemmas to handle the proof relevance nature and arrive at our goal.
--
-- This pattern frequently shows up in other lemmas that has asymmetry.
[]-congâ€² : Î” âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
           Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
           ---------------------------------
           Î“ âŠ¨ t [ Ïƒ ] â‰ˆ tâ€² [ Ïƒâ€² ] âˆ¶ T [ Ïƒ ]
[]-congâ€² {_} {t} {tâ€²} {T} {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î” , i , tâ‰ˆtâ€²) (âŠ¨Î“ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------------
                 Î£ (RelTyp _ (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²)
                 Î» rel â†’ RelExp (t [ Ïƒ ]) Ï (tâ€² [ Ïƒâ€² ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏ â† âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²
             | Ïâ€²â‰ˆÏ â† âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²
             with Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏ
                | Ïƒâ‰ˆÏƒâ€² Ïâ€²â‰ˆÏ
                | Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
        ...     | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§  ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§  ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§  ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§ }
                | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§â€² ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â€² ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€² ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚ }
                | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§â€³ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â€³ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€³ ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚‚ }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦Ïƒâ€²âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€²
                      | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€³ â†˜âŸ¦ÏƒâŸ§
                with Ïƒâ‰ˆÏƒ â† âŸ¦âŸ§Ï-transâ€² âŠ¨Î”â‚ âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î”â‚ âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚) = help
          where help : Î£ (RelTyp _ (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²)
                       Î» rel â†’ RelExp (t [ Ïƒ ]) Ï (tâ€² [ Ïƒâ€² ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î” Ïƒâ‰ˆÏƒ)
                     | tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î” âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚‚)
                ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } , _
                     | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ } , re
                    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â€² â†˜âŸ¦TâŸ§ = record
                                                  { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§
                                                  ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦Tâ€²âŸ§
                                                  ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                                                  }
                                              , record
                                                  { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§
                                                  ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€³ â†˜âŸ¦tâ€²âŸ§
                                                  ; tâ‰ˆtâ€²  = El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² re.tâ‰ˆtâ€²
                                                  }
                  where module re = RelExp re
                        open re


[I]â€² : Î“ âŠ¨ t âˆ¶ T â†’
       --------------------
       Î“ âŠ¨ t [ I ] â‰ˆ t âˆ¶ T
[I]â€² {_} {t} {T} (âŠ¨Î“ , _ , âŠ¨t) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -----------------------------------------------------------
                 Î£ (RelTyp _ T Ï T Ïâ€²)
                 Î» rel â†’ RelExp (t [ I ]) Ï t Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€²
          with rt , re â† âŠ¨t Ïâ‰ˆÏâ€² = rt
                                 , record
                                     { RelExp re
                                     ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§
                                     }
          where open RelExp re


[wk]â€² : âˆ€ {x} â†’
        âŠ¨ S âˆº Î“ â†’
        x âˆ¶ T âˆˆ! Î“ â†’
        ---------------------------------------------------
        S âˆº Î“ âŠ¨ v x [ wk ] â‰ˆ v (suc x) âˆ¶ T [ wk ]
[wk]â€² {S} {_} {T} {x} âŠ¨SÎ“@(âˆº-cong âŠ¨Î“ _) TâˆˆÎ“
  with i , f â† âŠ¨-lookup âŠ¨Î“ TâˆˆÎ“ = âŠ¨SÎ“ , i , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨SÎ“ âŸ§Ï â†’
                 -------------------------------------------------------------------------
                 Î£ (RelTyp _ (T [ wk ]) Ï (sub T wk) Ïâ€²)
                 Î» rel â†’ RelExp (v x [ wk ]) Ï (v (suc x)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} (Ïâ‰ˆÏâ€² , Ï0â‰ˆÏâ€²0)
          with f Ïâ‰ˆÏâ€²
        ...  | rt
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             = record
                 { RelTyp rt
                 ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦TâŸ§
                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦Tâ€²âŸ§
                 }
             , record
                 { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ âŸ¦wkâŸ§ â†˜âŸ¦tâŸ§
                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _
                 ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                 }
          where open RelTyp rt


[âˆ˜]â€² : Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
       Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
       Î“â€³ âŠ¨ t âˆ¶ T â†’
       ---------------------------------------------
       Î“ âŠ¨ t [ Ïƒ âˆ˜ Ï„ ] â‰ˆ t [ Ïƒ ] [ Ï„ ] âˆ¶ T [ Ïƒ âˆ˜ Ï„ ]
[âˆ˜]â€² {_} {Ï„} {_} {Ïƒ} {_} {t} {T} (âŠ¨Î“ , âŠ¨Î“â€² , âŠ¨Ï„) (âŠ¨Î“â€²â‚ , âŠ¨Î“â€³ , âŠ¨Ïƒ) (âŠ¨Î“â€³â‚ , _ , âŠ¨t) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------
                 Î£ (RelTyp _ (T [ Ïƒ âˆ˜ Ï„ ]) Ï (T [ Ïƒ âˆ˜ Ï„ ]) Ïâ€²)
                 Î» rel â†’ RelExp (t [ Ïƒ âˆ˜ Ï„ ]) Ï (t [ Ïƒ ] [ Ï„ ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€² = record
                        { rt
                        ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§) rt.â†˜âŸ¦TâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§) rt.â†˜âŸ¦Tâ€²âŸ§
                        }
                    , record
                        { re
                        ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§) re.â†˜âŸ¦tâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ re.â†˜âŸ¦tâ€²âŸ§)
                        }
          where module Ï„ = RelSubsts (âŠ¨Ï„ Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubsts (âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ï„.Ïƒâ‰ˆÎ´))
                âŠ¨tÏ = âŠ¨t (âŠ¨-irrel âŠ¨Î“â€³ âŠ¨Î“â€³â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                rt = projâ‚ âŠ¨tÏ
                re = projâ‚‚ âŠ¨tÏ
                module rt = RelTyp rt
                module re = RelExp re


[,]-v-zeâ€² : âˆ€ {i} â†’
            Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
            Î” âŠ¨ S âˆ¶ Se i â†’
            Î“ âŠ¨ s âˆ¶ (S [ Ïƒ ]) â†’
            --------------------------------
            Î“ âŠ¨ v 0 [ Ïƒ , s ] â‰ˆ s âˆ¶ S [ Ïƒ ]
[,]-v-zeâ€² {_} {Ïƒ} {_} {S} {s} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , _ , âŠ¨S) (âŠ¨Î“â‚ , _ , âŠ¨s) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------
                 Î£ (RelTyp _ (S [ Ïƒ ]) Ï (S [ Ïƒ ]) Ïâ€²)
                 Î» rel â†’ RelExp (v 0 [ Ïƒ , s ]) Ï s Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp _ (S [ Ïƒ ]) Ï (S [ Ïƒ ]) Ïâ€²)
                       Î» rel â†’ RelExp (v 0 [ Ïƒ , s ]) Ï s Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                     | âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<j _ }
                     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                     , re
                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j
                           | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
                           | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² Ïƒ.â†˜âŸ¦Î´âŸ§
                           | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§ â†˜âŸ¦TâŸ§
                           | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦TâŸ§â€² = record
                                                    { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§
                                                    ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦TâŸ§â€²
                                                    ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                                                    }
                                                , record
                                                    { re
                                                    ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) (âŸ¦vâŸ§ 0)
                                                    }
                  where module re = RelExp re


[,]-v-suâ€² : âˆ€ {i x} â†’
            Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
            Î” âŠ¨ S âˆ¶ Se i â†’
            Î“ âŠ¨ s âˆ¶ S [ Ïƒ ] â†’
            x âˆ¶ T âˆˆ! Î” â†’
            ---------------------------------------------
            Î“ âŠ¨ v (suc x) [ Ïƒ , s ] â‰ˆ v x [ Ïƒ ] âˆ¶ T [ Ïƒ ]
[,]-v-suâ€² {_} {Ïƒ} {_} {S} {s} {T} {_} {x} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , _ , âŠ¨S) (âŠ¨Î“â‚ , _ , âŠ¨s) TâˆˆÎ” = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 --------------------------------------------------------------------------------
                 Î£ (RelTyp _ (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²)
                 Î» rel â†’ RelExp (v (suc x) [ Ïƒ , s ]) Ï (v x [ Ïƒ ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                module re = RelExp (projâ‚‚ (âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)))
                help : Î£ (RelTyp _ (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²)
                       Î» rel â†’ RelExp (v (suc x) [ Ïƒ , s ]) Ï (v x [ Ïƒ ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with projâ‚‚ (âŠ¨-lookup âŠ¨Î” TâˆˆÎ”) Ïƒ.Ïƒâ‰ˆÎ´
                ...  | rtâ€²
                     , record { â†˜âŸ¦tâŸ§ = âŸ¦vâŸ§ _ ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     = record
                         { rtâ€²
                         ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ rtâ€².â†˜âŸ¦TâŸ§
                         ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ rtâ€².â†˜âŸ¦Tâ€²âŸ§
                         }
                     , record
                         { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) (âŸ¦vâŸ§ _)
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ (âŸ¦vâŸ§ _)
                         ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                         }
                     where module rtâ€² = RelTyp rtâ€²


â‰ˆ-convâ€² : âˆ€ {i} â†’
          Î“ âŠ¨ s â‰ˆ t âˆ¶ S â†’
          Î“ âŠ¨ S â‰ˆ T âˆ¶ Se i â†’
          --------------------
          Î“ âŠ¨ s â‰ˆ t âˆ¶ T
â‰ˆ-convâ€² {_} {s} {t} {S} {T} (âŠ¨Î“ , _ , sâ‰ˆt) (âŠ¨Î“â‚ , _ , Sâ‰ˆT) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------------
                 Î£ (RelTyp _ T Ï T Ïâ€²)
                 Î» rel â†’ RelExp s Ï t Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€²
          with Sâ‰ˆT (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
             | Sâ‰ˆT (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
             | sâ‰ˆt Ïâ‰ˆÏâ€²
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<j _ }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦TâŸ§ ; tâ‰ˆtâ€² = âŸ¦Sâ‰ˆTâŸ§ }
             | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<jâ€² _ }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦SâŸ§â€² ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦TâŸ§â€² ; tâ‰ˆtâ€² = âŸ¦Sâ‰ˆTâŸ§â€² }
             | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â€³ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§â€³ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , re
            rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j
                  | ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<jâ€²
                  | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€² â†˜âŸ¦SâŸ§
                  | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€³ â†˜âŸ¦SâŸ§ = record
                                          { â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§â€²
                                          ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§
                                          ; Tâ‰ˆTâ€²  = ğ•Œ-trans (ğ•Œ-sym âŸ¦Sâ‰ˆTâŸ§â€²) âŸ¦Sâ‰ˆTâŸ§
                                          }
                                      , record
                                          { RelExp re
                                          ; tâ‰ˆtâ€²  = El-one-sidedâ€² âŸ¦Sâ‰ˆTâŸ§ (ğ•Œ-trans (ğ•Œ-sym âŸ¦Sâ‰ˆTâŸ§â€²) âŸ¦Sâ‰ˆTâŸ§) (El-one-sided Tâ‰ˆTâ€² âŸ¦Sâ‰ˆTâŸ§ (RelExp.tâ‰ˆtâ€² re))
                                          }


â‰ˆ-symâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
         ----------------
         Î“ âŠ¨ tâ€² â‰ˆ t âˆ¶ T
â‰ˆ-symâ€² {_} {t} {tâ€²} {T} (âŠ¨Î“ , _ , tâ‰ˆtâ€²) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------------------------------------
                 Î£ (RelTyp _ T Ï T Ïâ€²)
                 Î» rel â†’ RelExp tâ€² Ï t Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€²
          with rt , re â† tâ‰ˆtâ€² (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²) = record
                           { â†˜âŸ¦TâŸ§  = â†˜âŸ¦Tâ€²âŸ§
                           ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§
                           ; Tâ‰ˆTâ€²  = ğ•Œ-sym Tâ‰ˆTâ€²
                           }
                       , record
                           { â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâ€²âŸ§
                           ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâŸ§
                           ; tâ‰ˆtâ€²  = El-sym Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²) re.tâ‰ˆtâ€²
                           }
          where module rt = RelTyp rt
                module re = RelExp re
                open rt
                open re


â‰ˆ-transâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
           Î“ âŠ¨ tâ€² â‰ˆ tâ€³ âˆ¶ T â†’
           ------ ------------
           Î“ âŠ¨ t â‰ˆ tâ€³ âˆ¶ T
â‰ˆ-transâ€² {_} {t} {tâ€²} {T} {tâ€³} (âŠ¨Î“ , _ , tâ‰ˆtâ€²) (âŠ¨Î“â‚ , _ , tâ€²â‰ˆtâ€³) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------------------------------
                 Î£ (RelTyp _ T Ï T Ïâ€²)
                 Î» rel â†’ RelExp t Ï tâ€³ Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€²
          with tâ‰ˆtâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²)
             | tâ€²â‰ˆtâ€³ (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             | rt@record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€³âŸ§ ; tâ‰ˆtâ€² = tâ€²â‰ˆtâ€³ }
            rewrite âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§â‚ â†˜âŸ¦tâ€²âŸ§
                  | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â€² = rt
                                      , record
                                          { â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâŸ§
                                          ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€³âŸ§
                                          ; tâ‰ˆtâ€²  = El-transâ€² Tâ‰ˆTâ€²â‚ (El-one-sided Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ tâ‰ˆtâ€²) tâ€²â‰ˆtâ€³
                                          }
