{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

-- Semantic judgments for substitutions
module Mint.Completeness.Substitutions (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Data.Nat.Properties

open import Lib hiding (lookup)
open import Mint.Completeness.LogRel

open import Mint.Statics.Properties.Ops
open import Mint.Semantics.Properties.Domain fext
open import Mint.Semantics.Properties.Evaluation fext
open import Mint.Semantics.Properties.PER fext
open import Mint.Completeness.Contexts fext
open import Mint.Completeness.Terms fext
open import Mint.Completeness.Universe fext


I-â‰ˆâ€² : âŠ¨ Î“ â†’
       --------------
       Î“ âŠ¨s I â‰ˆ I âˆ¶ Î“
I-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------
                 RelSubsts I Ï I Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { â†˜âŸ¦ÏƒâŸ§ = âŸ¦IâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦IâŸ§
          ; Ïƒâ‰ˆÎ´  = Ïâ‰ˆÏâ€²
          }


wk-â‰ˆâ€² : âŠ¨ T âˆº Î“ â†’
        --------------------------
        T âˆº Î“ âŠ¨s wk â‰ˆ wk âˆ¶ Î“
wk-â‰ˆâ€² {T} âŠ¨TÎ“@(âˆº-cong âŠ¨Î“ _) = âŠ¨TÎ“ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨TÎ“ âŸ§Ï â†’
                 ------------------------------
                 RelSubsts wk Ï wk Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper (Ïâ‰ˆÏâ€² , _) = record
          { â†˜âŸ¦ÏƒâŸ§ = âŸ¦wkâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦wkâŸ§
          ; Ïƒâ‰ˆÎ´  = Ïâ‰ˆÏâ€²
          }


âˆ˜-congâ€² : Î“ âŠ¨s Ï„ â‰ˆ Ï„â€² âˆ¶ Î“â€² â†’
          Î“â€² âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î“â€³ â†’
          ----------------
          Î“ âŠ¨s Ïƒ âˆ˜ Ï„ â‰ˆ Ïƒâ€² âˆ˜ Ï„â€² âˆ¶ Î“â€³
âˆ˜-congâ€² {_} {Ï„} {Ï„â€²} {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î“â€² , Ï„â‰ˆÏ„â€²) (âŠ¨Î“â€²â‚ , âŠ¨Î“â€³ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , âŠ¨Î“â€³ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ------------------------------------------
                 RelSubsts (Ïƒ âˆ˜ Ï„) Ï (Ïƒâ€² âˆ˜ Ï„â€²) Ïâ€² âŸ¦ âŠ¨Î“â€³ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { Ïƒ
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§
          }
          where module Ï„ = RelSubsts (Ï„â‰ˆÏ„â€² Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubsts (Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ï„.Ïƒâ‰ˆÎ´))


,-congâ€² : âˆ€ {i} â†’
          Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
          Î” âŠ¨ T âˆ¶ Se i â†’
          Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T [ Ïƒ ] â†’
          -----------------------------
          Î“ âŠ¨s Ïƒ , t â‰ˆ Ïƒâ€² , tâ€² âˆ¶ T âˆº Î”
,-congâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {T} {t} {tâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) (âŠ¨Î”â‚ , i , âŠ¨T) (âŠ¨Î“â‚ , j , tâ‰ˆtâ€²) = âŠ¨Î“ , âˆº-cong âŠ¨Î” helper , helperâ€²
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î” âŸ§Ï â†’
                 -------------------
                 RelTyp _ T Ï T Ïâ€²
        helper = âˆº-cong-helper (âŠ¨Î”â‚ , i , âŠ¨T) âŠ¨Î”

        helperâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                  -------------------------------------------------------
                  RelSubsts (Ïƒ , t) Ï (Ïƒâ€² , tâ€²) Ïâ€² âŸ¦ âˆº-cong âŠ¨Î” helper âŸ§Ï
        helperâ€² {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏâ€²â‚ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²
             with Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
                | tâ‰ˆtâ€² Ïâ‰ˆÏâ€²â‚
        ...     | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ }
                | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦ÏƒâŸ§
                with Ïƒâ‰ˆÎ´â‚ â† substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î” âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) Ïƒâ‰ˆÎ´ = record
                                                  { â†˜âŸ¦ÏƒâŸ§ = âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§
                                                  ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                  ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´â‚ , tâ‰ˆtâ€²â‚
                                                  }
            where tâ‰ˆtâ€²â‚ : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïƒâ‰ˆÎ´â‚))
                  tâ‰ˆtâ€²â‚
                    with Ïƒâ‰ˆÎ´â‚‚ â† âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´â‚
                       with âŠ¨T Ïƒâ‰ˆÎ´â‚‚
                  ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U j<i _ }
                          , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
                          rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i
                          with â†˜âŸ¦tâŸ§â‚‚ â† subst (âŸ¦ T âŸ§_â†˜ âŸ¦tâŸ§â‚) (drop-â†¦ âŸ¦ÏƒâŸ§ âŸ¦tâŸ§) â†˜âŸ¦tâŸ§â‚
                             rewrite âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚‚ â†˜âŸ¦TâŸ§ = El-one-sided Tâ‰ˆTâ€² tâ‰ˆtâ€²â‚ tâ‰ˆtâ€²


ï¼›-congâ€² : âˆ€ {n} Î¨s â†’
           Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
           âŠ¨ Î¨s ++âº Î“ â†’
           len Î¨s â‰¡ n â†’
           --------------------------------------
           Î¨s ++âº Î“ âŠ¨s Ïƒ ï¼› n â‰ˆ Ïƒâ€² ï¼› n âˆ¶ [] âˆ·âº Î”
ï¼›-congâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {n} Î¨s (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) âŠ¨Î¨sÎ“ refl = âŠ¨Î¨sÎ“ , Îº-cong âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î¨sÎ“ âŸ§Ï â†’
                 -------------------------------------------------
                 RelSubsts (Ïƒ ï¼› n) Ï (Ïƒâ€² ï¼› n) Ïâ€² âŸ¦ Îº-cong âŠ¨Î” âŸ§Ï
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏâ€²âˆ¥n â† âŠ¨-irrel (âŠ¨-resp-âˆ¥ Î¨s Î¨s âŠ¨Î¨sÎ“ refl) âŠ¨Î“ (âŸ¦âŸ§Ï-resp-âˆ¥ Î¨s Î¨s âŠ¨Î¨sÎ“ refl Ïâ‰ˆÏâ€²) = record
                                             { â†˜âŸ¦ÏƒâŸ§ = âŸ¦ï¼›âŸ§ â†˜âŸ¦ÏƒâŸ§
                                             ; â†˜âŸ¦Î´âŸ§ = âŸ¦ï¼›âŸ§ â†˜âŸ¦Î´âŸ§
                                             ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´ , âŸ¦âŸ§Ï-resp-O âŠ¨Î¨sÎ“ Ïâ‰ˆÏâ€² (â‰¤-trans (sâ‰¤s (mâ‰¤m+n n _)) (â‰¤-reflexive (sym (length-++âº-tail Î¨s _))))
                                             }
          where open RelSubsts (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²âˆ¥n)


I-âˆ˜â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s I âˆ˜ Ïƒ â‰ˆ Ïƒ âˆ¶ Î”
I-âˆ˜â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------
                 RelSubsts (I âˆ˜ Ïƒ) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ â†˜âŸ¦ÏƒâŸ§ âŸ¦IâŸ§
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


âˆ˜-Iâ€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s Ïƒ âˆ˜ I â‰ˆ Ïƒ âˆ¶ Î”
âˆ˜-Iâ€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------------
                 RelSubsts (Ïƒ âˆ˜ I) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ âŸ¦IâŸ§ â†˜âŸ¦ÏƒâŸ§
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


âˆ˜-assocâ€² : âˆ€ {Î“â€´} â†’
           Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
           Î“â€³ âŠ¨s Ïƒâ€² âˆ¶ Î“â€² â†’
           Î“â€´ âŠ¨s Ïƒâ€³ âˆ¶ Î“â€³ â†’
           ---------------------------------------
           Î“â€´ âŠ¨s Ïƒ âˆ˜ Ïƒâ€² âˆ˜ Ïƒâ€³ â‰ˆ Ïƒ âˆ˜ (Ïƒâ€² âˆ˜ Ïƒâ€³) âˆ¶ Î“
âˆ˜-assocâ€² {_} {Ïƒ} {_} {_} {Ïƒâ€²} {Ïƒâ€³} (âŠ¨Î“â€² , âŠ¨Î“ , âŠ¨Ïƒ) (âŠ¨Î“â€³ , âŠ¨Î“â€²â‚ , âŠ¨Ïƒâ€²) (âŠ¨Î“â€´ , âŠ¨Î“â€³â‚ , âŠ¨Ïƒâ€³) = âŠ¨Î“â€´ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€´ âŸ§Ï â†’
                 -----------------------------------------------------
                 RelSubsts (Ïƒ âˆ˜ Ïƒâ€² âˆ˜ Ïƒâ€³) Ï (Ïƒ âˆ˜ (Ïƒâ€² âˆ˜ Ïƒâ€³)) Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
            { Ïƒ
            ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ïƒâ€³.â†˜âŸ¦ÏƒâŸ§ (âŸ¦âˆ˜âŸ§ Ïƒâ€².â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§)
            ; â†˜âŸ¦Î´âŸ§ = âŸ¦âˆ˜âŸ§ (âŸ¦âˆ˜âŸ§ Ïƒâ€³.â†˜âŸ¦Î´âŸ§ Ïƒâ€².â†˜âŸ¦Î´âŸ§) Ïƒ.â†˜âŸ¦Î´âŸ§
            }
          where module Ïƒâ€³ = RelSubsts (âŠ¨Ïƒâ€³ Ïâ‰ˆÏâ€²)
                module Ïƒâ€² = RelSubsts (âŠ¨Ïƒâ€² (âŠ¨-irrel âŠ¨Î“â€³â‚ âŠ¨Î“â€³ Ïƒâ€³.Ïƒâ‰ˆÎ´))
                module Ïƒ  = RelSubsts (âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€²â‚ âŠ¨Î“â€² Ïƒâ€².Ïƒâ‰ˆÎ´))


,-âˆ˜â€² : âˆ€ {i} â†’
       Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
       Î“â€³ âŠ¨ T âˆ¶ Se i â†’
       Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
       Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
       ---------------------------------------------
       Î“ âŠ¨s (Ïƒ , t) âˆ˜ Ï„ â‰ˆ (Ïƒ âˆ˜ Ï„) , t [ Ï„ ] âˆ¶ T âˆº Î“â€³
,-âˆ˜â€² {_} {Ïƒ} {_} {T} {t} {_} {Ï„} (âŠ¨Î“â€² , âŠ¨Î“â€³ , âŠ¨Ïƒ) (âŠ¨Î“â€³â‚ , i , âŠ¨T) (âŠ¨Î“â€²â‚ , j , âŠ¨t) (âŠ¨Î“ , âŠ¨Î“â€²â‚‚ , âŠ¨Ï„) = âŠ¨Î“ , âˆº-cong âŠ¨Î“â€³ helper , helperâ€³
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€³ âŸ§Ï â†’
                 -------------------
                 RelTyp _ T Ï T Ïâ€²
        helper = âˆº-cong-helper (âŠ¨Î“â€³â‚ , i , âŠ¨T) âŠ¨Î“â€³

        helperâ€² : âˆ€ {i} â†’
                  (Aâ‰ˆB : A â‰ˆ B âˆˆ ğ•Œ i) â†’
                  a â‰ˆ b âˆˆ El i Aâ‰ˆB â†’
                  (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€³ âŸ§Ï) â†’
                  âŸ¦ T âŸ§ Ï â†˜ A â†’
                  -----------------------------------------
                  a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïâ‰ˆÏâ€²))
        helperâ€² {i = i} Aâ‰ˆB aâ‰ˆb Ïâ‰ˆÏâ€² â†˜A
          with Ïâ‰ˆÏâ€²â‚ â† âŠ¨-irrel âŠ¨Î“â€³ âŠ¨Î“â€³â‚ Ïâ‰ˆÏâ€²
             with âŠ¨T Ïâ‰ˆÏâ€²â‚
        ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U j<i _ }
                , record { âŸ¦tâŸ§ = âŸ¦TâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²â‚ }
                rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i
                      | âŸ¦âŸ§-det â†˜A â†˜âŸ¦tâŸ§ = El-one-sided Aâ‰ˆB Tâ‰ˆTâ€²â‚ aâ‰ˆb

        helperâ€³ : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                  ------------------------------------------------------------------------
                  RelSubsts ((Ïƒ , t) âˆ˜ Ï„) Ï ((Ïƒ âˆ˜ Ï„) , t [ Ï„ ]) Ïâ€² âŸ¦ âˆº-cong âŠ¨Î“â€³ helper âŸ§Ï
        helperâ€³ {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ï„ Ïâ‰ˆÏâ€²
             with âŠ¨t (âŠ¨-irrel âŠ¨Î“â€²â‚‚ âŠ¨Î“â€²â‚ Ïƒâ‰ˆÎ´) | âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€²â‚‚ âŠ¨Î“â€² Ïƒâ‰ˆÎ´)
        ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â‚ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§â‚ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´â‚ }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦ÏƒâŸ§â‚
                with Ïƒâ‰ˆÎ´â‚‚ â† substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ _ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) Ïƒâ‰ˆÎ´â‚ = record
                                      { â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§â‚ â†˜âŸ¦tâŸ§)
                                      ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦Î´âŸ§â‚) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                                      ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´â‚‚ , tâ‰ˆtâ€²â‚
                                      }
          where tâ‰ˆtâ€²â‚ : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïƒâ‰ˆÎ´â‚‚))
                tâ‰ˆtâ€²â‚ = helperâ€² Tâ‰ˆTâ€² tâ‰ˆtâ€² Ïƒâ‰ˆÎ´â‚‚ (subst (âŸ¦ T âŸ§_â†˜ _) (sym (drop-â†¦ _ _)) â†˜âŸ¦TâŸ§)


ï¼›-âˆ˜â€² : âˆ€ {n} Î¨s â†’
       Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
       Î“ âŠ¨s Ï„ âˆ¶ Î¨s ++âº Î“â€² â†’
       len Î¨s â‰¡ n â†’
       ------------------------------
       Î“ âŠ¨s Ïƒ ï¼› n âˆ˜ Ï„ â‰ˆ (Ïƒ âˆ˜ Ï„ âˆ¥ n) ï¼› O Ï„ n âˆ¶ [] âˆ·âº Î“â€³
ï¼›-âˆ˜â€² {_} {Ïƒ} {_} {_} {Ï„} {n} Î¨s (âŠ¨Î“â€² , âŠ¨Î“â€³ , âŠ¨Ïƒ) (âŠ¨Î“ , âŠ¨Î¨sÎ“â€² , âŠ¨Ï„) refl = âŠ¨Î“ , Îº-cong âŠ¨Î“â€³ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------------------------------------------------
                 RelSubsts (Ïƒ ï¼› n âˆ˜ Ï„) Ï ((Ïƒ âˆ˜ Ï„ âˆ¥ n) ï¼› O Ï„ n) Ïâ€² âŸ¦ Îº-cong âŠ¨Î“â€³ âŸ§Ï
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = record
          { âŸ¦ÏƒâŸ§  = ext Ïƒ.âŸ¦ÏƒâŸ§ (O Ï„.âŸ¦ÏƒâŸ§ n)
          ; âŸ¦Î´âŸ§  = ext Ïƒ.âŸ¦Î´âŸ§ (O Ïâ€² (O Ï„ n))
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ (âŸ¦ï¼›âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§)
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦ï¼›âŸ§ (âŸ¦âˆ˜âŸ§ (âˆ¥-âŸ¦âŸ§s n Ï„.â†˜âŸ¦Î´âŸ§) Ïƒ.â†˜âŸ¦Î´âŸ§)
          ; Ïƒâ‰ˆÎ´  = Ïƒ.Ïƒâ‰ˆÎ´ , trans (âŸ¦âŸ§Ï-resp-O âŠ¨Î¨sÎ“â€² Ï„.Ïƒâ‰ˆÎ´ (length-<-++âº Î¨s)) (sym (O-âŸ¦âŸ§s n Ï„.â†˜âŸ¦Î´âŸ§))
          }
          where module Ï„ = RelSubsts (âŠ¨Ï„ Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubsts (âŠ¨Ïƒ (âŠ¨-irrel (âŠ¨-resp-âˆ¥ Î¨s Î¨s âŠ¨Î¨sÎ“â€² refl) âŠ¨Î“â€² (âŸ¦âŸ§Ï-resp-âˆ¥ Î¨s Î¨s âŠ¨Î¨sÎ“â€² refl Ï„.Ïƒâ‰ˆÎ´)))


p-,â€² : Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
       Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
       -------------------------
       Î“â€² âŠ¨s p (Ïƒ , t) â‰ˆ Ïƒ âˆ¶ Î“
p-,â€² {_} {Ïƒ} {_} {t} {T} (âŠ¨Î“â€² , âŠ¨Î“ , âŠ¨Ïƒ) (âŠ¨Î“â€²â‚ , _ , âŠ¨t) = âŠ¨Î“â€² , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€² âŸ§Ï â†’
                 -------------------------------------
                 RelSubsts (p (Ïƒ , t)) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : RelSubsts (p (Ïƒ , t)) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
                help
                  with âŠ¨t (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ïâ‰ˆÏâ€²)
                ... | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦Tâ€²âŸ§ }
                    , re
                    rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
                          | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² Ïƒ.â†˜âŸ¦Î´âŸ§ = record
                                                     { Ïƒ
                                                     ; âŸ¦ÏƒâŸ§  = drop (Ïƒ.âŸ¦ÏƒâŸ§ â†¦ re.âŸ¦tâŸ§)
                                                     ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) âŸ¦wkâŸ§
                                                     ; Ïƒâ‰ˆÎ´  = subst (_â‰ˆ Ïƒ.âŸ¦Î´âŸ§ âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) (sym (drop-â†¦ _ _)) Ïƒ.Ïƒâ‰ˆÎ´
                                                     }
                  where module re = RelExp re


,-extâ€² : Î“â€² âŠ¨s Ïƒ âˆ¶ T âˆº Î“ â†’
         ----------------------------------
         Î“â€² âŠ¨s Ïƒ â‰ˆ p Ïƒ , v 0 [ Ïƒ ] âˆ¶ T âˆº Î“
,-extâ€² {_} {Ïƒ} {T} (âŠ¨Î“â€² , âŠ¨TÎ“@(âˆº-cong _ _) , âŠ¨Ïƒ) = âŠ¨Î“â€² , âŠ¨TÎ“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€² âŸ§Ï â†’
                 ------------------------------------------------------
                 RelSubsts Ïƒ Ï (p Ïƒ , v 0 [ Ïƒ ]) Ïâ€² âŸ¦ âŠ¨TÎ“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; âŸ¦Î´âŸ§  = drop âŸ¦Î´âŸ§ â†¦ lookup âŸ¦Î´âŸ§ 0
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ â†˜âŸ¦Î´âŸ§ âŸ¦wkâŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦vâŸ§ 0))
          ; Ïƒâ‰ˆÎ´  = subst (âŸ¦ÏƒâŸ§ â‰ˆ_âˆˆ âŸ¦ âŠ¨TÎ“ âŸ§Ï) (sym (drop-same _)) Ïƒâ‰ˆÎ´
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)

ï¼›-extâ€² : Î“ âŠ¨s Ïƒ âˆ¶ [] âˆ·âº Î” â†’
         -----------------------------------
         Î“ âŠ¨s Ïƒ â‰ˆ (Ïƒ âˆ¥ 1) ï¼› O Ïƒ 1 âˆ¶ [] âˆ·âº Î”
ï¼›-extâ€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨ÎºÎ”@(Îº-cong _) , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨ÎºÎ” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------
                 RelSubsts Ïƒ Ï (Ïƒ âˆ¥ 1 ï¼› O Ïƒ 1) Ïâ€² âŸ¦ âŠ¨ÎºÎ” âŸ§Ï
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = record
          { RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; âŸ¦Î´âŸ§  = ext (âŸ¦Î´âŸ§ âˆ¥ 1) (O Ïâ€² (O Ïƒ 1))
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦ï¼›âŸ§ (âˆ¥-âŸ¦âŸ§s 1 â†˜âŸ¦Î´âŸ§)
          ; Ïƒâ‰ˆÎ´  = projâ‚ Ïƒâ‰ˆÎ´ , helper-eq
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                helper-eq : projâ‚ (âŸ¦ÏƒâŸ§ 0) â‰¡ O Ïâ€² (S-O Ïƒ 1)
                helper-eq = trans (projâ‚‚ Ïƒâ‰ˆÎ´) (trans (sym (+-identityÊ³ _)) (sym (O-âŸ¦âŸ§s 1 â†˜âŸ¦Î´âŸ§)))


s-â‰ˆ-symâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
           ------------------
           Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒ âˆ¶ Î”
s-â‰ˆ-symâ€² {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------
                 RelSubsts Ïƒâ€² Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Î´âŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦ÏƒâŸ§
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-sym âŠ¨Î” âŠ¨Î” Ïƒâ‰ˆÎ´
          }
          where open RelSubsts (Ïƒâ‰ˆÏƒâ€² (âŸ¦âŸ§Ï-sym âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²))


s-â‰ˆ-transâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
             Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒâ€³ âˆ¶ Î” â†’
             -------------------
             Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€³ âˆ¶ Î”
s-â‰ˆ-transâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {Ïƒâ€³} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) (âŠ¨Î“â€² , âŠ¨Î”â€² , Ïƒâ€²â‰ˆÏƒâ€³) = âŠ¨Î“ , âŠ¨Î”â€² , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------
                 RelSubsts Ïƒ Ï Ïƒâ€³ Ïâ€² âŸ¦ âŠ¨Î”â€² âŸ§Ï
        helper Ïâ‰ˆÏâ€²
          with Ïƒâ‰ˆÏƒâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²) | Ïƒâ€²â‰ˆÏƒâ€³ (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â€² Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§   ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÏƒâ€² }
             | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€² ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€³âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ€²â‰ˆÏƒâ€³ }
             rewrite âŸ¦âŸ§s-det â†˜âŸ¦Ïƒâ€²âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€² = record
          { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€³âŸ§
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-trans âŠ¨Î” âŠ¨Î”â€² âŠ¨Î”â€² Ïƒâ‰ˆÏƒâ€² Ïƒâ€²â‰ˆÏƒâ€³
          }


s-â‰ˆ-convâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
            âŠ¨ Î” â‰ˆ Î”â€² â†’
            ------------------
            Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î”â€²
s-â‰ˆ-convâ€² {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) Î”â‰ˆÎ”â€² = âŠ¨Î“ , âŠ¨Î”â€² , helper
  where âŠ¨Î”â€² = âŠ¨-refl (âŠ¨-sym Î”â‰ˆÎ”â€²)
        helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------
                 RelSubsts Ïƒ Ï Ïƒâ€² Ïâ€² âŸ¦ âŠ¨Î”â€² âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubsts (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²)
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-transport âŠ¨Î” âŠ¨Î”â€² Ïƒâ‰ˆÎ´ Î”â‰ˆÎ”â€²
          }
          where open RelSubsts (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²)
