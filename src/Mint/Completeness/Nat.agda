{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

-- Semantic judgments for Nat
module Mint.Completeness.Nat (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Data.Nat
open import Data.Nat.Properties

open import Lib
open import Mint.Completeness.LogRel

open import Mint.Semantics.Properties.Domain fext
open import Mint.Semantics.Properties.Evaluation fext
open import Mint.Semantics.Properties.PER fext
open import Mint.Semantics.Readback
open import Mint.Semantics.Realizability fext


N-â‰ˆâ€² : âˆ€ {i} â†’
       âŠ¨ Î“ â†’
       ----------------
       Î“ âŠ¨ N â‰ˆ N âˆ¶ Se i
N-â‰ˆâ€² {_} {i} âŠ¨Î“ = âŠ¨Î“ , suc i , Î» Ïâ‰ˆÏâ€² â†’ record
                             { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                             ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                             ; Tâ‰ˆTâ€²  = Uâ€² â‰¤-refl
                             }
                           , record
                             { â†˜âŸ¦tâŸ§  = âŸ¦NâŸ§
                             ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦NâŸ§
                             ; tâ‰ˆtâ€²  = PERDef.N
                             }

ze-â‰ˆâ€² : âŠ¨ Î“ â†’
        ----------------
        Î“ âŠ¨ ze â‰ˆ ze âˆ¶ N
ze-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , 0 , Î» Ïâ‰ˆÏâ€² â†’ record
                             { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                             ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                             ; Tâ‰ˆTâ€²  = N
                             }
                           , record
                             { â†˜âŸ¦tâŸ§  = âŸ¦zeâŸ§
                             ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦zeâŸ§
                             ; tâ‰ˆtâ€²  = ze
                             }

su-congâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ N â†’
           ----------------
           Î“ âŠ¨ su t â‰ˆ su tâ€² âˆ¶ N
su-congâ€² {_} {t} {tâ€²} (âŠ¨Î“ , n , tâ‰ˆtâ€²) = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ------------------------------------------------------------
             Î£ (RelTyp n N Ï N Ïâ€²)
             Î» rel â†’ RelExp (su t) Ï (su tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = N }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                        ; Tâ‰ˆTâ€²  = N
                        }
                      , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦suâŸ§ â†˜âŸ¦tâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦suâŸ§ â†˜âŸ¦tâ€²âŸ§
                        ; tâ‰ˆtâ€²  = su tâ‰ˆtâ€²
                        }


-- A lemma to handle asymmetry appears in several Nat judgements.
-- This follows the trick of []-congâ€² in Mint.Completeness.Terms.
--
-- An example of asymmetry is in the return type of rec-congâ€²:
--
--   Î“ âŠ¨ rec T s r t â‰ˆ rec Tâ€² sâ€² râ€² tâ€² âˆ¶ T [| t ]
--
-- Here, the RHS says that rec Tâ€² sâ€² râ€² tâ€² is of T [| t ], and thus
-- has different terms (tâ€² and t) unlike the LHS.
RelExp-refl : âˆ€ {n} (âŠ¨Î“ : âŠ¨ Î“) â†’
              ({Ï Ïâ€² : Envs} â†’ (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’ Î£ (RelTyp n T Ï Tâ€² Ïâ€²) (Î» rel â†’ RelExp t Ï tâ€² Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel)))) â†’
              ({Ï Ïâ€² : Envs} â†’ (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’ Î£ (RelTyp n T Ï T Ïâ€²) (Î» rel â†’ RelExp t Ï t Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))))
RelExp-refl âŠ¨Î“ TTâ€² Ïâ‰ˆÏâ€²
  with TTâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²)
     | TTâ€² Ïâ‰ˆÏâ€²
     | TTâ€² (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
     | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ }
     | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚‚ }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚‚ }
    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â‚
          | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚‚
          | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§ â†˜âŸ¦tâŸ§â‚
          | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§â‚‚ = record
                                { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚
                                ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§â‚‚
                                ; Tâ‰ˆTâ€² = ğ•Œ-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)
                                }
                              , record
                                { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚
                                ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâŸ§â‚‚
                                ; tâ‰ˆtâ€² = El-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) (ğ•Œ-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)) tâ‰ˆtâ€² (El-sym Tâ‰ˆTâ€²â‚‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) tâ‰ˆtâ€²â‚‚)
                                }

rec-helper : âˆ€ {i}
             (âŠ¨Î“ : âŠ¨ Î“)
             (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
             (TTâ€² : (N âˆº Î“) âŠ¨ T â‰ˆ Tâ€² âˆ¶ Se i) â†’
             (ssâ€² : Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶ (T [| ze ])) â†’
             (rrâ€² : (T âˆº N âˆº Î“) âŠ¨ r â‰ˆ râ€² âˆ¶ (T [ (wk âˆ˜ wk) , su (v 1) ])) â†’
             a â‰ˆ b âˆˆ Nat â†’
             -----------------------------------------------------
             let (_   , nâ‚ , _   ) = TTâ€²
                 (âŠ¨Î“â‚‚ , nâ‚‚ , sâ‰ˆsâ€²) = ssâ€²
                 (_   , nâ‚ƒ , _   ) = rrâ€²
                 re = projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²))
             in Î£ (RelTyp (nâ‚ âŠ” nâ‚‚ âŠ” nâ‚ƒ) T (Ï â†¦ a) T (Ïâ€² â†¦ b))
                Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T , (RelExp.âŸ¦tâŸ§ re) , r , Ï , a â†˜ aâ€²
                                   Ã— recâˆ™ Tâ€² , (RelExp.âŸ¦tâ€²âŸ§ re) , râ€² , Ïâ€² , b â†˜ bâ€²
                                   Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
rec-helper {_} {Ï} {Ïâ€²} {T} {Tâ€²} {s} {sâ€²} {r} {râ€²} {i = i} âŠ¨Î“ Ïâ‰ˆÏâ€² (âˆº-cong âŠ¨Î“â‚ Nrelâ‚ , nâ‚ , Trelâ‚) (âŠ¨Î“â‚‚ , nâ‚‚ , sâ‰ˆsâ€²) (âˆº-cong (âˆº-cong âŠ¨Î“â‚ƒ Nrelâ‚ƒ) Trelâ‚ƒ , nâ‚ƒ , râ‰ˆrâ€²) aâ‰ˆb
  with Ïâ‰ˆÏâ€²â‚‚ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€² = helper aâ‰ˆb
  where
    helper : a â‰ˆ b âˆˆ Nat â†’
             ----------------------------------------------------------------
             let module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))
             in Î£ (RelTyp _ T (Ï â†¦ a) T (Ïâ€² â†¦ b))
                Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T , re.âŸ¦tâŸ§ , r , Ï , a â†˜ aâ€²
                                     Ã— recâˆ™ Tâ€² , re.âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , b â†˜ bâ€²
                                     Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper ze
      with sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚
    ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
         , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² } = record
                 { â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§â‚
                 ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚
                 ; Tâ‰ˆTâ€² = ğ•Œ-cumu (â‰¤-trans (mâ‰¤nâŠ”m _ _) (mâ‰¤mâŠ”n _ nâ‚ƒ)) Tâ‰ˆTâ€²â‚
                 }
               , âŸ¦sâŸ§ , âŸ¦sâ€²âŸ§ , zeâ†˜ , zeâ†˜ , El-cumu (â‰¤-trans (mâ‰¤nâŠ”m _ _) (mâ‰¤mâŠ”n _ nâ‚ƒ)) Tâ‰ˆTâ€²â‚ sâ‰ˆsâ€²
    helper {su a} {su b} (su aâ‰ˆb)
      with helper aâ‰ˆb
    ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
         , aâ€² , bâ€² , â†˜aâ€² , â†˜bâ€² , aâ€²â‰ˆbâ€² = helper-su
      where
        Ïâ‰ˆÏâ€²â‚ƒ : drop (drop (Ï â†¦ a â†¦ aâ€²)) â‰ˆ drop (drop (Ïâ€² â†¦ b â†¦ bâ€²)) âˆˆ âŸ¦ âŠ¨Î“â‚ƒ âŸ§Ï
        Ïâ‰ˆÏâ€²â‚ƒ
          rewrite drop-â†¦ (Ï â†¦ a) aâ€²
                | drop-â†¦ (Ïâ€² â†¦ b) bâ€²
                | drop-â†¦ Ï a
                | drop-â†¦ Ïâ€² b = âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ƒ Ïâ‰ˆÏâ€²

        aâ‰ˆbâ‚ƒ : a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ))
        aâ‰ˆbâ‚ƒ
          with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ = aâ‰ˆb

        aâ€²â‰ˆbâ€²â‚ƒ : aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Trelâ‚ƒ (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)))
        aâ€²â‰ˆbâ€²â‚ƒ
          with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ƒ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ƒ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ƒ } â† Trelâ‚ƒ (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)
            rewrite drop-â†¦ (Ï â†¦ a) aâ€²
                  | drop-â†¦ (Ïâ€² â†¦ b) bâ€²
                  | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â‚ƒ
                  | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚ƒ = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ƒ aâ€²â‰ˆbâ€²

        module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))

        helper-su : Î£ (RelTyp _ T (Ï â†¦ su a) T (Ïâ€² â†¦ su b))
                    Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T , re.âŸ¦tâŸ§ , r , Ï , su a â†˜ aâ€²
                                         Ã— recâˆ™ Tâ€² , re.âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , su b â†˜ bâ€²
                                         Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper-su
          with râ‰ˆrâ€² ((Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ) , aâ€²â‰ˆbâ€²â‚ƒ)
        ... | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
            , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                rewrite drop-â†¦ (Ï â†¦ a) aâ€²
                      | drop-â†¦ (Ïâ€² â†¦ b) bâ€²
                      | drop-â†¦ Ï a
                      | drop-â†¦ Ïâ€² b = record
                            { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                            ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                            ; Tâ‰ˆTâ€² = ğ•Œ-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€²
                            }
                          , _ , _ , suâ†˜ â†˜aâ€² â†˜âŸ¦râŸ§ , suâ†˜ â†˜bâ€² â†˜âŸ¦râ€²âŸ§ , El-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€² râ‰ˆrâ€²
    helper (ne {c} {câ€²} câ‰ˆcâ€²) = helper-ne
      where
        Ïâ‰ˆÏâ€²â‚ : {a b : D} (Îº : UMoT) â†’ drop (Ï [ Îº ] â†¦ a) â‰ˆ drop (Ïâ€² [ Îº ] â†¦ b) âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï
        Ïâ‰ˆÏâ€²â‚ {a} {b} Îº
          rewrite drop-â†¦ (Ï [ Îº ]) a
                | drop-â†¦ (Ïâ€² [ Îº ]) b = âŸ¦âŸ§Ï-mon âŠ¨Î“â‚ Îº (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)

        Ïâ‰ˆÏâ€²â‚â€² : drop (Ï â†¦ â†‘ N c) â‰ˆ drop (Ïâ€² â†¦ â†‘ N câ€²) âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï
        Ïâ‰ˆÏâ€²â‚â€²
          rewrite sym (Ï-ap-vone Ï)
                | sym (Ï-ap-vone Ïâ€²) = Ïâ‰ˆÏâ€²â‚ vone

        aâ‰ˆbâ‚ : {a b : D} (Îº : UMoT) â†’ a â‰ˆ b âˆˆ Nat â†’ a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ (Ïâ‰ˆÏâ€²â‚ {a} {b} Îº)))
        aâ‰ˆbâ‚ {a} {b} Îº aâ‰ˆb
          with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚ (Ïâ‰ˆÏâ€²â‚ {a} {b} Îº) = aâ‰ˆb

        aâ‰ˆbâ‚â€² : â†‘ N c â‰ˆ â†‘ N câ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ Ïâ‰ˆÏâ€²â‚â€²))
        aâ‰ˆbâ‚â€²
          with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚ Ïâ‰ˆÏâ€²â‚â€² = ne câ‰ˆcâ€²

        helper-ne : let module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))
                    in Î£ (RelTyp _ T (Ï â†¦ â†‘ N c) T (Ïâ€² â†¦ â†‘ N câ€²))
                       Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T , re.âŸ¦tâŸ§ , r , Ï , â†‘ N c â†˜ aâ€²
                                            Ã— recâˆ™ Tâ€² , re.âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , â†‘ N câ€² â†˜ bâ€²
                                            Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper-ne
          with RelExp-refl (âˆº-cong âŠ¨Î“â‚ Nrelâ‚) Trelâ‚ (Ïâ‰ˆÏâ€²â‚â€² , aâ‰ˆbâ‚â€²)
             | Trelâ‚ (Ïâ‰ˆÏâ€²â‚â€² , aâ‰ˆbâ‚â€²)
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚ _ }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€² }
             | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚â‚ _ }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²â‚ }
            with Tâ‰ˆTâ€² â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚) Tâ‰ˆTâ€²)
               | Tâ‰ˆTâ€²â‚ â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚â‚) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚â‚) Tâ‰ˆTâ€²â‚)
              with refl â† âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§ = record
                          { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                          ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                          ; Tâ‰ˆTâ€² = ğ•Œ-cumu (â‰¤-trans (mâ‰¤mâŠ”n _ _) (mâ‰¤mâŠ”n _ nâ‚ƒ)) Tâ‰ˆTâ€²
                          }
                        , _ , _ , recâˆ™ â†˜âŸ¦TâŸ§â‚ , recâˆ™ â†˜âŸ¦Tâ€²âŸ§â‚ , El-cumu (â‰¤-trans (mâ‰¤mâŠ”n nâ‚ nâ‚‚) (mâ‰¤mâŠ”n _ nâ‚ƒ)) Tâ‰ˆTâ€² (El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² (realizability-Re Tâ‰ˆTâ€²â‚ bot-helper))
          where
            bot-helper : rec T (RelExp.âŸ¦tâŸ§ (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))) r Ï c â‰ˆ rec Tâ€² (RelExp.âŸ¦tâ€²âŸ§ (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))) râ€² Ïâ€² câ€² âˆˆ Bot
            bot-helper ns Îº
              with câ‰ˆcâ€² ns Îº
                 | Trelâ‚ (Ïâ‰ˆÏâ€²â‚ Îº , (aâ‰ˆbâ‚ Îº (ne (Bot-l (head ns)))))
                 | sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚
                 | Trelâ‚ (Ïâ‰ˆÏâ€²â‚ Îº , (aâ‰ˆbâ‚ Îº ze))
            ...  | cc , câ†˜ , câ€²â†˜
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚ns _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§ns ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ns ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ns ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ns ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²ns }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ze ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§ze ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²ze }
                 , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚ze _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§zeâ‚ ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§zeâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§zeâ‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§zeâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²zeâ‚ }
                with Tâ‰ˆTâ€²ns â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚ns) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚ns) Tâ‰ˆTâ€²ns)
                   | Tâ‰ˆTâ€²zeâ‚ â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚ze) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚ze) Tâ‰ˆTâ€²zeâ‚) = bot-helperâ€²
              where
                Ïâ‰ˆÏâ€²â‚ƒ : drop (drop (Ï [ Îº ] â†¦ lâ€² N (head ns) â†¦ lâ€² âŸ¦TâŸ§ns (suc (head ns)))) â‰ˆ drop (drop (Ïâ€² [ Îº ] â†¦ lâ€² N (head ns) â†¦ lâ€² âŸ¦Tâ€²âŸ§ns (suc (head ns)))) âˆˆ âŸ¦ âŠ¨Î“â‚ƒ âŸ§Ï
                Ïâ‰ˆÏâ€²â‚ƒ
                  rewrite drop-â†¦ (Ï [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                        | drop-â†¦ (Ïâ€² [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦Tâ€²âŸ§ns (suc (head ns)))
                        | drop-â†¦ (Ï [ Îº ]) (lâ€² N (head ns))
                        | drop-â†¦ (Ïâ€² [ Îº ]) (lâ€² N (head ns)) = âŸ¦âŸ§Ï-mon âŠ¨Î“â‚ƒ Îº (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ƒ Ïâ‰ˆÏâ€²)

                aâ‰ˆbâ‚ƒ : lâ€² N (head ns) âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ))
                aâ‰ˆbâ‚ƒ
                  with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ = ne (Bot-l (head ns))

                aâ€²â‰ˆbâ€²â‚ƒ : lâ€² âŸ¦TâŸ§ns (suc (head ns)) â‰ˆ lâ€² âŸ¦Tâ€²âŸ§ns (suc (head ns)) âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Trelâ‚ƒ (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)))
                aâ€²â‰ˆbâ€²â‚ƒ
                  with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ƒ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ƒ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ƒ } â† Trelâ‚ƒ (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)
                    rewrite drop-â†¦ (Ï [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                          | drop-â†¦ (Ïâ€² [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦Tâ€²âŸ§ns (suc (head ns)))
                          | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ns â†˜âŸ¦TâŸ§â‚ƒ = El-one-sided Tâ‰ˆTâ€²ns Tâ‰ˆTâ€²â‚ƒ (realizability-Re Tâ‰ˆTâ€²ns (Bot-l (suc (head ns))))

                bot-helperâ€² : âˆƒ Î» u â†’ Re ns - rec T âŸ¦sâŸ§ r Ï c [ Îº ] â†˜ u
                                    Ã— Re ns - rec Tâ€² âŸ¦sâ€²âŸ§ râ€² Ïâ€² câ€² [ Îº ] â†˜ u
                bot-helperâ€²
                  with râ‰ˆrâ€² ((Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ) , aâ€²â‰ˆbâ€²â‚ƒ)
                     | Trelâ‚ (Ïâ‰ˆÏâ€²â‚ Îº , (aâ‰ˆbâ‚ Îº (su (ne (Bot-l (head ns))))))
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§su ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§su ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²su }
                     , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚su _ }
                     , record { âŸ¦tâŸ§ = âŸ¦TâŸ§suâ‚ ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§suâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§suâ‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§suâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²suâ‚ }
                    with Tâ‰ˆTâ€²suâ‚ â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚su) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚su) Tâ‰ˆTâ€²suâ‚)
                      rewrite drop-â†¦ (Ï [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                            | drop-â†¦ (Ïâ€² [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦Tâ€²âŸ§ns (suc (head ns)))
                            | drop-â†¦ (Ï [ Îº ]) (lâ€² N (head ns))
                            | drop-â†¦ (Ïâ€² [ Îº ]) (lâ€² N (head ns))
                            | sym (â†¦-mon Ï ze Îº)
                            | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§zeâ‚ (âŸ¦âŸ§-mon Îº â†˜âŸ¦TâŸ§ze)
                            | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§su â†˜âŸ¦TâŸ§suâ‚
                        with realizability-Rty Tâ‰ˆTâ€²ns (inc ns) vone
                           | realizability-Rf Tâ‰ˆTâ€²zeâ‚ (El-one-sided (ğ•Œ-mon Îº Tâ‰ˆTâ€²ze) Tâ‰ˆTâ€²zeâ‚ (El-mon Tâ‰ˆTâ€²ze Îº (ğ•Œ-mon Îº Tâ‰ˆTâ€²ze) sâ‰ˆsâ€²)) ns vone
                           | realizability-Rf Tâ‰ˆTâ€²suâ‚ (El-one-sided Tâ‰ˆTâ€²su Tâ‰ˆTâ€²suâ‚ râ‰ˆrâ€²) (inc (inc ns)) vone
                ...        | _ , Tnsâ†˜ , Tâ€²nsâ†˜
                           | _ , Tzeâ†˜ , Tâ€²zeâ†˜
                           | _ , Tsuâ†˜ , Tâ€²suâ†˜
                          rewrite D-ap-vone âŸ¦TâŸ§ns
                                | D-ap-vone âŸ¦Tâ€²âŸ§ns
                                | âŸ¦âŸ§-det (âŸ¦âŸ§-mon Îº â†˜âŸ¦TâŸ§ze) â†˜âŸ¦TâŸ§zeâ‚
                                | â†¦-mon Ï ze Îº
                                | D-ap-vone âŸ¦TâŸ§zeâ‚
                                | D-ap-vone âŸ¦Tâ€²âŸ§zeâ‚
                                | D-ap-vone (âŸ¦sâŸ§ [ Îº ])
                                | D-ap-vone (âŸ¦sâ€²âŸ§ [ Îº ])
                                | D-ap-vone âŸ¦TâŸ§suâ‚
                                | D-ap-vone âŸ¦Tâ€²âŸ§suâ‚
                                | D-ap-vone âŸ¦râŸ§
                                | D-ap-vone âŸ¦râ€²âŸ§ = rec _ _ _ cc , Rr ns â†˜âŸ¦TâŸ§ns Tnsâ†˜ â†˜âŸ¦TâŸ§zeâ‚ Tzeâ†˜ â†˜âŸ¦râŸ§ â†˜âŸ¦TâŸ§suâ‚ Tsuâ†˜ câ†˜ , Rr ns â†˜âŸ¦Tâ€²âŸ§ns Tâ€²nsâ†˜ â†˜âŸ¦Tâ€²âŸ§zeâ‚ Tâ€²zeâ†˜ â†˜âŸ¦râ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§suâ‚ Tâ€²suâ†˜ câ€²â†˜

rec-congâ€² : âˆ€ {i} â†’
            N âˆº Î“ âŠ¨ T â‰ˆ Tâ€² âˆ¶ Se i â†’
            Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶ T [| ze ] â†’
            T âˆº N âˆº Î“ âŠ¨ r â‰ˆ râ€² âˆ¶ T [ (wk âˆ˜ wk) , su (v 1) ] â†’
            Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ N â†’
            ---------------------------------------------------
            Î“ âŠ¨ rec T s r t â‰ˆ rec Tâ€² sâ€² râ€² tâ€² âˆ¶ T [| t ]
rec-congâ€² {_} {T} {Tâ€²} {s} {sâ€²} {r} {râ€²} {t} {tâ€²} TTâ€²@(_ , _ , _) ssâ€²@(âŠ¨Î“â‚‚ , _ , sâ‰ˆsâ€²) rrâ€²@(_ , _ , _) ttâ€²@(âŠ¨Î“â‚„ , _ , tâ‰ˆtâ€²) = âŠ¨Î“â‚„ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚„ âŸ§Ï â†’
             -----------------------------------------------------------------------------
             Î£ (RelTyp _ (T [| t ]) Ï (T [| t ]) Ïâ€²)
             Î» rel â†’ RelExp (rec T s r t) Ï (rec Tâ€² sâ€² râ€² tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with RelExp-refl âŠ¨Î“â‚„ tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
         | tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = N }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
         | record { Tâ‰ˆTâ€² = N }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
       with rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² TTâ€² ssâ€² rrâ€² tâ‰ˆtâ€²
          | rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² TTâ€² ssâ€² rrâ€² tâ‰ˆtâ€²â‚
    ...   | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
          , res , resâ€² , â†˜res , â†˜resâ€² , resâ‰ˆresâ€²
          | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
          , resâ‚ , resâ€²â‚ , â†˜resâ‚ , â†˜resâ€²â‚ , resâ‰ˆresâ€²â‚
        rewrite âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦tâŸ§
              | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§ = record
                                  { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§) â†˜âŸ¦TâŸ§
                                  ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâ€²âŸ§) â†˜âŸ¦Tâ€²âŸ§
                                  ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                  }
                                , record
                                  { â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâŸ§ â†˜âŸ¦tâŸ§ â†˜resâ‚
                                  ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§â‚ â†˜resâ€²â‚
                                  ; tâ‰ˆtâ€² = El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² resâ‰ˆresâ€²â‚
                                  }
      where
        module sâ‰ˆsâ€² = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î“â‚„ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²)))

rec-Î²-zeâ€²   : âˆ€ {i} â†’
              N âˆº Î“ âŠ¨ T âˆ¶ Se i â†’
              Î“ âŠ¨ s âˆ¶ T [| ze ] â†’
              T âˆº N âˆº Î“ âŠ¨ r âˆ¶ T [ (wk âˆ˜ wk) , su (v 1) ] â†’
              ---------------------------------------------
              Î“ âŠ¨ rec T s r ze â‰ˆ s âˆ¶ T [| ze ]
rec-Î²-zeâ€² {_} {T} {s} {r} âŠ¨T âŠ¨s@(âŠ¨Î“ , _ , sâ‰ˆsâ€²) âŠ¨r = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             -------------------------------------------------------------
             Î£ (RelTyp _ (T [| ze ]) Ï (T [| ze ]) Ïâ€²)
             Î» rel â†’ RelExp (rec T s r ze) Ï s Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with Trel , srel â† sâ‰ˆsâ€² Ïâ‰ˆÏâ€² = Trel
                                   , record
                                     { RelExp srel
                                     ; â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ (RelExp.â†˜âŸ¦tâŸ§ srel) âŸ¦zeâŸ§ zeâ†˜
                                     }

rec-Î²-suâ€² : âˆ€ {i} â†’
            N âˆº Î“ âŠ¨ T âˆ¶ Se i â†’
            Î“ âŠ¨ s âˆ¶ T [| ze ] â†’
            T âˆº N âˆº Î“ âŠ¨ r âˆ¶ T [ (wk âˆ˜ wk) , su (v 1) ] â†’
            Î“ âŠ¨ t âˆ¶ N â†’
            -----------------------------------------------------------------
            Î“ âŠ¨ rec T s r (su t) â‰ˆ r [ (I , t) , rec T s r t ] âˆ¶ T [| su t ]
rec-Î²-suâ€² {_} {T} {s} {r} {t} âŠ¨T@(_ , _ , _) âŠ¨s@(âŠ¨Î“â‚‚ , _ , sâ‰ˆsâ€²) âŠ¨r@(_ , _ , _) (âŠ¨Î“â‚„ , _ , tâ‰ˆtâ€²) = âŠ¨Î“â‚„ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚„ âŸ§Ï â†’
             -----------------------------------------------------------------------------------------------
             Î£ (RelTyp _ (T [| su t ]) Ï (T [| su t ]) Ïâ€²)
             Î» rel â†’ RelExp (rec T s r (su t)) Ï (r [ (I , t) , rec T s r t ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = N }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
        with rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² âŠ¨T âŠ¨s âŠ¨r (su tâ‰ˆtâ€²)
    ...    | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
           , res , resâ€² , â†˜res , suâ†˜ â†˜resâ€² â†˜r , resâ‰ˆresâ€² = record
                                              { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâŸ§)) â†˜âŸ¦TâŸ§
                                              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                              ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                              }
                                            , record
                                              { â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâŸ§) â†˜res
                                              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâ€²âŸ§) (âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ â†˜resâ€²)) â†˜r
                                              ; tâ‰ˆtâ€² = resâ‰ˆresâ€²
                                              }
      where
        module sâ‰ˆsâ€² = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î“â‚„ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²)))


N-[]â€² : âˆ€ i â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        -----------------------
        Î“ âŠ¨ N [ Ïƒ ] â‰ˆ N âˆ¶ Se i
N-[]â€² {_} {Ïƒ} i (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 --------------------------------------------------
                 Î£ (RelTyp _ (Se i) Ï (Se i) Ïâ€²)
                 Î» rel â†’ RelExp (N [ Ïƒ ]) Ï N Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€² = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                        ; Tâ‰ˆTâ€²  = Uâ€² â‰¤-refl
                        }
                    , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ âŸ¦NâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦NâŸ§
                        ; tâ‰ˆtâ€²  = PERDef.N
                        }
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


ze-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
         ----------------------
         Î“ âŠ¨ ze [ Ïƒ ] â‰ˆ ze âˆ¶ N
ze-[]â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ------------------------------------------------------------
                 Î£ (RelTyp 0 N Ï N Ïâ€²)
                 Î» rel â†’ RelExp (ze [ Ïƒ ]) Ï ze Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€² = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                        ; Tâ‰ˆTâ€²  = N
                        }
                    , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ âŸ¦zeâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦zeâŸ§
                        ; tâ‰ˆtâ€²  = ze
                        }
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


su-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
         Î” âŠ¨ t âˆ¶ N â†’
         ----------------------------------
         Î“ âŠ¨ su t [ Ïƒ ] â‰ˆ su (t [ Ïƒ ]) âˆ¶ N
su-[]â€² {_} {Ïƒ} {_} {t} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , _ , âŠ¨t) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------------------------------------
                 Î£ (RelTyp 0 N Ï N Ïâ€²)
                 Î» rel â†’ RelExp (su t [ Ïƒ ]) Ï (su (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp _ N Ï N Ïâ€²)
                       Î» rel â†’ RelExp (su t [ Ïƒ ]) Ï (su (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with âŠ¨t (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦NâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§ ; Tâ‰ˆTâ€² = N }
                     , re = record
                              { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                              ; Tâ‰ˆTâ€²  = N
                              }
                          , record
                              { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦suâŸ§ re.â†˜âŸ¦tâŸ§)
                              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦suâŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ re.â†˜âŸ¦tâ€²âŸ§)
                              ; tâ‰ˆtâ€²  = su re.tâ‰ˆtâ€²
                              }
                  where module re = RelExp re

-- We need one more separate helper for rec-[]â€² other than rec-helper,
-- because rec-helper does not allow us to use two inequivalent environments:
-- Ï and (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏ).âŸ¦ÏƒâŸ§
rec-[]â€²-helper : âˆ€ {res i} â†’
                 (âŠ¨Î“ : âŠ¨ Î“) â†’
                 (âŠ¨Ïƒ : Î“ âŠ¨s Ïƒ âˆ¶ Î”) â†’
                 (Ïâ‰ˆÏ : Ï âˆˆâ€² âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
                 (âŠ¨T : (N âˆº Î”) âŠ¨ T âˆ¶ Se i) â†’
                 (âŠ¨s : Î” âŠ¨ s âˆ¶ T [| ze ]) â†’
                 (âŠ¨r : T âˆº N âˆº Î” âŠ¨ r âˆ¶ T [ (wk âˆ˜ wk) , su (v 1) ]) â†’
                 a âˆˆâ€² Nat â†’
                 let (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Ïƒ
                     rs = Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
                     (_   , nâ‚‚  , _)    = âŠ¨T
                     (âŠ¨Î”â‚ƒ , nâ‚ƒ  , sâ‰ˆsâ€²) = âŠ¨s
                     (_   , nâ‚„  , _)    = âŠ¨r
                     re = projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ (RelSubsts.Ïƒâ‰ˆÎ´ rs))) in
                 recâˆ™ T , (RelExp.âŸ¦tâŸ§ re) , r , (RelSubsts.âŸ¦ÏƒâŸ§ rs) , a â†˜ res â†’
                 -----------------------------------------------------------------------------------------
                 âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Ïƒ ]) , RelExp.âŸ¦tâŸ§ re , (r [ q (q Ïƒ) ]) , Ï , a â†˜ resâ€²
                          Ã— Î£ (RelTyp (nâ‚‚ âŠ” nâ‚ƒ âŠ” nâ‚„) T (RelSubsts.âŸ¦ÏƒâŸ§ rs â†¦ a) T (RelSubsts.âŸ¦ÏƒâŸ§ rs â†¦ a))
                            Î» rel â†’ res â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel)
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {ze} âŠ¨Î“ (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ (âˆº-cong âŠ¨Î”â‚‚ Nrelâ‚‚ , _ , _) (âŠ¨Î”â‚ƒ , _ , sâ‰ˆsâ€²) âŠ¨r@(_ , nâ‚„ , _) ze zeâ†˜
  with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
    rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§
      with sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)
...      | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
         , record { tâ‰ˆtâ€² = tâ‰ˆtâ€² } = _ , zeâ†˜
                                  , record
                                   { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                                   ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                   ; Tâ‰ˆTâ€² = ğ•Œ-cumu (â‰¤-trans (mâ‰¤nâŠ”m _ _) (mâ‰¤mâŠ”n _ nâ‚„)) Tâ‰ˆTâ€²
                                   }
                                 , El-cumu (â‰¤-trans (mâ‰¤nâŠ”m _ _) (mâ‰¤mâŠ”n _ nâ‚„)) Tâ‰ˆTâ€² (El-refl Tâ‰ˆTâ€² tâ‰ˆtâ€²)
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {su a} {res} âŠ¨Î“ âŠ¨Ïƒ@(âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ âŠ¨T@(_ , nâ‚‚ , _) âŠ¨s@(âŠ¨Î”â‚ƒ , nâ‚ƒ , sâ‰ˆsâ€²) âŠ¨r@(âˆº-cong (âˆº-cong âŠ¨Î”â‚„ Nrelâ‚„) Trelâ‚„ , nâ‚„ , râ‰ˆrâ€²) (su aâ‰ˆa) (suâ†˜ {bâ€² = b} â†˜res â†˜r)
  with rec-[]â€²-helper âŠ¨Î“ âŠ¨Ïƒ Ïâ‰ˆÏ âŠ¨T âŠ¨s âŠ¨r aâ‰ˆa â†˜res
...  | bâ€² , â†˜bâ€² , record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } , bâ‰ˆbâ€²
    with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
      rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§ = helper
  where
    â†˜âŸ¦ÏƒâŸ§â‚ : âŸ¦ Ïƒ âŸ§s drop (drop (Ï â†¦ a â†¦ bâ€²)) â†˜ âŸ¦ÏƒâŸ§
    â†˜âŸ¦ÏƒâŸ§â‚
      rewrite drop-â†¦ (Ï â†¦ a) bâ€²
            | drop-â†¦ Ï a = â†˜âŸ¦ÏƒâŸ§

    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ : drop (drop (âŸ¦ÏƒâŸ§ â†¦ a â†¦ b)) â‰ˆ drop (drop (âŸ¦ÏƒâŸ§ â†¦ a â†¦ bâ€²)) âˆˆ âŸ¦ âŠ¨Î”â‚„ âŸ§Ï
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§
      rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) b
            | drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) bâ€²
            | drop-â†¦ âŸ¦ÏƒâŸ§ a = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´

    aâ‰ˆaâ‚„ : a âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§))
    aâ‰ˆaâ‚„
      with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ = aâ‰ˆa

    bâ‰ˆbâ€²â‚„ : b â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Trelâ‚„ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ , aâ‰ˆaâ‚„)))
    bâ‰ˆbâ€²â‚„
      with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ } â† Trelâ‚„ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ , aâ‰ˆaâ‚„)
        rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) b
              | drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) bâ€²
              | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â‚„
              | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚„ = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚„ bâ‰ˆbâ€²

    module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)))

    helper : âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Ïƒ ]) , re.âŸ¦tâŸ§ , (r [ q (q Ïƒ) ]) , Ï , su a â†˜ resâ€²
                      Ã— Î£ (RelTyp (nâ‚‚ âŠ” nâ‚ƒ âŠ” nâ‚„) T (âŸ¦ÏƒâŸ§ â†¦ su a) T (âŸ¦ÏƒâŸ§ â†¦ su a))
                        Î» rel â†’ res â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel)
    helper
      with râ‰ˆrâ€² ((âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ , aâ‰ˆaâ‚„) , bâ‰ˆbâ€²â‚„)
    ... | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ }
        , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
        rewrite âŸ¦âŸ§-det â†˜r â†˜âŸ¦râŸ§
              | drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) b
              | drop-â†¦ (âŸ¦ÏƒâŸ§ â†¦ a) bâ€²
              | drop-â†¦ âŸ¦ÏƒâŸ§ a         = _ , suâ†˜ â†˜bâ€² (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§â‚)) â†˜âŸ¦râ€²âŸ§)
                                     , record
                                       { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„
                                       ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„
                                       ; Tâ‰ˆTâ€² = ğ•Œ-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€²â‚„
                                       }
                                     , El-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€²â‚„ râ‰ˆrâ€²
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {â†‘ N c} {â†‘ Tâ€² (rec _ _ _ _ _)} âŠ¨Î“ (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ (âˆº-cong âŠ¨Î”â‚‚ Nrelâ‚‚ , nâ‚‚ , Trelâ‚‚) (âŠ¨Î”â‚ƒ , nâ‚ƒ , sâ‰ˆsâ€²) (âˆº-cong (âˆº-cong âŠ¨Î”â‚„ Nrelâ‚„) Trelâ‚„ , nâ‚„ , râ‰ˆrâ€²) (ne câ‰ˆc) (recâˆ™ Tâ†˜)
  with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
    rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§ = helper
  where
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ : drop (âŸ¦ÏƒâŸ§ â†¦ â†‘ N c) âˆˆâ€² âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ rewrite drop-â†¦ âŸ¦ÏƒâŸ§ (â†‘ N c) = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´

    â†‘Ncâ‰ˆâ†‘Nc : â†‘ N c âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚))
    â†‘Ncâ‰ˆâ†‘Nc
      with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ = ne câ‰ˆc

    module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)))

    helper : âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Ïƒ ]) , re.âŸ¦tâŸ§ , (r [ q (q Ïƒ) ]) , Ï , â†‘ N c â†˜ resâ€²
                      Ã— Î£ (RelTyp (nâ‚‚ âŠ” nâ‚ƒ âŠ” nâ‚„) T (âŸ¦ÏƒâŸ§ â†¦ â†‘ N c) T (âŸ¦ÏƒâŸ§ â†¦ â†‘ N c))
                          (Î» rel â†’ â†‘ Tâ€² (rec T re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c) â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper
      with Trelâ‚‚ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ , â†‘Ncâ‰ˆâ†‘Nc)
    ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚‚ _ }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€² }
        rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚‚
          with refl â† âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦TâŸ§
             | refl â† âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ Tâ†˜                = _ , recâˆ™ (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (subst (âŸ¦ Ïƒ âŸ§s_â†˜ âŸ¦ÏƒâŸ§) (sym (drop-â†¦ _ _)) â†˜âŸ¦ÏƒâŸ§)) Tâ†˜)
                                                   , record
                                                     { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                                                     ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                                     ; Tâ‰ˆTâ€² = ğ•Œ-cumu (â‰¤-trans (<â‡’â‰¤ i<nâ‚‚) (â‰¤-trans (mâ‰¤mâŠ”n _ _) (mâ‰¤mâŠ”n _ nâ‚„))) Tâ‰ˆTâ€²
                                                     }
                                                   , El-cumu (â‰¤-trans (<â‡’â‰¤ i<nâ‚‚) (â‰¤-trans (mâ‰¤mâŠ”n _ _) (mâ‰¤mâŠ”n _ nâ‚„))) Tâ‰ˆTâ€² (realizability-Re Tâ‰ˆTâ€² bot-helper)
      where
        bot-helper : rec T re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c â‰ˆ rec (T [ q Ïƒ ]) re.âŸ¦tâŸ§ (r [ q (q Ïƒ) ]) Ï c âˆˆ Bot
        bot-helper ns Îº
          with câ‰ˆc ns Îº
        ...  | _ , â†˜c , _ = bot-helperâ€²
          where
            â†˜âŸ¦ÏƒâŸ§drop : âˆ€ {a} â†’ âŸ¦ Ïƒ âŸ§s drop (Ï [ Îº ] â†¦ a) â†˜ âŸ¦ÏƒâŸ§ [ Îº ]
            â†˜âŸ¦ÏƒâŸ§drop {a} rewrite drop-â†¦ (Ï [ Îº ]) a = âŸ¦âŸ§s-mon Îº â†˜âŸ¦ÏƒâŸ§

            â†˜âŸ¦ÏƒâŸ§dropdrop : âˆ€ {a b} â†’ âŸ¦ Ïƒ âŸ§s drop (drop (Ï [ Îº ] â†¦ a â†¦ b)) â†˜ âŸ¦ÏƒâŸ§ [ Îº ]
            â†˜âŸ¦ÏƒâŸ§dropdrop {a} {b}
              rewrite drop-â†¦ (Ï [ Îº ] â†¦ a) b
                    | drop-â†¦ (Ï [ Îº ]) a = âŸ¦âŸ§s-mon Îº â†˜âŸ¦ÏƒâŸ§

            âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ : âˆ€ {a b} â†’ drop (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) â‰ˆ drop (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ b) âˆˆ âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï
            âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ {a} {b}
              rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) a
                    | drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) b = âŸ¦âŸ§Ï-mon âŠ¨Î”â‚‚ Îº (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´)

            aâ‰ˆbâ‚‚ : âˆ€ {a b} â†’ a â‰ˆ b âˆˆ Nat â†’ a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚‚ (âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ {a} {b})))
            aâ‰ˆbâ‚‚ {a} {b} aâ‰ˆb
              with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚‚ (âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ {a} {b}) = aâ‰ˆb

            bot-helperâ€² : âˆƒ Î» u â†’ Re ns - rec T re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c [ Îº ] â†˜ u
                                Ã— Re ns - rec (T [ q Ïƒ ]) re.âŸ¦tâŸ§ (r [ q (q Ïƒ) ]) Ï c [ Îº ] â†˜ u
            bot-helperâ€²
              with Trelâ‚‚ (âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ , (aâ‰ˆbâ‚‚ (ne (Bot-l (head ns)))))
                 | sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)
                 | Trelâ‚‚ (âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ , (aâ‰ˆbâ‚‚ ze))
            ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚‚ns _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§ns ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ns ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²ns }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ze ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²ze }
                 , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚‚ze _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§zeâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§zeâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²zeâ‚ }
                with Tâ‰ˆTâ€²ns â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚‚ns) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚‚ns) Tâ‰ˆTâ€²ns)
                   | Tâ‰ˆTâ€²zeâ‚ â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚‚ze) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚‚ze) Tâ‰ˆTâ€²zeâ‚)
                  rewrite sym (â†¦-mon âŸ¦ÏƒâŸ§ ze Îº)
                        | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§zeâ‚ (âŸ¦âŸ§-mon Îº â†˜âŸ¦TâŸ§ze)
                    with realizability-Rty Tâ‰ˆTâ€²ns (inc ns) vone
                       | realizability-Rf Tâ‰ˆTâ€²zeâ‚ (El-one-sided (ğ•Œ-mon Îº Tâ‰ˆTâ€²ze) Tâ‰ˆTâ€²zeâ‚ (El-mon Tâ‰ˆTâ€²ze Îº (ğ•Œ-mon Îº Tâ‰ˆTâ€²ze) sâ‰ˆsâ€²)) ns vone
            ...        | _ , Tnsâ†˜ , Tâ€²nsâ†˜
                       | _ , Tzeâ†˜ , Tâ€²zeâ†˜
                      rewrite D-ap-vone âŸ¦TâŸ§ns
                            | âŸ¦âŸ§-det (âŸ¦âŸ§-mon Îº â†˜âŸ¦TâŸ§ze) â†˜âŸ¦TâŸ§zeâ‚
                            | â†¦-mon âŸ¦ÏƒâŸ§ ze Îº
                            | D-ap-vone âŸ¦TâŸ§zeâ‚
                            | D-ap-vone (âŸ¦sâŸ§ [ Îº ])
                     = bot-helperâ€³
              where
                âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ : drop (drop (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ lâ€² N (head ns) â†¦ lâ€² âŸ¦TâŸ§ns (suc (head ns)))) âˆˆâ€² âŸ¦ âŠ¨Î”â‚„ âŸ§Ï
                âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„
                  rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                        | drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) (lâ€² N (head ns)) = âŸ¦âŸ§Ï-mon âŠ¨Î”â‚„ Îº (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´)

                aâ‰ˆbâ‚„ : lâ€² N (head ns) âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„))
                aâ‰ˆbâ‚„
                  with record { Tâ‰ˆTâ€² = N } â† Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ = ne (Bot-l (head ns))

                aâ€²â‰ˆbâ€²â‚„ : lâ€² âŸ¦TâŸ§ns (suc (head ns)) âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Trelâ‚„ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ , aâ‰ˆbâ‚„)))
                aâ€²â‰ˆbâ€²â‚„
                  with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ } â† Trelâ‚„ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ , aâ‰ˆbâ‚„)
                    rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                          | drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                          | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ns â†˜âŸ¦TâŸ§â‚„
                          | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚„ â†˜âŸ¦Tâ€²âŸ§â‚„ = realizability-Re Tâ‰ˆTâ€²â‚„ (Bot-l (suc (head ns)))

                bot-helperâ€³ : âˆƒ Î» u â†’ Re ns - rec T âŸ¦sâŸ§ r âŸ¦ÏƒâŸ§ c [ Îº ] â†˜ u
                                    Ã— Re ns - rec (T [ q Ïƒ ]) âŸ¦sâŸ§ (r [ q (q Ïƒ) ]) Ï c [ Îº ] â†˜ u
                bot-helperâ€³
                  with râ‰ˆrâ€² ((âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ , aâ‰ˆbâ‚„) , aâ€²â‰ˆbâ€²â‚„)
                     | Trelâ‚‚ (âŸ¦ÏƒâŸ§[Îº]â‰ˆâŸ¦ÏƒâŸ§[Îº]â‚‚ , (aâ‰ˆbâ‚‚ (su (ne (Bot-l (head ns))))))
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§su ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²su }
                     , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<nâ‚‚su _ }
                     , record { âŸ¦tâŸ§ = âŸ¦TâŸ§suâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§suâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²suâ‚ }
                    with Tâ‰ˆTâ€²suâ‚ â† ğ•Œ-cumu (<â‡’â‰¤ i<nâ‚‚su) (subst (_ â‰ˆ _ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<nâ‚‚su) Tâ‰ˆTâ€²suâ‚)
                      rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ lâ€² N (head ns)) (lâ€² âŸ¦TâŸ§ns (suc (head ns)))
                            | drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) (lâ€² N (head ns))
                            | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§su â†˜âŸ¦TâŸ§suâ‚
                         with realizability-Rf Tâ‰ˆTâ€²suâ‚ (El-one-sided Tâ‰ˆTâ€²su Tâ‰ˆTâ€²suâ‚ râ‰ˆrâ€²) (inc (inc ns)) vone
                ...         | _ , Tsuâ†˜ , Tâ€²suâ†˜
                           rewrite D-ap-vone âŸ¦TâŸ§suâ‚
                                 | D-ap-vone âŸ¦râŸ§ = _
                                                 , Rr ns â†˜âŸ¦TâŸ§ns Tnsâ†˜ â†˜âŸ¦TâŸ§zeâ‚ Tzeâ†˜ â†˜âŸ¦râŸ§ â†˜âŸ¦TâŸ§suâ‚ Tsuâ†˜ â†˜c
                                                 , Rr ns
                                                      (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§drop) â†˜âŸ¦TâŸ§ns)
                                                      Tnsâ†˜
                                                      (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§drop) â†˜âŸ¦TâŸ§zeâ‚)
                                                      Tzeâ†˜
                                                      (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§dropdrop)) â†˜âŸ¦râŸ§) (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§drop) â†˜âŸ¦TâŸ§suâ‚)
                                                      Tsuâ†˜
                                                      â†˜c

rec-[]â€² : âˆ€ {i} â†’
          Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
          N âˆº Î” âŠ¨ T âˆ¶ Se i â†’
          Î” âŠ¨ s âˆ¶ T [| ze ] â†’
          T âˆº N âˆº Î” âŠ¨ r âˆ¶ T [ (wk âˆ˜ wk) , su (v 1) ] â†’
          Î” âŠ¨ t âˆ¶ N â†’
          -------------------------------------------------------------------------------------------------
          Î“ âŠ¨ rec T s r t [ Ïƒ ] â‰ˆ rec (T [ q Ïƒ ]) (s [ Ïƒ ]) (r [ q (q Ïƒ) ]) (t [ Ïƒ ]) âˆ¶ T [ Ïƒ , t [ Ïƒ ] ]
rec-[]â€² {_} {Ïƒ} {_} {T} {s} {r} {t} âŠ¨Ïƒ@(âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) âŠ¨T@(_ , nâ‚ , _) âŠ¨s@(âŠ¨Î”â‚‚ , nâ‚‚ , sâ‰ˆsâ€²) âŠ¨r@(âˆº-cong (âˆº-cong âŠ¨Î”â‚ƒ Nrelâ‚ƒ) Trelâ‚ƒ , nâ‚ƒ , râ‰ˆrâ€²) (âŠ¨Î”â‚„ , _ , tâ‰ˆtâ€²) = âŠ¨Î“ , nâ‚ âŠ” nâ‚‚ âŠ” nâ‚ƒ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             -----------------------------------------------------------------------------------------------------------------------
             Î£ (RelTyp (nâ‚ âŠ” nâ‚‚ âŠ” nâ‚ƒ) (T [ Ïƒ , t [ Ïƒ ] ]) Ï (T [ Ïƒ , t [ Ïƒ ] ]) Ïâ€²)
             Î» rel â†’ RelExp (rec T s r t [ Ïƒ ]) Ï (rec (T [ q Ïƒ ]) (s [ Ïƒ ]) (r [ q (q Ïƒ) ]) (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
        with tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´)
    ...    | record { Tâ‰ˆTâ€² = N }
           , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
          with rec-helper âŠ¨Î” Ïƒâ‰ˆÎ´ âŠ¨T âŠ¨s âŠ¨r tâ‰ˆtâ€²
             | âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
    ...      | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , res , resâ€² , â†˜res , â†˜resâ€² , resâ‰ˆresâ€²
             | Ïâ€²â‰ˆÏâ€²
            with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Î´âŸ§â‚ ; Ïƒâ‰ˆÎ´ = Î´â‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“ Ïâ€²â‰ˆÏâ€²)
               | rec-[]â€²-helperâ€² â† rec-[]â€²-helper {res = resâ€²} âŠ¨Î“ âŠ¨Ïƒ Ïâ€²â‰ˆÏâ€² âŠ¨T âŠ¨s âŠ¨r (El-refl {i = 0} N (El-symâ€² {i = 0} N tâ‰ˆtâ€²))
              with sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î” âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´)
                 | sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î” âŠ¨Î”â‚‚ Î´â‰ˆÎ´)
    ...          | _ , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
                 | _ , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâ€²âŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâŸ§â‚ ; tâ‰ˆtâ€² = sâ‰ˆs }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§â‚ â†˜âŸ¦Î´âŸ§
                      | âŸ¦âŸ§-det â†˜âŸ¦sâ€²âŸ§â‚ â†˜âŸ¦sâ€²âŸ§
                  with rec-[]â€²-helperâ€² â†˜resâ€²
    ...              | _
                     , â†˜resâ€²â‚
                     , record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ } , resâ€²â‰ˆresâ€²â‚
                    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦Tâ€²âŸ§
                          | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦Tâ€²âŸ§ = record
                                                 { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§)) â†˜âŸ¦TâŸ§
                                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                                 ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                                 }
                                               , record
                                                 { â†˜âŸ¦tâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦recâŸ§ â†˜âŸ¦sâŸ§ â†˜âŸ¦tâŸ§ â†˜res)
                                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦recâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§) â†˜resâ€²â‚
                                                 ; tâ‰ˆtâ€² = El-transâ€² Tâ‰ˆTâ€² resâ‰ˆresâ€² (El-one-sidedâ€² Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² resâ€²â‰ˆresâ€²â‚)
                                                 }
