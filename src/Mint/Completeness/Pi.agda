{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

-- Semantic judgments for Î  types
module Mint.Completeness.Pi (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Data.Nat
open import Data.Nat.Properties

open import Lib
open import Mint.Completeness.LogRel
open import Mint.Completeness.Substitutions fext
open import Mint.Completeness.Terms fext

open import Mint.Semantics.Properties.Domain fext
open import Mint.Semantics.Properties.Evaluation fext
open import Mint.Semantics.Properties.PER fext


Î -[]â€² : âˆ€ {i} â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ S âˆ¶ Se i â†’
        S âˆº Î” âŠ¨ T âˆ¶ Se i â†’
        -------------------------------------------------
        Î“ âŠ¨ Î  S T [ Ïƒ ] â‰ˆ Î  (S [ Ïƒ ]) (T [ q Ïƒ ]) âˆ¶ Se i
Î -[]â€² {_} {Ïƒ} {_} {S} {T} {i} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , _ , âŠ¨S) (âˆº-cong âŠ¨Î”â‚‚ rel , _ , âŠ¨T) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------------------------------------------------
                 Î£ (RelTyp _ (Se i) Ï (Se i) Ïâ€²)
                 Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp _ (Se i) Ï (Se i) Ïâ€²)
                       Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = U i<j _ }
                     , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     = record
                        { âŸ¦TâŸ§   = U i
                        ; âŸ¦Tâ€²âŸ§  = U i
                        ; â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ i
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ i
                        ; Tâ‰ˆTâ€²  = Uâ€² i<j
                        }
                     , record
                         { âŸ¦tâŸ§   = Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§
                         ; âŸ¦tâ€²âŸ§  = Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€²
                         ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§)
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                         ; tâ‰ˆtâ€²  = subst (Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€² âˆˆ_) (sym (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j))
                                         (result (subst (âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) tâ‰ˆtâ€²))
                         }
                  where result : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ ğ•Œ i â†’
                                 ------------------------------------------
                                 Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€² âˆˆ ğ•Œ i
                        result Sâ‰ˆ = Î  (Î» Îº â†’ ğ•Œ-mon Îº Sâ‰ˆ) step
                          where step : (Îº : UMoT) â†’
                                       a â‰ˆ aâ€² âˆˆ El i (ğ•Œ-mon Îº Sâ‰ˆ) â†’
                                       -----------------------------------------------------------
                                       Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                step {a} {aâ€²} Îº aâ‰ˆaâ€²
                                  with Ïƒâ‰ˆÎ´â‚ â† substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ (âŸ¦âŸ§Ï-mon âŠ¨Î” Îº Ïƒ.Ïƒâ‰ˆÎ´)) = answer
                                  where insert : a â‰ˆ aâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïƒâ‰ˆÎ´â‚))
                                        insert
                                          with record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† rel Ïƒâ‰ˆÎ´â‚
                                             rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâŸ§)
                                                   | âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦Tâ€²âŸ§) (drop-â†¦ _ _) â†˜âŸ¦Tâ€²âŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâ€²âŸ§) = ğ•Œ-irrel (ğ•Œ-mon Îº Sâ‰ˆ) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                                        answer : Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                        answer
                                          with âŠ¨T {Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a} {Ïƒ.âŸ¦Î´âŸ§ [ Îº ] â†¦ aâ€²} (Ïƒâ‰ˆÎ´â‚ , insert)
                                        ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = U i<j _ }
                                             , re = record
                                                      { âŸ¦TâŸ§   = re.âŸ¦tâŸ§
                                                      ; âŸ¦Tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                                      ; â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦qâŸ§ (subst (âŸ¦ Ïƒ âŸ§s_â†˜ Ïƒ.âŸ¦Î´âŸ§ [ Îº ]) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§s-mon Îº Ïƒ.â†˜âŸ¦Î´âŸ§))) re.â†˜âŸ¦tâ€²âŸ§
                                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) re.tâ‰ˆtâ€²
                                                      }
                                          where module re = RelExp re


Î -congâ€² : âˆ€ {i} â†’
          Î“ âŠ¨ S â‰ˆ Sâ€² âˆ¶ Se i â†’
          S âˆº Î“ âŠ¨ T â‰ˆ Tâ€² âˆ¶ Se i â†’
          --------------------------
          Î“ âŠ¨ Î  S T â‰ˆ Î  Sâ€² Tâ€² âˆ¶ Se i
Î -congâ€² {_} {S} {Sâ€²} {T} {Tâ€²} {i} (âŠ¨Î“ , _ , Sâ‰ˆSâ€²) (âˆº-cong âŠ¨Î“â‚ rel , _ , Tâ‰ˆTâ€²) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------
                 Î£ (RelTyp _ (Se i) Ï (Se i) Ïâ€²)
                 Î» rel â†’ RelExp (Î  S T) Ï (Î  Sâ€² Tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Sâ‰ˆSâ€² Ïâ‰ˆÏâ€²
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<j _ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j = record
                                                 { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                                                 ; Tâ‰ˆTâ€²  = Uâ€² i<j
                                                 }
                                             , record
                                                 { â†˜âŸ¦tâŸ§  = âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§
                                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                 ; tâ‰ˆtâ€²  = subst (Î  âŸ¦tâŸ§ T Ï â‰ˆ Î  âŸ¦tâ€²âŸ§ Tâ€² Ïâ€² âˆˆ_) (sym (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j)) (Î  (Î» Îº â†’ ğ•Œ-mon Îº tâ‰ˆtâ€²) result)
                                                 }
          where result : (Îº : UMoT) â†’
                         a â‰ˆ aâ€² âˆˆ El _ (ğ•Œ-mon Îº tâ‰ˆtâ€²) â†’
                         ------------------------------------------------
                         Î RT T (Ï [ Îº ] â†¦ a) Tâ€² (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                result {a} {aâ€²} Îº aâ‰ˆaâ€²
                  with Ïâ‰ˆÏâ€²â‚ â† substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-mon âŠ¨Î“ Îº Ïâ‰ˆÏâ€²)) = answer
                  where insert : a â‰ˆ aâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²â‚))
                        insert
                          with record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† rel Ïâ‰ˆÏâ€²â‚
                             rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâŸ§) = El-one-sided (ğ•Œ-mon Îº tâ‰ˆtâ€²) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                        answer : Î RT T (Ï [ Îº ] â†¦ a) Tâ€² (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                        answer
                          with Tâ‰ˆTâ€² {Ï [ Îº ] â†¦ a} {Ïâ€² [ Îº ] â†¦ aâ€²} (Ïâ‰ˆÏâ€²â‚ , insert)
                        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<j _ }
                             , re = record
                                      { â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                      ; â†˜âŸ¦Tâ€²âŸ§ = re.â†˜âŸ¦tâ€²âŸ§
                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) re.tâ‰ˆtâ€²
                                      }
                          where module re = RelExp re


Î›-congâ€² : S âˆº Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
          -----------------------
          Î“ âŠ¨ Î› t â‰ˆ Î› tâ€² âˆ¶ Î  S T
Î›-congâ€² {S} {_} {t} {tâ€²} {T} (âˆº-cong âŠ¨Î“ rel , n , tâ‰ˆtâ€²) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------
                 Î£ (RelTyp _ (Î  S T) Ï (Î  S T) Ïâ€²)
                 Î» rel â†’ RelExp (Î› t) Ï (Î› tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = record
                                 { â†˜âŸ¦TâŸ§  = âŸ¦Î âŸ§ S.â†˜âŸ¦TâŸ§
                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ S.â†˜âŸ¦Tâ€²âŸ§
                                 ; Tâ‰ˆTâ€²  = Î  (Î» Îº â†’ ğ•Œ-cumu (mâ‰¤mâŠ”n _ n) (ğ•Œ-mon Îº S.Tâ‰ˆTâ€²)) Î» Îº aâ‰ˆb â†’ projâ‚ (Î res Îº aâ‰ˆb)
                                 }
                             , record
                                 { â†˜âŸ¦tâŸ§  = âŸ¦Î›âŸ§ t
                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ tâ€²
                                 ; tâ‰ˆtâ€²  = Î» Îº aâ‰ˆb â†’ projâ‚‚ (Î res Îº aâ‰ˆb)
                                 }
             where module S = RelTyp (rel Ïâ‰ˆÏâ€²)
                   insert : (âŠ¨Î“ : âŠ¨ Î“) â†’
                            (rel : âˆ€ {Ï Ïâ€²} â†’ Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelTyp _ S Ï S Ïâ€²) â†’
                            (Îº : UMoT) (Ïâ‰ˆÏâ€² : drop (Ï [ Îº ] â†¦ a) â‰ˆ drop (Ïâ€² [ Îº ] â†¦ aâ€²) âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
                            a â‰ˆ aâ€² âˆˆ El _ (ğ•Œ-cumu (mâ‰¤mâŠ”n _ n) (ğ•Œ-mon Îº S.Tâ‰ˆTâ€²)) â†’
                            ---------------------------------------------------------------------------
                            a â‰ˆ aâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²))
                   insert âŠ¨Î“ rel Îº Ïâ‰ˆÏâ€² aâ‰ˆaâ€²
                     with record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† rel Ïâ‰ˆÏâ€²
                        rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº S.â†˜âŸ¦TâŸ§) = El-one-sided (ğ•Œ-cumu (mâ‰¤mâŠ”n _ n) (ğ•Œ-mon Îº S.Tâ‰ˆTâ€²)) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                   Î res : (Îº : UMoT) (aâ‰ˆb : a â‰ˆ b âˆˆ El _ (ğ•Œ-cumu (mâ‰¤mâŠ”n _ n) (ğ•Œ-mon Îº S.Tâ‰ˆTâ€²))) â†’
                          ---------------------------------------------------------------------------
                          Î£ (Î RT T (Ï [ Îº ] â†¦ a) T (Ïâ€² [ Îº ] â†¦ b) (ğ•Œ _))
                          Î» rel â†’ Î Ì‚ (Î› t (Ï [ Îº ])) a (Î› tâ€² (Ïâ€² [ Îº ])) b (El _ (Î RT.Tâ‰ˆTâ€² rel))
                   Î res {a} {b} Îº aâ‰ˆb
                     with Ïâ‰ˆÏâ€²â‚ â† substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§Ï-mon âŠ¨Î“ Îº Ïâ‰ˆÏâ€²) = answer
                     where answer : Î£ (Î RT T (Ï [ Îº ] â†¦ a) T (Ïâ€² [ Îº ] â†¦ b) (ğ•Œ _))
                                    Î» rel â†’ Î Ì‚ (Î› t (Ï [ Îº ])) a (Î› tâ€² (Ïâ€² [ Îº ])) b (El _ (Î RT.Tâ‰ˆTâ€² rel))
                           answer
                             with tâ‰ˆtâ€² {Ï [ Îº ] â†¦ a} {Ïâ€² [ Îº ] â†¦ b} (Ïâ‰ˆÏâ€²â‚ , insert âŠ¨Î“ rel Îº Ïâ‰ˆÏâ€²â‚ aâ‰ˆb)
                           ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                                , re = record
                                         { â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§
                                         ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                         ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²â‚
                                         }
                                     , record
                                         { â†˜fa    = Î›âˆ™ re.â†˜âŸ¦tâŸ§
                                         ; â†˜faâ€²   = Î›âˆ™ re.â†˜âŸ¦tâ€²âŸ§
                                         ; faâ‰ˆfaâ€² = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ re.tâ‰ˆtâ€²
                                         }
                             where module re = RelExp re
                                   Tâ‰ˆTâ€²â‚ = ğ•Œ-cumu (mâ‰¤nâŠ”m _ n) Tâ‰ˆTâ€²


$-congâ€² : Î“ âŠ¨ r â‰ˆ râ€² âˆ¶ Î  S T â†’
          Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶ S â†’
          -------------------------------
          Î“ âŠ¨ r $ s â‰ˆ râ€² $ sâ€² âˆ¶ T [| s ]
$-congâ€² {_} {r} {râ€²} {S} {T} {s} {sâ€²} (âŠ¨Î“ , _ , râ‰ˆrâ€²) (âŠ¨Î“â‚ , _ , sâ‰ˆsâ€²) = âŠ¨Î“ , _ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------------------------------------------
                 Î£ (RelTyp _ (T [| s ]) Ï (T [| s ]) Ïâ€²)
                 Î» rel â†’ RelExp (r $ s) Ï (râ€² $ sâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²)
             | Ïâ€²â‰ˆÏ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
          with râ‰ˆrâ€² Ïâ‰ˆÏâ€²
             | sâ‰ˆsâ€² Ïâ‰ˆÏ
             | sâ‰ˆsâ€² Ïâ€²â‰ˆÏ
             | sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§â€² ; Tâ‰ˆTâ€² = Î  iA RT }
             , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€² â†˜âŸ¦Tâ€²âŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦Tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§â‚ â†˜âŸ¦tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦tâŸ§ = record
                                           { â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§) (subst (Î» x â†’ âŸ¦ T âŸ§ x â†¦ âŸ¦tâŸ§ â†˜ RT.âŸ¦TâŸ§) (Ï-ap-vone _) RT.â†˜âŸ¦TâŸ§)
                                           ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§â‚‚) (subst (Î» x â†’ âŸ¦ T âŸ§ x â†¦ âŸ¦tâŸ§â‚‚ â†˜ RT.âŸ¦Tâ€²âŸ§) (Ï-ap-vone _) RT.â†˜âŸ¦Tâ€²âŸ§)
                                           ; Tâ‰ˆTâ€²  = RT.Tâ‰ˆTâ€²
                                           }
                                       , record
                                           { â†˜âŸ¦tâŸ§  = âŸ¦$âŸ§ â†˜âŸ¦râŸ§ â†˜âŸ¦tâŸ§ (subst (_âˆ™ âŸ¦tâŸ§ â†˜ rs.fa) (D-ap-vone _) rs.â†˜fa)
                                           ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦$âŸ§ â†˜âŸ¦râ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ (subst (_âˆ™ âŸ¦tâ€²âŸ§ â†˜ rs.faâ€²) (D-ap-vone _) rs.â†˜faâ€²)
                                           ; tâ‰ˆtâ€²  = El-transp RTâ€².Tâ‰ˆTâ€² RT.Tâ‰ˆTâ€² rs.faâ‰ˆfaâ€² (sym (âŸ¦âŸ§-det RT.â†˜âŸ¦TâŸ§ RTâ€².â†˜âŸ¦TâŸ§))
                                           }
          where Tâ‰ˆT  = ğ•Œ-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)
                srel = El-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) Tâ‰ˆT tâ‰ˆtâ€²â‚ (El-sym Tâ‰ˆTâ€²â‚‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) tâ‰ˆtâ€²â‚‚)

                module RT  = Î RT (RT vone (El-transp Tâ‰ˆT (iA vone) srel (sym (D-ap-vone _))))
                module RTâ€² = Î RT (RT vone (El-transp Tâ‰ˆTâ€² (iA vone) tâ‰ˆtâ€² (sym (D-ap-vone _))))
                module rs  = Î Ì‚ (râ‰ˆrâ€² vone (El-transp Tâ‰ˆTâ€² (iA vone) tâ‰ˆtâ€² (sym (D-ap-vone _))))


Î›-Î²â€² : S âˆº Î“ âŠ¨ t âˆ¶ T â†’
       Î“ âŠ¨ s âˆ¶ S â†’
       ----------------------------------
       Î“ âŠ¨ Î› t $ s â‰ˆ t [| s ] âˆ¶ T [| s ]
Î›-Î²â€² {S} {_} {t} {T} {s} (âˆº-cong âŠ¨Î“ rel , _ , âŠ¨t) (âŠ¨Î“â‚ , _ , âŠ¨s) = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ------------------------------------------------------------------
             Î£ (RelTyp _ (T [| s ]) Ï (T [| s ]) Ïâ€²)
             Î» rel â†’ RelExp (Î› t $ s) Ï (t [| s ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
    ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€² }
         , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² } = helperâ€²
      where
        Ïâ‰ˆÏâ€²â‚ : drop (Ï â†¦ âŸ¦sâŸ§) â‰ˆ drop (Ïâ€² â†¦ âŸ¦sâ€²âŸ§) âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï
        Ïâ‰ˆÏâ€²â‚
         rewrite drop-â†¦ Ï âŸ¦sâŸ§
               | drop-â†¦ Ïâ€² âŸ¦sâ€²âŸ§ = Ïâ‰ˆÏâ€²

        sâ‰ˆsâ€²â‚ : âŸ¦sâŸ§ â‰ˆ âŸ¦sâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²â‚))
        sâ‰ˆsâ€²â‚
          with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€²â‚ } â† rel Ïâ‰ˆÏâ€²â‚
            rewrite drop-â†¦ Ï âŸ¦sâŸ§
                  | drop-â†¦ Ïâ€² âŸ¦sâ€²âŸ§
                  | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦SâŸ§â‚
                  | âŸ¦âŸ§-det â†˜âŸ¦Sâ€²âŸ§ â†˜âŸ¦Sâ€²âŸ§â‚
                  = ğ•Œ-irrel Sâ‰ˆSâ€² Sâ‰ˆSâ€²â‚ sâ‰ˆsâ€²

        helperâ€² : Î£ (RelTyp _ (T [| s ]) Ï (T [| s ]) Ïâ€²)
                  Î» rel â†’ RelExp (Î› t $ s) Ï (t [| s ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helperâ€²
          with âŠ¨t (Ïâ‰ˆÏâ€²â‚ , sâ‰ˆsâ€²â‚)
        ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = record
                                     { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâŸ§) â†˜âŸ¦TâŸ§
                                     ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ ((âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                     ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                     }
                                   , record
                                     { â†˜âŸ¦tâŸ§ = âŸ¦$âŸ§ (âŸ¦Î›âŸ§ _) â†˜âŸ¦sâŸ§ (Î›âˆ™ â†˜âŸ¦tâŸ§)
                                     ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦sâ€²âŸ§) â†˜âŸ¦tâ€²âŸ§
                                     ; tâ‰ˆtâ€² = tâ‰ˆtâ€²
                                     }

Î›-Î·â€² : Î“ âŠ¨ t âˆ¶ Î  S T â†’
       ----------------------------------
       Î“ âŠ¨ t â‰ˆ Î› (t [ wk ] $ v 0) âˆ¶ Î  S T
Î›-Î·â€² {_} {t} {S} {T} (âŠ¨Î“ , n , âŠ¨t) = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ---------------------------------------------------------------------
             Î£ (RelTyp _ (Î  S T) Ï (Î  S T) Ïâ€²)
             Î» rel â†’ RelExp t Ï (Î› (t [ wk ] $ v 0)) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with âŠ¨t Ïâ‰ˆÏâ€²
    ...  | âŠ¨Î ST@(record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ _ ; Tâ‰ˆTâ€² = Î  iS Tâ‰ˆTâ€² })
         , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = âŠ¨Î ST , record
                                   { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§
                                   ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ _
                                   ; tâ‰ˆtâ€² = helperâ€²
                                   }
      where
        helperâ€² : {a b : D} (Îº : UMoT) (inp : a â‰ˆ b âˆˆ El _ (iS Îº)) â†’
                  -----------------------------------------------------------------------------------
                  Î Ì‚ (âŸ¦tâŸ§ [ Îº ]) a ((Î› (t [ wk ] $ v 0) Ïâ€²) [ Îº ]) b (El _ (Î RT.Tâ‰ˆTâ€² (Tâ‰ˆTâ€² Îº inp)))
        helperâ€² {a} {b} Îº inp
          with record { â†˜fa = â†˜fa ; â†˜faâ€² = â†˜faâ€² ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€² } â† tâ‰ˆtâ€² Îº inp = record
                                   { â†˜fa = â†˜fa
                                   ; â†˜faâ€² = Î›âˆ™ (âŸ¦$âŸ§ (âŸ¦[]âŸ§ âŸ¦wkâŸ§ (subst (âŸ¦ t âŸ§_â†˜ âŸ¦tâ€²âŸ§ [ Îº ]) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâ€²âŸ§))) (âŸ¦vâŸ§ 0) â†˜faâ€²)
                                   ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€²
                                   }

Î›-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        S âˆº Î” âŠ¨ t âˆ¶ T â†’
        --------------------------------------------
        Î“ âŠ¨ Î› t [ Ïƒ ] â‰ˆ Î› (t [ q Ïƒ ]) âˆ¶ Î  S T [ Ïƒ ]
Î›-[]â€² {_} {Ïƒ} {_} {S} {t} {T} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âˆº-cong âŠ¨Î”â‚ Srelâ‚ , nâ‚ , âŠ¨t) = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ------------------------------------------------------------------------------
             Î£ (RelTyp _ (Î  S T [ Ïƒ ]) Ï (Î  S T [ Ïƒ ]) Ïâ€²)
             Î» rel â†’ RelExp (Î› t [ Ïƒ ]) Ï (Î› (t [ q Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ïƒ Ïâ‰ˆÏâ€²
        with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€² } â† Srelâ‚ (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´) = record
                          { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§)
                          ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦Sâ€²âŸ§)
                          ; Tâ‰ˆTâ€² = Î  (Î» Îº â†’ ğ•Œ-mon Îº (ğ•Œ-cumu (mâ‰¤mâŠ”n _ nâ‚) Sâ‰ˆSâ€²)) return
                          }
                        , record
                          { â†˜âŸ¦tâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î›âŸ§ _)
                          ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ _
                          ; tâ‰ˆtâ€² = result
                          }
      where
        helperâ€² : {a b : D} (Îº : UMoT) (inp : a â‰ˆ b âˆˆ El _ (ğ•Œ-mon Îº (ğ•Œ-cumu (mâ‰¤mâŠ”n _ nâ‚) Sâ‰ˆSâ€²))) â†’
                  -----------------------------------------------------------------------------------
                  Î£ (RelTyp nâ‚ T (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) T (âŸ¦Î´âŸ§ [ Îº ] â†¦ b))
                  Î» rel â†’ RelExp t (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) t (âŸ¦Î´âŸ§ [ Îº ] â†¦ b) (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helperâ€² {a} {b} Îº inp = âŠ¨t (Ïƒâ‰ˆÎ´â‚ , aâ‰ˆb)
          where
            Ïƒâ‰ˆÎ´â‚ : drop (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) â‰ˆ drop (âŸ¦Î´âŸ§ [ Îº ] â†¦ b) âˆˆ âŸ¦ âŠ¨Î”â‚ âŸ§Ï
            Ïƒâ‰ˆÎ´â‚
              rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) a
                    | drop-â†¦ (âŸ¦Î´âŸ§ [ Îº ]) b = âŸ¦âŸ§Ï-mon âŠ¨Î”â‚ Îº (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´)

            aâ‰ˆb : a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Srelâ‚ Ïƒâ‰ˆÎ´â‚))
            aâ‰ˆb
              with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€²â‚ } â† Srelâ‚ Ïƒâ‰ˆÎ´â‚
                rewrite drop-â†¦ (âŸ¦ÏƒâŸ§ [ Îº ]) a
                      | drop-â†¦ (âŸ¦Î´âŸ§ [ Îº ]) b
                      | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â‚ (âŸ¦âŸ§-mon Îº â†˜âŸ¦SâŸ§)
                      | âŸ¦âŸ§-det â†˜âŸ¦Sâ€²âŸ§â‚ (âŸ¦âŸ§-mon Îº â†˜âŸ¦Sâ€²âŸ§) = ğ•Œ-irrel (ğ•Œ-mon Îº (ğ•Œ-cumu (mâ‰¤mâŠ”n _ nâ‚) Sâ‰ˆSâ€²)) Sâ‰ˆSâ€²â‚ inp

        return : {a b : D} (Îº : UMoT) â†’
                 a â‰ˆ b âˆˆ El _ (ğ•Œ-mon Îº (ğ•Œ-cumu (mâ‰¤mâŠ”n _ nâ‚) Sâ‰ˆSâ€²)) â†’
                 -------------------------------------------------------
                 Î RT T (âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) T (âŸ¦Î´âŸ§ [ Îº ] â†¦ b) (ğ•Œ (_ âŠ” nâ‚))
        return Îº inp
          with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† projâ‚ (helperâ€² Îº inp) = record
                           { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                           ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                           ; Tâ‰ˆTâ€² = ğ•Œ-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€²
                           }

        result : {a b : D} (Îº : UMoT) (inp : a â‰ˆ b âˆˆ El _ (ğ•Œ-mon Îº (ğ•Œ-cumu (mâ‰¤mâŠ”n _ nâ‚) Sâ‰ˆSâ€²))) â†’
                 -------------------------------------------------------------------------------------
                 Î Ì‚ (Î› t âŸ¦ÏƒâŸ§ [ Îº ]) a ((Î› (t [ q Ïƒ ]) Ïâ€²) [ Îº ]) b (El _ (Î RT.Tâ‰ˆTâ€² (return Îº inp)))
        result {a} {b} Îº inp
          with helperâ€² Îº inp
        ...  | record { Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = record
                          { â†˜fa = Î›âˆ™ â†˜âŸ¦tâŸ§
                          ; â†˜faâ€² = Î›âˆ™ (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (subst (âŸ¦ Ïƒ âŸ§s_â†˜ âŸ¦Î´âŸ§ [ Îº ]) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§s-mon Îº â†˜âŸ¦Î´âŸ§))) â†˜âŸ¦tâ€²âŸ§)
                          ; faâ‰ˆfaâ€² = ğ•Œ-irrel Tâ‰ˆTâ€² (ğ•Œ-cumu (mâ‰¤nâŠ”m _ _) Tâ‰ˆTâ€²) tâ‰ˆtâ€²
                          }

$-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ r âˆ¶ Î  S T â†’
        Î” âŠ¨ s âˆ¶ S â†’
        ---------------------------------------------------------
        Î“ âŠ¨ (r $ s) [ Ïƒ ] â‰ˆ r [ Ïƒ ] $ s [ Ïƒ ] âˆ¶ T [ Ïƒ , s [ Ïƒ ] ]
$-[]â€² {_} {Ïƒ} {_} {r} {S} {T} {s} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , _ , âŠ¨r) (âŠ¨Î”â‚‚ , _ , âŠ¨s) = âŠ¨Î“ , _ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ----------------------------------------------------------------------------------
             Î£ (RelTyp _ (T [ Ïƒ , s [ Ïƒ ] ]) Ï (T [ Ïƒ , s [ Ïƒ ] ]) Ïâ€²)
             Î» rel â†’ RelExp ((r $ s) [ Ïƒ ]) Ï (r [ Ïƒ ] $ s [ Ïƒ ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ïƒ Ïâ‰ˆÏâ€²
        with âŠ¨r (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´)
           | âŠ¨s (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´)
    ...    | record { â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦Sâ€²âŸ§ ; Tâ‰ˆTâ€² = Î  iS Trel }
           , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
           | record { âŸ¦TâŸ§ = âŸ¦SâŸ§â‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Sâ€²âŸ§â‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Sâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Sâ‰ˆSâ€²â‚ }
           , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦sâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
           with Sâ‰ˆSâ€² â† iS vone
              | Trelâ‚ â† Trel {âŸ¦sâŸ§} {âŸ¦sâ€²âŸ§} vone
              | râ‰ˆrâ€²â‚ â† râ‰ˆrâ€² {âŸ¦sâŸ§} {âŸ¦sâ€²âŸ§} vone
             rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦SâŸ§â‚
                   | âŸ¦âŸ§-det â†˜âŸ¦Sâ€²âŸ§ â†˜âŸ¦Sâ€²âŸ§â‚
                   | Ï-ap-vone âŸ¦ÏƒâŸ§ 
                   | Ï-ap-vone âŸ¦Î´âŸ§
                   | D-ap-vone âŸ¦râŸ§
                   | D-ap-vone âŸ¦râ€²âŸ§
                   | D-ap-vone âŸ¦SâŸ§â‚
                   | D-ap-vone âŸ¦Sâ€²âŸ§â‚
                with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } â† Trelâ‚ (ğ•Œ-irrel Sâ‰ˆSâ€²â‚ Sâ‰ˆSâ€² sâ‰ˆsâ€²)
                   | record { â†˜fa = â†˜fa ; â†˜faâ€² = â†˜faâ€² ; faâ‰ˆfaâ€² = faâ‰ˆfaâ€² } â† râ‰ˆrâ€²â‚ (ğ•Œ-irrel Sâ‰ˆSâ€²â‚ Sâ‰ˆSâ€² sâ‰ˆsâ€²) = record
                                      { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦sâŸ§)) â†˜âŸ¦TâŸ§
                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                      ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                      }
                                    , record
                                      { â†˜âŸ¦tâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦$âŸ§ â†˜âŸ¦râŸ§ â†˜âŸ¦sâŸ§ â†˜fa)
                                      ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦$âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦râ€²âŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§) â†˜faâ€²
                                      ; tâ‰ˆtâ€² = faâ‰ˆfaâ€²
                                      }
