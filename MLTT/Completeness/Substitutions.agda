{-# OPTIONS --without-K --safe #-}

open import Level
open import Axiom.Extensionality.Propositional

-- Semantic judgments for substitutions
module MLTT.Completeness.Substitutions (fext : Extensionality 0â„“ (suc 0â„“)) where

open import Data.Nat.Properties

open import Lib hiding (lookup)
open import MLTT.Completeness.LogRel

open import MLTT.Semantics.Properties.PER fext
open import MLTT.Completeness.Contexts fext
open import MLTT.Completeness.Terms fext
open import MLTT.Completeness.Universe fext


I-â‰ˆâ€² : âŠ¨ Î“ â†’
       --------------
       Î“ âŠ¨s I â‰ˆ I âˆ¶ Î“
I-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------
                 RelSubst I Ï I Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { â†˜âŸ¦ÏƒâŸ§ = âŸ¦IâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦IâŸ§
          ; Ïƒâ‰ˆÎ´  = Ïâ‰ˆÏâ€²
          }


wk-â‰ˆâ€² : âŠ¨ T âˆ· Î“ â†’
        --------------------------
        T âˆ· Î“ âŠ¨s wk â‰ˆ wk âˆ¶ Î“
wk-â‰ˆâ€² {T} âŠ¨TÎ“@(âˆ·-cong âŠ¨Î“ _) = âŠ¨TÎ“ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨TÎ“ âŸ§Ï â†’
                 ------------------------------
                 RelSubst wk Ï wk Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper (Ïâ‰ˆÏâ€² , _) = record
          { â†˜âŸ¦ÏƒâŸ§ = âŸ¦wkâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦wkâŸ§
          ; Ïƒâ‰ˆÎ´  = Ïâ‰ˆÏâ€²
          }


âˆ˜-congâ€² : Î“ âŠ¨s Ï„ â‰ˆ Ï„â€² âˆ¶ Î“â€² â†’
          Î“â€² âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î“â€³ â†’
          ----------------
          Î“ âŠ¨s Ïƒ âˆ˜ Ï„ â‰ˆ Ïƒâ€² âˆ˜ Ï„â€² âˆ¶ Î“â€³
âˆ˜-congâ€² {_} {Ï„} {Ï„â€²} {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î“â€² , Ï„â‰ˆÏ„â€²) (âŠ¨Î“â€²â‚ , âŠ¨Î“â€³ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , âŠ¨Î“â€³ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ------------------------------------------
                 RelSubst (Ïƒ âˆ˜ Ï„) Ï (Ïƒâ€² âˆ˜ Ï„â€²) Ïâ€² âŸ¦ âŠ¨Î“â€³ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { Ïƒ
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§
          }
          where module Ï„ = RelSubst (Ï„â‰ˆÏ„â€² Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubst (Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ï„.Ïƒâ‰ˆÎ´))


,-congâ€² : âˆ€ {i} â†’
          Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
          Î” âŠ¨ T âˆ¶ Se i â†’
          Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T [ Ïƒ ] â†’
          -----------------------------
          Î“ âŠ¨s Ïƒ , t â‰ˆ Ïƒâ€² , tâ€² âˆ¶ T âˆ· Î”
,-congâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {T} {t} {tâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) (âŠ¨Î”â‚ , i , âŠ¨T) (âŠ¨Î“â‚ , j , tâ‰ˆtâ€²) = âŠ¨Î“ , âˆ·-cong âŠ¨Î” helper , helperâ€²
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î” âŸ§Ï â†’
                 -------------------
                 RelTyp _ T Ï T Ïâ€²
        helper = âˆ·-cong-helper (âŠ¨Î”â‚ , i , âŠ¨T) âŠ¨Î”

        helperâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                  -------------------------------------------------------
                  RelSubst (Ïƒ , t) Ï (Ïƒâ€² , tâ€²) Ïâ€² âŸ¦ âˆ·-cong âŠ¨Î” helper âŸ§Ï
        helperâ€² {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Ïâ‰ˆÏâ€²â‚ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²
             with Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
                | tâ‰ˆtâ€² Ïâ‰ˆÏâ€²â‚
        ...     | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ }
                | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦ÏƒâŸ§ = record
                                                  { â†˜âŸ¦ÏƒâŸ§ = âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§
                                                  ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                  ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´ , tâ‰ˆtâ€²â‚
                                                  }
            where tâ‰ˆtâ€²â‚ : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïƒâ‰ˆÎ´))
                  tâ‰ˆtâ€²â‚
                    with Ïƒâ‰ˆÎ´â‚‚ â† âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´
                       with âŠ¨T Ïƒâ‰ˆÎ´â‚‚
                  ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U j<i _ }
                          , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
                          rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i
                                | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦TâŸ§ = El-one-sided Tâ‰ˆTâ€² tâ‰ˆtâ€²â‚ tâ‰ˆtâ€²


I-âˆ˜â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s I âˆ˜ Ïƒ â‰ˆ Ïƒ âˆ¶ Î”
I-âˆ˜â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------
                 RelSubst (I âˆ˜ Ïƒ) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ â†˜âŸ¦ÏƒâŸ§ âŸ¦IâŸ§
          }
          where open RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


âˆ˜-Iâ€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s Ïƒ âˆ˜ I â‰ˆ Ïƒ âˆ¶ Î”
âˆ˜-Iâ€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------------
                 RelSubst (Ïƒ âˆ˜ I) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ âŸ¦IâŸ§ â†˜âŸ¦ÏƒâŸ§
          }
          where open RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


âˆ˜-assocâ€² : âˆ€ {Î“â€´} â†’
           Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
           Î“â€³ âŠ¨s Ïƒâ€² âˆ¶ Î“â€² â†’
           Î“â€´ âŠ¨s Ïƒâ€³ âˆ¶ Î“â€³ â†’
           ---------------------------------------
           Î“â€´ âŠ¨s Ïƒ âˆ˜ Ïƒâ€² âˆ˜ Ïƒâ€³ â‰ˆ Ïƒ âˆ˜ (Ïƒâ€² âˆ˜ Ïƒâ€³) âˆ¶ Î“
âˆ˜-assocâ€² {_} {Ïƒ} {_} {_} {Ïƒâ€²} {Ïƒâ€³} (âŠ¨Î“â€² , âŠ¨Î“ , âŠ¨Ïƒ) (âŠ¨Î“â€³ , âŠ¨Î“â€²â‚ , âŠ¨Ïƒâ€²) (âŠ¨Î“â€´ , âŠ¨Î“â€³â‚ , âŠ¨Ïƒâ€³) = âŠ¨Î“â€´ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€´ âŸ§Ï â†’
                 -----------------------------------------------------
                 RelSubst (Ïƒ âˆ˜ Ïƒâ€² âˆ˜ Ïƒâ€³) Ï (Ïƒ âˆ˜ (Ïƒâ€² âˆ˜ Ïƒâ€³)) Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
            { Ïƒ
            ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ïƒâ€³.â†˜âŸ¦ÏƒâŸ§ (âŸ¦âˆ˜âŸ§ Ïƒâ€².â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§)
            ; â†˜âŸ¦Î´âŸ§ = âŸ¦âˆ˜âŸ§ (âŸ¦âˆ˜âŸ§ Ïƒâ€³.â†˜âŸ¦Î´âŸ§ Ïƒâ€².â†˜âŸ¦Î´âŸ§) Ïƒ.â†˜âŸ¦Î´âŸ§
            }
          where module Ïƒâ€³ = RelSubst (âŠ¨Ïƒâ€³ Ïâ‰ˆÏâ€²)
                module Ïƒâ€² = RelSubst (âŠ¨Ïƒâ€² (âŠ¨-irrel âŠ¨Î“â€³â‚ âŠ¨Î“â€³ Ïƒâ€³.Ïƒâ‰ˆÎ´))
                module Ïƒ  = RelSubst (âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€²â‚ âŠ¨Î“â€² Ïƒâ€².Ïƒâ‰ˆÎ´))


,-âˆ˜â€² : âˆ€ {i} â†’
       Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
       Î“â€³ âŠ¨ T âˆ¶ Se i â†’
       Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
       Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
       ---------------------------------------------
       Î“ âŠ¨s (Ïƒ , t) âˆ˜ Ï„ â‰ˆ (Ïƒ âˆ˜ Ï„) , t [ Ï„ ] âˆ¶ T âˆ· Î“â€³
,-âˆ˜â€² {_} {Ïƒ} {_} {T} {t} {_} {Ï„} (âŠ¨Î“â€² , âŠ¨Î“â€³ , âŠ¨Ïƒ) (âŠ¨Î“â€³â‚ , i , âŠ¨T) (âŠ¨Î“â€²â‚ , j , âŠ¨t) (âŠ¨Î“ , âŠ¨Î“â€²â‚‚ , âŠ¨Ï„) = âŠ¨Î“ , âˆ·-cong âŠ¨Î“â€³ helper , helperâ€³
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€³ âŸ§Ï â†’
                 -------------------
                 RelTyp _ T Ï T Ïâ€²
        helper = âˆ·-cong-helper (âŠ¨Î“â€³â‚ , i , âŠ¨T) âŠ¨Î“â€³

        helperâ€² : âˆ€ {i} â†’
                  (Aâ‰ˆB : A â‰ˆ B âˆˆ ğ•Œ i) â†’
                  a â‰ˆ b âˆˆ El i Aâ‰ˆB â†’
                  (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€³ âŸ§Ï) â†’
                  âŸ¦ T âŸ§ Ï â†˜ A â†’
                  -----------------------------------------
                  a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïâ‰ˆÏâ€²))
        helperâ€² {i = i} Aâ‰ˆB aâ‰ˆb Ïâ‰ˆÏâ€² â†˜A
          with Ïâ‰ˆÏâ€²â‚ â† âŠ¨-irrel âŠ¨Î“â€³ âŠ¨Î“â€³â‚ Ïâ‰ˆÏâ€²
             with âŠ¨T Ïâ‰ˆÏâ€²â‚
        ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U j<i _ }
                , record { âŸ¦tâŸ§ = âŸ¦TâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²â‚ }
                rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i
                      | âŸ¦âŸ§-det â†˜A â†˜âŸ¦tâŸ§ = El-one-sided Aâ‰ˆB Tâ‰ˆTâ€²â‚ aâ‰ˆb

        helperâ€³ : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                  ------------------------------------------------------------------------
                  RelSubst ((Ïƒ , t) âˆ˜ Ï„) Ï ((Ïƒ âˆ˜ Ï„) , t [ Ï„ ]) Ïâ€² âŸ¦ âˆ·-cong âŠ¨Î“â€³ helper âŸ§Ï
        helperâ€³ {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† âŠ¨Ï„ Ïâ‰ˆÏâ€²
             with âŠ¨t (âŠ¨-irrel âŠ¨Î“â€²â‚‚ âŠ¨Î“â€²â‚ Ïƒâ‰ˆÎ´) | âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€²â‚‚ âŠ¨Î“â€² Ïƒâ‰ˆÎ´)
        ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â‚ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§â‚ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´â‚ }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦ÏƒâŸ§â‚ = record
                                      { â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§â‚ â†˜âŸ¦tâŸ§)
                                      ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦Î´âŸ§â‚) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                                      ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´â‚ , tâ‰ˆtâ€²â‚
                                      }
          where tâ‰ˆtâ€²â‚ : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (helper Ïƒâ‰ˆÎ´â‚))
                tâ‰ˆtâ€²â‚ = helperâ€² Tâ‰ˆTâ€² tâ‰ˆtâ€² Ïƒâ‰ˆÎ´â‚ â†˜âŸ¦TâŸ§



p-,â€² : Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
       Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
       -------------------------
       Î“â€² âŠ¨s p (Ïƒ , t) â‰ˆ Ïƒ âˆ¶ Î“
p-,â€² {_} {Ïƒ} {_} {t} {T} (âŠ¨Î“â€² , âŠ¨Î“ , âŠ¨Ïƒ) (âŠ¨Î“â€²â‚ , _ , âŠ¨t) = âŠ¨Î“â€² , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€² âŸ§Ï â†’
                 -------------------------------------
                 RelSubst (p (Ïƒ , t)) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : RelSubst (p (Ïƒ , t)) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
                help
                  with âŠ¨t (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ïâ‰ˆÏâ€²)
                ... | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦Tâ€²âŸ§ }
                    , re
                    rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
                          | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² Ïƒ.â†˜âŸ¦Î´âŸ§ = record
                                                     { Ïƒ
                                                     ; âŸ¦ÏƒâŸ§  = drop (Ïƒ.âŸ¦ÏƒâŸ§ â†¦ re.âŸ¦tâŸ§)
                                                     ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) âŸ¦wkâŸ§
                                                     ; Ïƒâ‰ˆÎ´  = Ïƒ.Ïƒâ‰ˆÎ´
                                                     }
                  where module re = RelExp re


,-extâ€² : Î“â€² âŠ¨s Ïƒ âˆ¶ T âˆ· Î“ â†’
         ----------------------------------
         Î“â€² âŠ¨s Ïƒ â‰ˆ p Ïƒ , v 0 [ Ïƒ ] âˆ¶ T âˆ· Î“
,-extâ€² {_} {Ïƒ} {T} (âŠ¨Î“â€² , âŠ¨TÎ“@(âˆ·-cong _ _) , âŠ¨Ïƒ) = âŠ¨Î“â€² , âŠ¨TÎ“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â€² âŸ§Ï â†’
                 ------------------------------------------------------
                 RelSubst Ïƒ Ï (p Ïƒ , v 0 [ Ïƒ ]) Ïâ€² âŸ¦ âŠ¨TÎ“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
          ; âŸ¦Î´âŸ§  = drop âŸ¦Î´âŸ§ â†¦ lookup âŸ¦Î´âŸ§ 0
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ â†˜âŸ¦Î´âŸ§ âŸ¦wkâŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦vâŸ§ 0))
          ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´
          }
          where open RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


s-â‰ˆ-symâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
           ------------------
           Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒ âˆ¶ Î”
s-â‰ˆ-symâ€² {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ---------------------------
                 RelSubst Ïƒâ€² Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Î´âŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦ÏƒâŸ§
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-sym âŠ¨Î” âŠ¨Î” Ïƒâ‰ˆÎ´
          }
          where open RelSubst (Ïƒâ‰ˆÏƒâ€² (âŸ¦âŸ§Ï-sym âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²))


s-â‰ˆ-transâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
             Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒâ€³ âˆ¶ Î” â†’
             -------------------
             Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€³ âˆ¶ Î”
s-â‰ˆ-transâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {Ïƒâ€³} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) (âŠ¨Î“â€² , âŠ¨Î”â€² , Ïƒâ€²â‰ˆÏƒâ€³) = âŠ¨Î“ , âŠ¨Î”â€² , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------
                 RelSubst Ïƒ Ï Ïƒâ€³ Ïâ€² âŸ¦ âŠ¨Î”â€² âŸ§Ï
        helper Ïâ‰ˆÏâ€²
          with Ïƒâ‰ˆÏƒâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²) | Ïƒâ€²â‰ˆÏƒâ€³ (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â€² Ïâ‰ˆÏâ€²)
        ...  | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§   ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÏƒâ€² }
             | record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€² ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€³âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ€²â‰ˆÏƒâ€³ }
             rewrite âŸ¦âŸ§s-det â†˜âŸ¦Ïƒâ€²âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€² = record
          { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€³âŸ§
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-trans âŠ¨Î” âŠ¨Î”â€² âŠ¨Î”â€² Ïƒâ‰ˆÏƒâ€² Ïƒâ€²â‰ˆÏƒâ€³
          }


s-â‰ˆ-convâ€² : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
            âŠ¨ Î” â‰ˆ Î”â€² â†’
            ------------------
            Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î”â€²
s-â‰ˆ-convâ€² {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) Î”â‰ˆÎ”â€² = âŠ¨Î“ , âŠ¨Î”â€² , helper
  where âŠ¨Î”â€² = âŠ¨-refl (âŠ¨-sym Î”â‰ˆÎ”â€²)
        helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ----------------------------
                 RelSubst Ïƒ Ï Ïƒâ€² Ïâ€² âŸ¦ âŠ¨Î”â€² âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { RelSubst (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²)
          ; Ïƒâ‰ˆÎ´  = âŸ¦âŸ§Ï-transport âŠ¨Î” âŠ¨Î”â€² Ïƒâ‰ˆÎ´ Î”â‰ˆÎ”â€²
          }
          where open RelSubst (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²)
