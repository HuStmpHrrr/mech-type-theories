{-# OPTIONS --without-K --safe #-}

open import Level hiding (_âŠ”_)
open import Axiom.Extensionality.Propositional

-- Semantic judgments for Nat
module NonCumulative.Completeness.Nat (fext : Extensionality 0â„“ (suc 0â„“)) where

open import Data.Nat
open import Data.Nat.Properties

open import Lib
open import NonCumulative.Completeness.LogRel

open import NonCumulative.Semantics.Properties.PER fext
open import NonCumulative.Semantics.Readback
open import NonCumulative.Semantics.Realizability fext


N-â‰ˆâ€² : âŠ¨ Î“ â†’
       ----------------
       Î“ âŠ¨ N â‰ˆ N âˆ¶[ 1 ] Se 0
N-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , Î» Ïâ‰ˆÏâ€² â†’ record
                        { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                        ; Tâ‰ˆTâ€²  = Uâ€²
                        }
                        , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦NâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦NâŸ§
                        ; tâ‰ˆtâ€²  = Nâ€²
                        }

ze-â‰ˆâ€² : âŠ¨ Î“ â†’
        ----------------
        Î“ âŠ¨ ze â‰ˆ ze âˆ¶[ 0 ] N
ze-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , Î» Ïâ‰ˆÏâ€² â†’ record
                         { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                         ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                         ; Tâ‰ˆTâ€²  = Nâ€²
                         }
                         , record
                         { â†˜âŸ¦tâŸ§  = âŸ¦zeâŸ§
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦zeâŸ§
                         ; tâ‰ˆtâ€²  = ze
                         }

su-congâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶[ 0 ] N â†’
           ----------------
           Î“ âŠ¨ su t â‰ˆ su tâ€² âˆ¶[ 0 ] N
su-congâ€² {_} {t} {tâ€²} (âŠ¨Î“ , tâ‰ˆtâ€²) = âŠ¨Î“ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             ------------------------------------------------------------
             Î£ (RelTyp 0 N Ï N Ïâ€²)
             Î» rel â†’ RelExp (su t) Ï (su tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = Nâ€² }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² } = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                        ; Tâ‰ˆTâ€²  = Nâ€²
                        }
                        , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦suâŸ§ â†˜âŸ¦tâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦suâŸ§ â†˜âŸ¦tâ€²âŸ§
                        ; tâ‰ˆtâ€²  = su tâ‰ˆtâ€²
                        }


-- A lemma to handle asymmetry appears in several Nat judgements.
-- This follows the trick of []-congâ€² in NonCumulative.Completeness.Terms.
--
-- An example of asymmetry is in the return type of rec-congâ€²:
--
--   Î“ âŠ¨ rec T s r t â‰ˆ rec Tâ€² sâ€² râ€² tâ€² âˆ¶ T [| t ]
--
-- Here, the RHS says that rec Tâ€² sâ€² râ€² tâ€² is of T [| t ], and thus
-- has different terms (tâ€² and t) unlike the LHS.
RelExp-refl : âˆ€ {n} (âŠ¨Î“ : âŠ¨ Î“) â†’
              ({Ï Ïâ€² : Env} â†’ (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’ Î£ (RelTyp n T Ï Tâ€² Ïâ€²) (Î» rel â†’ RelExp t Ï tâ€² Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel)))) â†’
              ({Ï Ïâ€² : Env} â†’ (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’ Î£ (RelTyp n T Ï T Ïâ€²) (Î» rel â†’ RelExp t Ï t Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))))
RelExp-refl âŠ¨Î“ TTâ€² Ïâ‰ˆÏâ€²
  with TTâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²)
     | TTâ€² Ïâ‰ˆÏâ€²
     | TTâ€² (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
     | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ }
     | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚‚ }
     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚‚ }
    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â‚
          | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚‚
          | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§ â†˜âŸ¦tâŸ§â‚
          | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§â‚‚ = record
                                { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚
                                ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§â‚‚
                                ; Tâ‰ˆTâ€² = ğ•Œ-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)
                                }
                              , record
                                { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚
                                ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâŸ§â‚‚
                                ; tâ‰ˆtâ€² = El-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) (ğ•Œ-trans Tâ‰ˆTâ€² (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)) tâ‰ˆtâ€² (El-sym Tâ‰ˆTâ€²â‚‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) tâ‰ˆtâ€²â‚‚)
                                }

rec-helper : âˆ€ {i}
             (âŠ¨Î“ : âŠ¨ Î“)
             (Ïâ‰ˆÏâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
             (TTâ€² : (Nâ‚€ âˆ· Î“) âŠ¨ T â‰ˆ Tâ€² âˆ¶[ 1 + i ] Se i) â†’
             (ssâ€² : Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ]) â†’
             (rrâ€² : (T â†™ i) âˆ· Nâ‚€ âˆ· Î“ âŠ¨ r â‰ˆ râ€² âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ]) â†’
             a â‰ˆ b âˆˆ Nat â†’
             -----------------------------------------------------
             let (_   , _   ) = TTâ€²
                 (âŠ¨Î“â‚‚ , sâ‰ˆsâ€²) = ssâ€²
                 (_   , _   ) = rrâ€²
                 re = projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²))
             in Î£ (RelTyp i T (Ï â†¦ a) T (Ïâ€² â†¦ b))
                  Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T â†™ i , (RelExp.âŸ¦tâŸ§ re) , r , Ï , a â†˜ aâ€²
                                     Ã— recâˆ™ Tâ€² â†™ i , (RelExp.âŸ¦tâ€²âŸ§ re) , râ€² , Ïâ€² , b â†˜ bâ€²
                                     Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
rec-helper {_} {Ï} {Ïâ€²} {T} {Tâ€²} {s} {sâ€²} {r} {râ€²} {i = i} âŠ¨Î“ Ïâ‰ˆÏâ€² (âˆ·-cong âŠ¨Î“â‚ Nrelâ‚ eq , Trelâ‚) (âŠ¨Î“â‚‚ , sâ‰ˆsâ€²) (âˆ·-cong (âˆ·-cong âŠ¨Î“â‚ƒ Nrelâ‚ƒ _) Trelâ‚ƒ _ , râ‰ˆrâ€²) aâ‰ˆb
  with Ïâ‰ˆÏâ€²â‚‚ â† âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€² = helper aâ‰ˆb
  where helper : a â‰ˆ b âˆˆ Nat â†’
                 let module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚))
                 in Î£ (RelTyp i T (Ï â†¦ a) T (Ïâ€² â†¦ b))
                      Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T â†™ i , re.âŸ¦tâŸ§ , r , Ï , a â†˜ aâ€²
                                         Ã— recâˆ™ Tâ€² â†™ i , re.âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , b â†˜ bâ€²
                                         Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {.ze} {.ze} ze
          with sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚
        ...  | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             = record
             { âŸ¦TâŸ§   = âŸ¦TâŸ§
             ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
             ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§
             ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
             ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
             }
             , _ , _
             , zeâ†˜
             , zeâ†˜
             , tâ‰ˆtâ€²

        helper {su a} {su b} (su aâ‰ˆb)
          with sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚ | helper aâ‰ˆb
        ...  | _ , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             | record { âŸ¦TâŸ§ = _ ; âŸ¦Tâ€²âŸ§ = _ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , aâ€² , bâ€² , â†˜aâ€² , â†˜bâ€² , aâ€²â‰ˆbâ€² = helper-su
          where Ïâ‰ˆÏâ€²â‚ƒ : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚ƒ âŸ§Ï
                Ïâ‰ˆÏâ€²â‚ƒ = âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ƒ Ïâ‰ˆÏâ€²

                aâ‰ˆbâ‚ƒ : a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ))
                aâ‰ˆbâ‚ƒ
                  with record { Tâ‰ˆTâ€² = Nâ€² } â† Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ = aâ‰ˆb

                aâ€²â‰ˆbâ€²â‚ƒ : (R : RelTyp _ T (Ï â†¦ a) T (Ïâ€² â†¦ b)) â†’ aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² R)
                aâ€²â‰ˆbâ€²â‚ƒ R
                  with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ƒ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ƒ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ƒ } â† R
                  rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ƒ â†˜âŸ¦TâŸ§
                        | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ƒ â†˜âŸ¦Tâ€²âŸ§ = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ƒ aâ€²â‰ˆbâ€²

                helper-su : Î£ (RelTyp i T (Ï â†¦ su a) T (Ïâ€² â†¦ su b))
                                Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T â†™ i , âŸ¦tâŸ§ , r , Ï , su a â†˜ aâ€² Ã— recâˆ™ Tâ€² â†™ i , âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , su b â†˜ bâ€² Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
                helper-su
                  with râ‰ˆrâ€² ((Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ) , aâ€²â‰ˆbâ€²â‚ƒ (Trelâ‚ƒ (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)))
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                     = record
                     { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                     ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                     ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                     }
                     , _ , _
                     , suâ†˜ â†˜aâ€² â†˜âŸ¦râŸ§
                     , suâ†˜ â†˜bâ€² â†˜âŸ¦râ€²âŸ§
                     , râ‰ˆrâ€²

        helper {â†‘ 0 N c} {â†‘ 0 N câ€²} (ne câ‰ˆcâ€²)
          with sâ‰ˆsâ€² Ïâ‰ˆÏâ€²â‚‚
        ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ze ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§ze ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²ze }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² } = helper-ne
          where Ïâ‰ˆÏâ€²â‚ : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï
                Ïâ‰ˆÏâ€²â‚ = âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²

                aâ‰ˆbâ‚ : {a b : D} â†’ a â‰ˆ b âˆˆ Nat â†’ a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ Ïâ‰ˆÏâ€²â‚))
                aâ‰ˆbâ‚ aâ‰ˆb
                  with record { Tâ‰ˆTâ€² = Nâ€² } â† Nrelâ‚ Ïâ‰ˆÏâ€²â‚ = aâ‰ˆb

                aâ‰ˆbâ‚â€² : â†‘ 0 N c â‰ˆ â†‘ 0 N câ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ Ïâ‰ˆÏâ€²â‚))
                aâ‰ˆbâ‚â€²
                  with record { Tâ‰ˆTâ€² = Nâ€² } â† Nrelâ‚ Ïâ‰ˆÏâ€²â‚ = ne câ‰ˆcâ€²

                helper-ne : Î£ (RelTyp i T (Ï â†¦ â†‘ 0 N c) T (Ïâ€² â†¦ â†‘ 0 N câ€²))
                                Î» rel â†’ âˆƒâ‚‚ Î» aâ€² bâ€² â†’ recâˆ™ T â†™ i , âŸ¦tâŸ§ , r , Ï , â†‘ 0 N c â†˜ aâ€²
                                                   Ã— recâˆ™ Tâ€² â†™ i , âŸ¦tâ€²âŸ§ , râ€² , Ïâ€² , â†‘ 0 N câ€² â†˜ bâ€²
                                                   Ã— (aâ€² â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
                helper-ne
                  with RelExp-refl (âˆ·-cong âŠ¨Î“â‚ Nrelâ‚ eq) Trelâ‚ {Ï â†¦ â†‘ 0 N c} {Ïâ€² â†¦ â†‘ 0 N câ€²} (Ïâ‰ˆÏâ€²â‚ , aâ‰ˆbâ‚â€²)
                     | Trelâ‚ {Ï â†¦ â†‘ 0 N c} {Ïâ€² â†¦ â†‘ 0 N câ€²} (Ïâ‰ˆÏâ€²â‚ , aâ‰ˆbâ‚â€²)
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚ _ }
                     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€² }
                     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚‚ _ }
                     , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²â‚ }
                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚))
                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚‚))
                     with refl â† âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§ = record
                                                   { âŸ¦TâŸ§   = _
                                                   ; âŸ¦Tâ€²âŸ§  = _
                                                   ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§
                                                   ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                                   ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                                                   }
                                                   , _ , _
                                                   , recâˆ™ â†˜âŸ¦TâŸ§â‚
                                                   , recâˆ™ â†˜âŸ¦Tâ€²âŸ§â‚
                                                   , El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² (BotâŠ†El Tâ‰ˆTâ€²â‚ bot-helper)
                  where bot-helper : rec (T â†™ i) âŸ¦tâŸ§ r Ï c â‰ˆ rec (Tâ€² â†™ i) âŸ¦tâ€²âŸ§ râ€² Ïâ€² câ€² âˆˆ Bot
                        bot-helper n
                          with câ‰ˆcâ€² n
                             | Trelâ‚ {_ â†¦ _} {_ â†¦ _} (Ïâ‰ˆÏâ€²â‚ , (aâ‰ˆbâ‚ (ne (Bot-l n))))
                             | Trelâ‚ {_ â†¦ _} {_ â†¦ _} (Ïâ‰ˆÏâ€²â‚ , (aâ‰ˆbâ‚ ze))
                        ...  | cc , câ†˜ , câ€²â†˜
                             | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚ƒ _ }
                             , record { âŸ¦tâŸ§ = âŸ¦TâŸ§n ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§n ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§n ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§n ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²ns }
                             | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚„ _ }
                             , record { âŸ¦tâŸ§ = âŸ¦TâŸ§zeâ‚ ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§zeâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§zeâ‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§zeâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²zeâ‚ }
                             rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚ƒ))
                             rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚„)) = bot-helperâ€²
                          where Ïâ‰ˆÏâ€²â‚ƒ : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚ƒ âŸ§Ï
                                Ïâ‰ˆÏâ€²â‚ƒ = âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ƒ Ïâ‰ˆÏâ€²

                                aâ‰ˆbâ‚ƒ : lâ€² 0 N n âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ))
                                aâ‰ˆbâ‚ƒ
                                  with record { Tâ‰ˆTâ€² = Nâ€² } â† Nrelâ‚ƒ Ïâ‰ˆÏâ€²â‚ƒ = ne (Bot-l n)

                                aâ€²â‰ˆbâ€²â‚ƒ : (R : RelTyp i T (Ï â†¦ lâ€² 0 N n) T (Ïâ€² â†¦ lâ€² 0 N n)) â†’
                                         lâ€² i âŸ¦TâŸ§n (1 + n) â‰ˆ lâ€² i âŸ¦Tâ€²âŸ§n (1 + n) âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² R)
                                aâ€²â‰ˆbâ€²â‚ƒ R
                                  with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ƒ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ƒ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ƒ } â† R
                                  rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ƒ â†˜âŸ¦TâŸ§n = El-one-sided Tâ‰ˆTâ€²ns Tâ‰ˆTâ€²â‚ƒ (BotâŠ†El Tâ‰ˆTâ€²ns (Bot-l (1 + n)))

                                bot-helperâ€² : âˆƒ Î» u â†’ Re n - rec (T â†™ i) âŸ¦tâŸ§ r Ï c â†˜ u
                                                    Ã— Re n - rec (Tâ€² â†™ i) âŸ¦tâ€²âŸ§ râ€² Ïâ€² câ€² â†˜ u
                                bot-helperâ€²
                                  with râ‰ˆrâ€² {_ â†¦ _} {_ â†¦ _} ((Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ) , aâ€²â‰ˆbâ€²â‚ƒ (Trelâ‚ƒ {_ â†¦ _} {_ â†¦ _} (Ïâ‰ˆÏâ€²â‚ƒ , aâ‰ˆbâ‚ƒ)))
                                     | Trelâ‚ {_ â†¦ _} {_ â†¦ _} (Ïâ‰ˆÏâ€²â‚ , (aâ‰ˆbâ‚ (su (ne (Bot-l n)))))
                                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§su ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§su ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²su }
                                     , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                                     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚† _ }
                                     , record { âŸ¦tâŸ§ = âŸ¦TâŸ§suâ‚ ; âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§suâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§suâ‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§suâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²suâ‚ }
                                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚†))
                                     rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§zeâ‚ â†˜âŸ¦TâŸ§ze
                                           | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§su â†˜âŸ¦TâŸ§suâ‚
                                        with ğ•ŒâŠ†TopT Tâ‰ˆTâ€²ns (1 + n)
                                           | ElâŠ†Top Tâ‰ˆTâ€²zeâ‚ (El-one-sided Tâ‰ˆTâ€²ze Tâ‰ˆTâ€²zeâ‚ sâ‰ˆsâ€²) n
                                           | ElâŠ†Top Tâ‰ˆTâ€²suâ‚ (El-one-sided Tâ‰ˆTâ€²su Tâ‰ˆTâ€²suâ‚ râ‰ˆrâ€²) (2 + n)
                                ...        | _ , Tnsâ†˜ , Tâ€²nsâ†˜
                                           | _ , Tzeâ†˜ , Tâ€²zeâ†˜
                                           | _ , Tsuâ†˜ , Tâ€²suâ†˜
                                          rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ze â†˜âŸ¦TâŸ§zeâ‚ = rec _ _ _ cc
                                                                        , Rr n â†˜âŸ¦TâŸ§n Tnsâ†˜ â†˜âŸ¦TâŸ§zeâ‚ Tzeâ†˜ â†˜âŸ¦râŸ§ â†˜âŸ¦TâŸ§suâ‚ Tsuâ†˜ câ†˜
                                                                        , Rr n â†˜âŸ¦Tâ€²âŸ§n Tâ€²nsâ†˜ â†˜âŸ¦Tâ€²âŸ§zeâ‚ Tâ€²zeâ†˜ â†˜âŸ¦râ€²âŸ§ â†˜âŸ¦Tâ€²âŸ§suâ‚ Tâ€²suâ†˜ câ€²â†˜

rec-congâ€² : âˆ€ {i} â†’
            Nâ‚€ âˆ· Î“ âŠ¨ T â‰ˆ Tâ€² âˆ¶[ 1 + i ] Se i â†’
            Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ] â†’
            (T â†™ i) âˆ· Nâ‚€ âˆ· Î“ âŠ¨ r â‰ˆ râ€² âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ] â†’
            Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶[ 0 ] N â†’
            ---------------------------------------------------
            Î“ âŠ¨ rec (T â†™ i) s r t â‰ˆ rec (Tâ€² â†™ i) sâ€² râ€² tâ€² âˆ¶[ i ] T [| t âˆ¶ Nâ‚€ ]
rec-congâ€² {_} {T} {Tâ€²} {s} {sâ€²} {r} {râ€²} {t} {tâ€²} {i = i} TTâ€²@(_ , _) ssâ€²@(âŠ¨Î“â‚‚ , sâ‰ˆsâ€²) rrâ€²@(_ , _) ttâ€²@(âŠ¨Î“â‚„ , tâ‰ˆtâ€²) = âŠ¨Î“â‚„ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚„ âŸ§Ï â†’
             -----------------------------------------------------------------------------
             Î£ (RelTyp _ (T [| t âˆ¶ Nâ‚€ ]) Ï (T [| t âˆ¶ Nâ‚€ ]) Ïâ€²)
             Î» rel â†’ RelExp (rec (T â†™ i) s r t) Ï (rec (Tâ€² â†™ i) sâ€² râ€² tâ€²) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with RelExp-refl âŠ¨Î“â‚„ tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
         | tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = N refl }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
         | record { Tâ‰ˆTâ€² = N refl }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
       with rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² TTâ€² ssâ€² rrâ€² tâ‰ˆtâ€²
          | rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² TTâ€² ssâ€² rrâ€² tâ‰ˆtâ€²â‚
    ...   | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
          , res , resâ€² , â†˜res , â†˜resâ€² , resâ‰ˆresâ€²
          | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ }
          , resâ‚ , resâ€²â‚ , â†˜resâ‚ , â†˜resâ€²â‚ , resâ‰ˆresâ€²â‚
        rewrite âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦tâŸ§
              | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§ = record
                                  { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§) â†˜âŸ¦TâŸ§
                                  ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâ€²âŸ§) â†˜âŸ¦Tâ€²âŸ§
                                  ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                  }
                                , record
                                  { â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâŸ§ â†˜âŸ¦tâŸ§ â†˜resâ‚
                                  ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§â‚ â†˜resâ€²â‚
                                  ; tâ‰ˆtâ€² = El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² resâ‰ˆresâ€²â‚
                                  }
      where
        module sâ‰ˆsâ€² = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î“â‚„ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²)))

rec-Î²-zeâ€²   : âˆ€ {i} â†’
              Nâ‚€ âˆ· Î“ âŠ¨ T âˆ¶[ 1 + i ] Se i â†’
              Î“ âŠ¨ s âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ] â†’
              (T â†™ i) âˆ· Nâ‚€ âˆ· Î“ âŠ¨ r âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ] â†’
              ---------------------------------------------
              Î“ âŠ¨ rec (T â†™ i) s r ze â‰ˆ s âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ]
rec-Î²-zeâ€² {_} {T} {s} {r} {i = i} âŠ¨T âŠ¨s@(âŠ¨Î“ , sâ‰ˆsâ€²) âŠ¨r = âŠ¨Î“ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             -------------------------------------------------------------
             Î£ (RelTyp _ (T [| ze âˆ¶ Nâ‚€ ]) Ï (T [| ze âˆ¶ Nâ‚€ ]) Ïâ€²)
             Î» rel â†’ RelExp (rec (T â†™ i) s r ze) Ï s Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with Trel , srel â† sâ‰ˆsâ€² Ïâ‰ˆÏâ€² = Trel
                                   , record
                                     { RelExp srel
                                     ; â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ (RelExp.â†˜âŸ¦tâŸ§ srel) âŸ¦zeâŸ§ zeâ†˜
                                     }

rec-Î²-suâ€² : âˆ€ {i} â†’
            Nâ‚€ âˆ· Î“ âŠ¨ T âˆ¶[ 1 + i ] Se i â†’
            Î“ âŠ¨ s âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ] â†’
            (T â†™ i) âˆ· Nâ‚€ âˆ· Î“ âŠ¨ r âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ] â†’
            Î“ âŠ¨ t âˆ¶[ 0 ] N â†’
            -----------------------------------------------------------------
            Î“ âŠ¨ rec (T â†™ i) s r (su t) â‰ˆ r [ (I , t âˆ¶ Nâ‚€) , rec (T â†™ i) s r t âˆ¶ T â†™ i ] âˆ¶[ i ] T [| su t âˆ¶ Nâ‚€ ]
rec-Î²-suâ€² {_} {T} {s} {r} {t} {i = i} âŠ¨T@(_ , _) âŠ¨s@(âŠ¨Î“â‚‚ , sâ‰ˆsâ€²) âŠ¨r@(_ , _) (âŠ¨Î“â‚„ , tâ‰ˆtâ€²) = âŠ¨Î“â‚„ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚„ âŸ§Ï â†’
             -----------------------------------------------------------------------------------------------
             Î£ (RelTyp _ (T [| su t âˆ¶ Nâ‚€ ]) Ï (T [| su t âˆ¶ Nâ‚€ ]) Ïâ€²)
             Î» rel â†’ RelExp (rec (T â†™ i) s r (su t)) Ï (r [ (I , t âˆ¶ Nâ‚€) , rec (T â†™ i) s r t âˆ¶ T â†™ i ]) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper Ïâ‰ˆÏâ€²
      with tâ‰ˆtâ€² Ïâ‰ˆÏâ€²
    ...  | record { Tâ‰ˆTâ€² = N refl }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
        with rec-helper âŠ¨Î“â‚„ Ïâ‰ˆÏâ€² âŠ¨T âŠ¨s âŠ¨r (su tâ‰ˆtâ€²)
    ...    | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
           , res , resâ€² , â†˜res , suâ†˜ â†˜resâ€² â†˜r , resâ‰ˆresâ€² = record
                                              { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâŸ§)) â†˜âŸ¦TâŸ§
                                              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                              ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                              }
                                            , record
                                              { â†˜âŸ¦tâŸ§ = âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâŸ§ (âŸ¦suâŸ§ â†˜âŸ¦tâŸ§) â†˜res
                                              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâ€²âŸ§) (âŸ¦recâŸ§ sâ‰ˆsâ€².â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ â†˜resâ€²)) â†˜r
                                              ; tâ‰ˆtâ€² = resâ‰ˆresâ€²
                                              }
      where
        module sâ‰ˆsâ€² = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î“â‚„ âŠ¨Î“â‚‚ Ïâ‰ˆÏâ€²)))


N-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        -----------------------
        Î“ âŠ¨ N [ Ïƒ ] â‰ˆ N âˆ¶[ 1 ] Se 0
N-[]â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 --------------------------------------------------
                 Î£ (RelTyp _ (Se 0) Ï (Se 0) Ïâ€²)
                 Î» rel â†’ RelExp (N [ Ïƒ ]) Ï N Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€² = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ _
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _
                        ; Tâ‰ˆTâ€²  = Uâ€²
                        }
                    , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ âŸ¦NâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦NâŸ§
                        ; tâ‰ˆtâ€²  = N refl
                        }
          where module Ïƒ = RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


ze-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
         ----------------------
         Î“ âŠ¨ ze [ Ïƒ ] â‰ˆ ze âˆ¶[ 0 ] N
ze-[]â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 ------------------------------------------------------------
                 Î£ (RelTyp 0 N Ï N Ïâ€²)
                 Î» rel â†’ RelExp (ze [ Ïƒ ]) Ï ze Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper Ïâ‰ˆÏâ€² = record
                        { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                        ; Tâ‰ˆTâ€²  = N refl
                        }
                    , record
                        { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ âŸ¦zeâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦zeâŸ§
                        ; tâ‰ˆtâ€²  = ze
                        }
          where module Ïƒ = RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


su-[]â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
         Î” âŠ¨ t âˆ¶[ 0 ] N â†’
         ----------------------------------
         Î“ âŠ¨ su t [ Ïƒ ] â‰ˆ su (t [ Ïƒ ]) âˆ¶[ 0 ] N
su-[]â€² {_} {Ïƒ} {_} {t} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨t) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
                 -------------------------------------------------------------------------
                 Î£ (RelTyp 0 N Ï N Ïâ€²)
                 Î» rel â†’ RelExp (su t [ Ïƒ ]) Ï (su (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubst (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp _ N Ï N Ïâ€²)
                       Î» rel â†’ RelExp (su t [ Ïƒ ]) Ï (su (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
                help
                  with âŠ¨t (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦NâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§ ; Tâ‰ˆTâ€² = N refl }
                     , re = record
                              { â†˜âŸ¦TâŸ§  = âŸ¦NâŸ§
                              ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦NâŸ§
                              ; Tâ‰ˆTâ€²  = N refl
                              }
                          , record
                              { â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦suâŸ§ re.â†˜âŸ¦tâŸ§)
                              ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦suâŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ re.â†˜âŸ¦tâ€²âŸ§)
                              ; tâ‰ˆtâ€²  = su re.tâ‰ˆtâ€²
                              }
                  where module re = RelExp re

-- We need one more separate helper for rec-[]â€² other than rec-helper,
-- because rec-helper does not allow us to use two inequivalent environments:
-- Ï and (Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏ).âŸ¦ÏƒâŸ§
rec-[]â€²-helper : âˆ€ {res i} â†’
                 (âŠ¨Î“ : âŠ¨ Î“) â†’
                 (âŠ¨Ïƒ : Î“ âŠ¨s Ïƒ âˆ¶ Î”) â†’
                 (Ïâ‰ˆÏ : Ï âˆˆâ€² âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
                 (âŠ¨T : (Nâ‚€ âˆ· Î”) âŠ¨ T âˆ¶[ 1 + i ] Se i) â†’
                 (âŠ¨s : Î” âŠ¨ s âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ]) â†’
                 (âŠ¨r : (T â†™ i) âˆ· Nâ‚€ âˆ· Î” âŠ¨ r âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ]) â†’
                 a âˆˆâ€² Nat â†’
                 let (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Ïƒ
                     rs = Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
                     (_   , _)    = âŠ¨T
                     (âŠ¨Î”â‚ƒ , sâ‰ˆsâ€²) = âŠ¨s
                     (_   , _)    = âŠ¨r
                     re = projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ (RelSubst.Ïƒâ‰ˆÎ´ rs))) in
                 recâˆ™ T â†™ i , (RelExp.âŸ¦tâŸ§ re) , r , (RelSubst.âŸ¦ÏƒâŸ§ rs) , a â†˜ res â†’
                 -----------------------------------------------------------------------------------------
                 âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Nâ‚€ Ïƒ ] â†™ i) , RelExp.âŸ¦tâŸ§ re , (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) , Ï , a â†˜ resâ€²
                          Ã— Î£ (RelTyp i T (RelSubst.âŸ¦ÏƒâŸ§ rs â†¦ a) T (RelSubst.âŸ¦ÏƒâŸ§ rs â†¦ a))
                            Î» rel â†’ res â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel)
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {ze} {i = i} âŠ¨Î“ (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ (âˆ·-cong âŠ¨Î”â‚‚ Nrelâ‚‚ _ , _) (âŠ¨Î”â‚ƒ , sâ‰ˆsâ€²) âŠ¨r@(_ , _) ze zeâ†˜
  with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
    rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§
      with sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)
...      | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
         , record { tâ‰ˆtâ€² = tâ‰ˆtâ€² } = _ , zeâ†˜
                                  , record
                                   { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                                   ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                   ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                   }
                                 , El-refl Tâ‰ˆTâ€² tâ‰ˆtâ€²
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {su a} {res} {i} âŠ¨Î“ âŠ¨Ïƒ@(âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ âŠ¨T@(_ , _) âŠ¨s@(âŠ¨Î”â‚ƒ , sâ‰ˆsâ€²) âŠ¨r@(âˆ·-cong (âˆ·-cong âŠ¨Î”â‚„ Nrelâ‚„ _) Trelâ‚„ _ , râ‰ˆrâ€²) (su aâ‰ˆa) (suâ†˜ {bâ€² = b} â†˜res â†˜r)
  with rec-[]â€²-helper âŠ¨Î“ âŠ¨Ïƒ Ïâ‰ˆÏ âŠ¨T âŠ¨s âŠ¨r aâ‰ˆa â†˜res
...  | bâ€² , â†˜bâ€² , record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² } , bâ‰ˆbâ€²
    with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
      rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§ = helper
  where
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ : âŸ¦ÏƒâŸ§ â‰ˆ âŸ¦ÏƒâŸ§ âˆˆ âŸ¦ âŠ¨Î”â‚„ âŸ§Ï
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´

    aâ‰ˆaâ‚„ : a âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§))
    aâ‰ˆaâ‚„
      with record { Tâ‰ˆTâ€² = N refl } â† Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ = aâ‰ˆa

    bâ‰ˆbâ€²â‚„ : (R : RelTyp _ T (âŸ¦ÏƒâŸ§ â†¦ a) T (âŸ¦ÏƒâŸ§ â†¦ a)) â†’  b â‰ˆ bâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² R)
    bâ‰ˆbâ€²â‚„ record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ }
      rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚„ â†˜âŸ¦TâŸ§
            | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚„ â†˜âŸ¦Tâ€²âŸ§ = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚„ bâ‰ˆbâ€²

    module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)))

    helper : âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Nâ‚€ Ïƒ ] â†™ i) , re.âŸ¦tâŸ§ , (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) , Ï , su a â†˜ resâ€²
                      Ã— Î£ (RelTyp i T (âŸ¦ÏƒâŸ§ â†¦ su a) T (âŸ¦ÏƒâŸ§ â†¦ su a))
                        Î» rel â†’ res â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel)
    helper
      with râ‰ˆrâ€² {_ â†¦ _} {_ â†¦ _} ((âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ , aâ‰ˆaâ‚„) , bâ‰ˆbâ€²â‚„ (Trelâ‚„ (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§ , aâ‰ˆaâ‚„)))
    ... | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ }
        , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
        rewrite âŸ¦âŸ§-det â†˜r â†˜âŸ¦râŸ§ = _ , suâ†˜ â†˜bâ€² (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§)) â†˜âŸ¦râ€²âŸ§)
                               , record
                                 { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„
                                 ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„
                                 ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„
                                 }
                               , râ‰ˆrâ€²
rec-[]â€²-helper {_} {Ïƒ} {_} {Ï} {T} {s} {r} {â†‘ 0 N c} {â†‘ _ Tâ€² (rec _ _ _ _ _)} {i} âŠ¨Î“ (âŠ¨Î“â‚ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) Ïâ‰ˆÏ (âˆ·-cong âŠ¨Î”â‚‚ Nrelâ‚‚ _ , Trelâ‚‚) (âŠ¨Î”â‚ƒ , sâ‰ˆsâ€²) (âˆ·-cong (âˆ·-cong âŠ¨Î”â‚„ Nrelâ‚„ _) Trelâ‚„ _ , râ‰ˆrâ€²) (ne câ‰ˆc) (recâˆ™ Tâ†˜)
  with record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏ)
    rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§ â†˜âŸ¦ÏƒâŸ§ = helper
  where
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ : drop (âŸ¦ÏƒâŸ§ â†¦ â†‘ 0 N c) âˆˆâ€² âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï
    âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´

    â†‘Ncâ‰ˆâ†‘Nc : â†‘ 0 N c âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚))
    â†‘Ncâ‰ˆâ†‘Nc
      with record { Tâ‰ˆTâ€² = N refl } â† Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ = ne câ‰ˆc

    module re = RelExp (projâ‚‚ (sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)))

    helper : âˆƒ Î» resâ€² â†’ recâˆ™ (T [ q Nâ‚€ Ïƒ ] â†™ i) , re.âŸ¦tâŸ§ , (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) , Ï , â†‘ 0 N c â†˜ resâ€²
                      Ã— Î£ (RelTyp i T (âŸ¦ÏƒâŸ§ â†¦ â†‘ 0 N c) T (âŸ¦ÏƒâŸ§ â†¦ â†‘ 0 N c))
                          (Î» rel â†’ â†‘ _ Tâ€² (rec (T â†™ i) re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c) â‰ˆ resâ€² âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper
      with Trelâ‚‚ {_ â†¦ _} {_ â†¦ _} (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ , â†‘Ncâ‰ˆâ†‘Nc)
    ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚ _ }
         , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€² }
        rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚))
          with refl â† âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦TâŸ§
             | refl â† âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ Tâ†˜                = _ , recâˆ™ (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§) Tâ†˜)
                                                    , record
                                                      { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
                                                      ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§
                                                      ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                                      }
                                                    , BotâŠ†El Tâ‰ˆTâ€² bot-helper
      where
        bot-helper : rec (T â†™ i) re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c â‰ˆ rec (T [ q Nâ‚€ Ïƒ ] â†™ i) re.âŸ¦tâŸ§ (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) Ï c âˆˆ Bot
        bot-helper n
          with câ‰ˆc n
        ...  | _ , â†˜c , _ = bot-helperâ€²
          where
            âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚â€² : âŸ¦ÏƒâŸ§ â‰ˆ âŸ¦ÏƒâŸ§ âˆˆ âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï
            âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚â€² = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´

            aâ‰ˆbâ‚‚ : âˆ€ {a b} â†’ a â‰ˆ b âˆˆ Nat â†’ a â‰ˆ b âˆˆ El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚â€²))
            aâ‰ˆbâ‚‚ {a} {b} aâ‰ˆb
              with record { Tâ‰ˆTâ€² = N refl } â† Nrelâ‚‚ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚â€² = aâ‰ˆb

            bot-helperâ€² : âˆƒ Î» u â†’ Re n - rec (T â†™ i) re.âŸ¦tâŸ§ r âŸ¦ÏƒâŸ§ c â†˜ u
                                Ã— Re n - rec (T [ q Nâ‚€ Ïƒ ] â†™ i) re.âŸ¦tâŸ§ (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) Ï c â†˜ u
            bot-helperâ€²
              with Trelâ‚‚ {_ â†¦ _} {_ â†¦ _} (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ , (aâ‰ˆbâ‚‚ (ne (Bot-l n))))
                 | sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚ƒ Ïƒâ‰ˆÎ´)
                 | Trelâ‚‚ {_ â†¦ _} {_ â†¦ _} (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ , (aâ‰ˆbâ‚‚ ze))
            ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚‚ _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§n ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§n ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²ns }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦[|ze]âŸ§ â†˜âŸ¦TâŸ§ze ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²ze }
                 , record { âŸ¦tâŸ§ = âŸ¦sâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
                 | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚ƒ _ }
                 , record { âŸ¦tâŸ§ = âŸ¦TâŸ§zeâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§zeâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²zeâ‚ }
                 rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚‚))
                       | ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚ƒ))
                       | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§zeâ‚ â†˜âŸ¦TâŸ§ze
                       with ğ•ŒâŠ†TopT Tâ‰ˆTâ€²ns (1 + n)
                          | ElâŠ†Top Tâ‰ˆTâ€²zeâ‚ (El-one-sided Tâ‰ˆTâ€²ze Tâ‰ˆTâ€²zeâ‚ sâ‰ˆsâ€²) n
            ...           | _ , Tnsâ†˜ , Tâ€²nsâ†˜
                          | _ , Tzeâ†˜ , Tâ€²zeâ†˜
                         rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ze â†˜âŸ¦TâŸ§zeâ‚ = bot-helperâ€³
              where
                âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ : âŸ¦ÏƒâŸ§ âˆˆâ€² âŸ¦ âŠ¨Î”â‚„ âŸ§Ï
                âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ = âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´

                aâ‰ˆbâ‚„ : lâ€² 0 N n âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„))
                aâ‰ˆbâ‚„
                  with record { Tâ‰ˆTâ€² = N refl } â† Nrelâ‚„ âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ = ne (Bot-l n)

                aâ€²â‰ˆbâ€²â‚„ : (R : RelTyp i T (âŸ¦ÏƒâŸ§ â†¦ lâ€² 0 N n) T (âŸ¦ÏƒâŸ§ â†¦ lâ€² 0 N n)) â†’ lâ€² i âŸ¦TâŸ§n (1 + n) âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² R)
                aâ€²â‰ˆbâ€²â‚„ R
                  with record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚„ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚„ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚„ } â† R
                    rewrite âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚„ â†˜âŸ¦TâŸ§â‚„
                          | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚„ â†˜âŸ¦TâŸ§n = BotâŠ†El Tâ‰ˆTâ€²â‚„ (Bot-l (1 + n))

                bot-helperâ€³ : âˆƒ Î» u â†’ Re n - rec (T â†™ i) âŸ¦sâŸ§ r âŸ¦ÏƒâŸ§ c â†˜ u
                                Ã— Re n - rec (T [ q Nâ‚€ Ïƒ ] â†™ i) âŸ¦sâŸ§ (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) Ï c â†˜ u
                bot-helperâ€³
                  with râ‰ˆrâ€² {_ â†¦ _} {_ â†¦ _} ((âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ , aâ‰ˆbâ‚„) , aâ€²â‰ˆbâ€²â‚„ (Trelâ‚„ {_ â†¦ _} {_ â†¦ _} (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚„ , aâ‰ˆbâ‚„)))
                     | Trelâ‚‚ {_ â†¦ _} {_ â†¦ _} (âŸ¦ÏƒâŸ§â‰ˆâŸ¦ÏƒâŸ§â‚‚ , (aâ‰ˆbâ‚‚ (su (ne (Bot-l n)))))
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦[[wkâˆ˜wk],su[v1]]âŸ§ â†˜âŸ¦TâŸ§su ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²su }
                     , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
                     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U eqâ‚„ _ }
                     , record { âŸ¦tâŸ§ = âŸ¦TâŸ§suâ‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§suâ‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²suâ‚ }
                    rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ (â‰¤-reflexive (sym eqâ‚„))
                          | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§su â†˜âŸ¦TâŸ§suâ‚
                          with ElâŠ†Top Tâ‰ˆTâ€²suâ‚ (El-one-sided Tâ‰ˆTâ€²su Tâ‰ˆTâ€²suâ‚ râ‰ˆrâ€²) (2 + n)
                ...          | _ , Tsuâ†˜ , Tâ€²suâ†˜ = _
                                                , Rr n â†˜âŸ¦TâŸ§n Tnsâ†˜ â†˜âŸ¦TâŸ§zeâ‚ Tzeâ†˜ â†˜âŸ¦râŸ§ â†˜âŸ¦TâŸ§suâ‚ Tsuâ†˜ â†˜c
                                                , Rr n
                                                     (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§) â†˜âŸ¦TâŸ§n)
                                                     Tnsâ†˜
                                                     (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§) â†˜âŸ¦TâŸ§zeâ‚)
                                                     Tzeâ†˜
                                                     (âŸ¦[]âŸ§ (âŸ¦qâŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§)) â†˜âŸ¦râŸ§) (âŸ¦[]âŸ§ (âŸ¦qâŸ§ â†˜âŸ¦ÏƒâŸ§) â†˜âŸ¦TâŸ§suâ‚)
                                                     Tsuâ†˜
                                                     â†˜c

rec-[]â€² : âˆ€ {i} â†’
          Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
          Nâ‚€ âˆ· Î” âŠ¨ T âˆ¶[ 1 + i ] Se i â†’
          Î” âŠ¨ s âˆ¶[ i ] T [| ze âˆ¶ Nâ‚€ ] â†’
          (T â†™ i) âˆ· Nâ‚€ âˆ· Î” âŠ¨ r âˆ¶[ i ] T [ (wk âˆ˜ wk) , su (v 1) âˆ¶ Nâ‚€ ] â†’
          Î” âŠ¨ t âˆ¶[ 0 ] N â†’
          -------------------------------------------------------------------------------------------------
          Î“ âŠ¨ rec (T â†™ i) s r t [ Ïƒ ] â‰ˆ rec (T [ q Nâ‚€ Ïƒ ] â†™ i) (s [ Ïƒ ]) (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) (t [ Ïƒ ]) âˆ¶[ i ] T [ Ïƒ , t [ Ïƒ ] âˆ¶ Nâ‚€ ]
rec-[]â€² {_} {Ïƒ} {_} {T} {s} {r} {t} {i = i} âŠ¨Ïƒ@(âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) âŠ¨T@(_ , _) âŠ¨s@(âŠ¨Î”â‚‚ , sâ‰ˆsâ€²) âŠ¨r@(âˆ·-cong (âˆ·-cong âŠ¨Î”â‚ƒ Nrelâ‚ƒ _) Trelâ‚ƒ _ , râ‰ˆrâ€²) (âŠ¨Î”â‚„ , tâ‰ˆtâ€²) = âŠ¨Î“ , helper
  where
    helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
             -----------------------------------------------------------------------------------------------------------------------
             Î£ (RelTyp i (T [ Ïƒ , t [ Ïƒ ] âˆ¶ Nâ‚€ ]) Ï (T [ Ïƒ , t [ Ïƒ ] âˆ¶ Nâ‚€ ]) Ïâ€²)
             Î» rel â†’ RelExp (rec (T â†™ i) s r t [ Ïƒ ]) Ï (rec (T [ q Nâ‚€ Ïƒ ] â†™ i) (s [ Ïƒ ]) (r [ q (T â†™ i) (q Nâ‚€ Ïƒ) ]) (t [ Ïƒ ])) Ïâ€² (El _ (RelTyp.Tâ‰ˆTâ€² rel))
    helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
      with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
        with tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚„ Ïƒâ‰ˆÎ´)
    ...    | record { Tâ‰ˆTâ€² = N refl }
           , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
          with rec-helper âŠ¨Î” Ïƒâ‰ˆÎ´ âŠ¨T âŠ¨s âŠ¨r tâ‰ˆtâ€²
             | âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
    ...      | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
             , res , resâ€² , â†˜res , â†˜resâ€² , resâ‰ˆresâ€²
             | Ïâ€²â‰ˆÏâ€²
            with record { â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦Î´âŸ§â‚ ; Ïƒâ‰ˆÎ´ = Î´â‰ˆÎ´ } â† Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“ Ïâ€²â‰ˆÏâ€²)
               | rec-[]â€²-helperâ€² â† rec-[]â€²-helper {res = resâ€²} âŠ¨Î“ âŠ¨Ïƒ Ïâ€²â‰ˆÏâ€² âŠ¨T âŠ¨s âŠ¨r (El-refl (N refl) (El-symâ€² (N refl) tâ‰ˆtâ€²))
              with sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î” âŠ¨Î”â‚‚ Ïƒâ‰ˆÎ´)
                 | sâ‰ˆsâ€² (âŸ¦âŸ§Ï-one-sided âŠ¨Î” âŠ¨Î”â‚‚ Î´â‰ˆÎ´)
    ...          | _ , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâ€²âŸ§ ; tâ‰ˆtâ€² = sâ‰ˆsâ€² }
                 | _ , record { â†˜âŸ¦tâŸ§ = â†˜âŸ¦sâ€²âŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦sâŸ§â‚ ; tâ‰ˆtâ€² = sâ‰ˆs }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦Î´âŸ§â‚ â†˜âŸ¦Î´âŸ§
                      | âŸ¦âŸ§-det â†˜âŸ¦sâ€²âŸ§â‚ â†˜âŸ¦sâ€²âŸ§
                  with rec-[]â€²-helperâ€² â†˜resâ€²
    ...              | _
                     , â†˜resâ€²â‚
                     , record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²â‚ } , resâ€²â‰ˆresâ€²â‚
                    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦Tâ€²âŸ§
                          | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦Tâ€²âŸ§ = record
                                                 { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§)) â†˜âŸ¦TâŸ§
                                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)) â†˜âŸ¦Tâ€²âŸ§
                                                 ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€²
                                                 }
                                               , record
                                                 { â†˜âŸ¦tâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ (âŸ¦recâŸ§ â†˜âŸ¦sâŸ§ â†˜âŸ¦tâŸ§ â†˜res)
                                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦recâŸ§ (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦sâ€²âŸ§) (âŸ¦[]âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§) â†˜resâ€²â‚
                                                 ; tâ‰ˆtâ€² = El-transâ€² Tâ‰ˆTâ€² resâ‰ˆresâ€² (El-one-sidedâ€² Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² resâ€²â‰ˆresâ€²â‚)
                                                 }
