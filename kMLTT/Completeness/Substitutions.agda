{-# OPTIONS --without-K --safe #-}

open import Level using ()
open import Axiom.Extensionality.Propositional

module kMLTT.Completeness.Substitutions (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Lib
open import kMLTT.Completeness.LogRel

open import kMLTT.Semantics.Properties.Domain fext
open import kMLTT.Semantics.Properties.PER fext


I-â‰ˆâ€² : âŠ¨ Î“ â†’
       --------------
       Î“ âŠ¨s I â‰ˆ I âˆ¶ Î“
I-â‰ˆâ€² âŠ¨Î“ = âŠ¨Î“ , âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelSubsts I Ï I Ïâ€² âŸ¦ âŠ¨Î“ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { âŸ¦ÏƒâŸ§  = _
          ; âŸ¦Î´âŸ§  = _
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦IâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦IâŸ§
          ; Ïƒâ‰ˆÎ´  = Ïâ‰ˆÏâ€²
          ; nat  = Î» Îº â†’ âŸ¦IâŸ§
          ; natâ€² = Î» Îº â†’ âŸ¦IâŸ§
          }


-- p-cong    : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ T âˆº Î” â†’
--             ----------------------
--             Î“ âŠ¨s p Ïƒ â‰ˆ p Ïƒâ€² âˆ¶ Î”


âˆ˜-congâ€² : Î“ âŠ¨s Ï„ â‰ˆ Ï„â€² âˆ¶ Î“â€² â†’
          Î“â€² âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î“â€³ â†’
          ----------------
          Î“ âŠ¨s Ïƒ âˆ˜ Ï„ â‰ˆ Ïƒâ€² âˆ˜ Ï„â€² âˆ¶ Î“â€³
âˆ˜-congâ€² {_} {Ï„} {Ï„â€²} {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î“ , âŠ¨Î“â€² , Ï„â‰ˆÏ„â€²) (âŠ¨Î“â€²â‚ , âŠ¨Î“â€³ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , âŠ¨Î“â€³ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelSubsts (Ïƒ âˆ˜ Ï„) Ï (Ïƒâ€² âˆ˜ Ï„â€²) Ïâ€² âŸ¦ âŠ¨Î“â€³ âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { âŸ¦ÏƒâŸ§  = Ïƒ.âŸ¦ÏƒâŸ§
          ; âŸ¦Î´âŸ§  = Ïƒ.âŸ¦Î´âŸ§
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§
          ; Ïƒâ‰ˆÎ´  = Ïƒ.Ïƒâ‰ˆÎ´
          ; nat  = Î» Îº â†’ âŸ¦âˆ˜âŸ§ (Ï„.nat Îº) (Ïƒ.nat Îº)
          ; natâ€² = Î» Îº â†’ âŸ¦âˆ˜âŸ§ (Ï„.natâ€² Îº) (Ïƒ.natâ€² Îº)
          }
          where module Ï„ = RelSubsts (Ï„â‰ˆÏ„â€² Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubsts (Ïƒâ‰ˆÏƒâ€² (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ï„.Ïƒâ‰ˆÎ´))

,-congâ€² : âˆ€ {i} â†’
          Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
          Î” âŠ¨ T âˆ¶ Se i â†’
          Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ (T [ Ïƒ ]) â†’
          -----------------------------
          Î“ âŠ¨s Ïƒ , t â‰ˆ Ïƒâ€² , tâ€² âˆ¶ (T âˆº Î”)
,-congâ€² {_} {Ïƒ} {Ïƒâ€²} {_} {T} {t} {tâ€²} (âŠ¨Î“ , âŠ¨Î” , Ïƒâ‰ˆÏƒâ€²) ((âŠ¨Î”â‚ , rel) , âŠ¨T) ((âŠ¨Î“â‚ , relâ€²) , tâ‰ˆtâ€²) = âŠ¨Î“ , âˆ·-cong âŠ¨Î” helper , helperâ€²
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î” âŸ§Ï â†’ RelTyp T Ï T Ïâ€²
        helper Ïâ‰ˆÏâ€²
          with âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïâ‰ˆÏâ€²
        ...  | Ïâ‰ˆÏâ€²â‚
             with rel Ïâ‰ˆÏâ€²â‚ | âŠ¨T Ïâ‰ˆÏâ€²â‚
        ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ ._ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ ._ ; Tâ‰ˆTâ€² = i , U j<i eq }
                | res
                rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i = RelExpâ‡’RepTypâ€² res

        helperâ€² : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelSubsts (Ïƒ , t) Ï (Ïƒâ€² , tâ€²) Ïâ€² âŸ¦ âˆ·-cong âŠ¨Î” helper âŸ§Ï
        helperâ€² {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²
        ...  | Ïâ‰ˆÏâ€²â‚
             with Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€² | relâ€² Ïâ‰ˆÏâ€²â‚ | tâ‰ˆtâ€² Ïâ‰ˆÏâ€²â‚
        ...     | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§ ; âŸ¦Î´âŸ§ = âŸ¦Î´âŸ§ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§ ; Ïƒâ‰ˆÎ´ = Ïƒâ‰ˆÎ´ ; nat = natâ‚ ; natâ€² = natâ€²â‚ }
                | record { â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = i , Tâ‰ˆTâ€² }
                | record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² ; nat = nat ; natâ€² = natâ€² }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦ÏƒâŸ§
                with substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î” âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) Ïƒâ‰ˆÎ´
        ...        | Ïƒâ‰ˆÎ´â‚ = record
            { âŸ¦ÏƒâŸ§  = âŸ¦ÏƒâŸ§ â†¦ âŸ¦tâŸ§
            ; âŸ¦Î´âŸ§  = âŸ¦Î´âŸ§ â†¦ âŸ¦tâ€²âŸ§
            ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦,âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§
            ; â†˜âŸ¦Î´âŸ§ = âŸ¦,âŸ§ â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§
            ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´â‚ , tâ‰ˆtâ€²â‚
            ; nat  = Î» Îº â†’ subst (âŸ¦ Ïƒ , t âŸ§s Ï [ Îº ] â†˜_) (sym (â†¦-mon âŸ¦ÏƒâŸ§ âŸ¦tâŸ§ Îº)) (âŸ¦,âŸ§ (natâ‚ Îº) (nat Îº))
            ; natâ€² = Î» Îº â†’ subst (âŸ¦ Ïƒâ€² , tâ€² âŸ§s Ïâ€² [ Îº ] â†˜_) (sym (â†¦-mon âŸ¦Î´âŸ§ âŸ¦tâ€²âŸ§ Îº)) (âŸ¦,âŸ§ (natâ€²â‚ Îº) (natâ€² Îº))
            }
            where tâ‰ˆtâ€²â‚ : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ Elâˆ (RelTyp.Tâ‰ˆTâ€² (helper Ïƒâ‰ˆÎ´â‚))
                  tâ‰ˆtâ€²â‚
                    with âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒâ‰ˆÎ´â‚
                  ...  | Ïƒâ‰ˆÎ´â‚‚
                       with rel Ïƒâ‰ˆÎ´â‚‚ | âŠ¨T Ïƒâ‰ˆÎ´â‚‚
                  ...     | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ ._ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ ._ ; Tâ‰ˆTâ€² = i , U j<i _ }
                          | record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
                          rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ j<i
                          with subst (âŸ¦ T âŸ§_â†˜ âŸ¦tâŸ§â‚) (drop-â†¦ âŸ¦ÏƒâŸ§ âŸ¦tâŸ§) â†˜âŸ¦tâŸ§â‚
                  ...        | â†˜âŸ¦tâŸ§â‚‚
                             rewrite âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚‚ â†˜âŸ¦TâŸ§ = El-one-sided Tâ‰ˆTâ€² tâ‰ˆtâ€²â‚ tâ‰ˆtâ€²

-- ï¼›-cong    : âˆ€ {n} Î¨s â†’
--             Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
--             âŠ¨ Î¨s ++âº Î“ â†’
--             len Î¨s â‰¡ n â†’
--             --------------------------------------
--             Î¨s ++âº Î“ âŠ¨s Ïƒ ï¼› n â‰ˆ Ïƒâ€² ï¼› n âˆ¶ [] âˆ·âº Î”


I-âˆ˜â€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s I âˆ˜ Ïƒ â‰ˆ Ïƒ âˆ¶ Î”
I-âˆ˜â€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelSubsts (I âˆ˜ Ïƒ) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { âŸ¦ÏƒâŸ§  = âŸ¦ÏƒâŸ§
          ; âŸ¦Î´âŸ§  = âŸ¦Î´âŸ§
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ â†˜âŸ¦ÏƒâŸ§ âŸ¦IâŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§
          ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´
          ; nat  = Î» Îº â†’ âŸ¦âˆ˜âŸ§ (nat Îº) âŸ¦IâŸ§
          ; natâ€² = natâ€²
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


âˆ˜-Iâ€² : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
       -------------------
       Î“ âŠ¨s Ïƒ âˆ˜ I â‰ˆ Ïƒ âˆ¶ Î”
âˆ˜-Iâ€² {_} {Ïƒ} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) = âŠ¨Î“ , âŠ¨Î” , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelSubsts (Ïƒ âˆ˜ I) Ï Ïƒ Ïâ€² âŸ¦ âŠ¨Î” âŸ§Ï
        helper Ïâ‰ˆÏâ€² = record
          { âŸ¦ÏƒâŸ§  = âŸ¦ÏƒâŸ§
          ; âŸ¦Î´âŸ§  = âŸ¦Î´âŸ§
          ; â†˜âŸ¦ÏƒâŸ§ = âŸ¦âˆ˜âŸ§ âŸ¦IâŸ§ â†˜âŸ¦ÏƒâŸ§
          ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Î´âŸ§
          ; Ïƒâ‰ˆÎ´  = Ïƒâ‰ˆÎ´
          ; nat  = Î» Îº â†’ âŸ¦âˆ˜âŸ§ âŸ¦IâŸ§ (nat Îº)
          ; natâ€² = natâ€²
          }
          where open RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)


-- âˆ˜-assoc   : âˆ€ {Î“â€´} â†’
--             Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
--             Î“â€³ âŠ¨s Ïƒâ€² âˆ¶ Î“â€² â†’
--             Î“â€´ âŠ¨s Ïƒâ€³ âˆ¶ Î“â€³ â†’
--             ---------------------------------------
--             Î“â€´ âŠ¨s Ïƒ âˆ˜ Ïƒâ€² âˆ˜ Ïƒâ€³ â‰ˆ Ïƒ âˆ˜ (Ïƒâ€² âˆ˜ Ïƒâ€³) âˆ¶ Î“
-- ,-âˆ˜       : âˆ€ {i} â†’
--             Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
--             Î“â€³ âŠ¨ T âˆ¶ Se i â†’
--             Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
--             Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
--             ---------------------------------------------
--             Î“ âŠ¨s (Ïƒ , t) âˆ˜ Ï„ â‰ˆ (Ïƒ âˆ˜ Ï„) , t [ Ï„ ] âˆ¶ T âˆº Î“â€³
-- p-âˆ˜       : Î“â€² âŠ¨s Ïƒ âˆ¶ T âˆº Î“â€³ â†’
--             Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
--             ------------------------------
--             Î“ âŠ¨s p Ïƒ âˆ˜ Ï„ â‰ˆ p (Ïƒ âˆ˜ Ï„) âˆ¶ Î“â€³
-- ï¼›-âˆ˜       : âˆ€ {n} Î¨s â†’
--             Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
--             Î“ âŠ¨s Ï„ âˆ¶ Î¨s ++âº Î“â€² â†’
--             len Î¨s â‰¡ n â†’
--             ------------------------------
--             Î“ âŠ¨s Ïƒ ï¼› n âˆ˜ Ï„ â‰ˆ (Ïƒ âˆ˜ Ï„ âˆ¥ n) ï¼› L Ï„ n âˆ¶ [] âˆ·âº Î“â€³
-- p-,       : âˆ€ {i} â†’
--             Î“â€² âŠ¨s Ïƒ âˆ¶ Î“ â†’
--             Î“ âŠ¨ T âˆ¶ Se i â†’
--             Î“â€² âŠ¨ t âˆ¶ T [ Ïƒ ] â†’
--             -------------------------
--             Î“â€² âŠ¨s p (Ïƒ , t) â‰ˆ Ïƒ âˆ¶ Î“
-- ,-ext     : Î“â€² âŠ¨s Ïƒ âˆ¶ T âˆº Î“ â†’
--             ----------------------------------
--             Î“â€² âŠ¨s Ïƒ â‰ˆ p Ïƒ , v 0 [ Ïƒ ] âˆ¶ T âˆº Î“
-- ï¼›-ext     : Î“ âŠ¨s Ïƒ âˆ¶ [] âˆ·âº Î” â†’
--             -----------------------------------
--             Î“ âŠ¨s Ïƒ â‰ˆ (Ïƒ âˆ¥ 1) ï¼› L Ïƒ 1 âˆ¶ [] âˆ·âº Î”
-- s-â‰ˆ-sym   : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
--             ------------------
--             Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒ âˆ¶ Î”
-- s-â‰ˆ-trans : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
--             Î“ âŠ¨s Ïƒâ€² â‰ˆ Ïƒâ€³ âˆ¶ Î” â†’
--             -------------------
--             Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€³ âˆ¶ Î”
-- s-â‰ˆ-conv  : Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
--             âŠ¨ Î” â‰ˆ Î”â€² â†’
--             ------------------
--             Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î”â€²
