{-# OPTIONS --without-K --safe #-}

open import Level using ()
open import Axiom.Extensionality.Propositional

module kMLTT.Completeness.Pi (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Data.Nat.Properties

open import Lib
open import kMLTT.Completeness.LogRel

open import kMLTT.Semantics.Properties.Domain fext
open import kMLTT.Semantics.Properties.Evaluation fext
open import kMLTT.Semantics.Properties.PER fext


Î -[]â€² : âˆ€ {i} â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ S âˆ¶ Se i â†’
        (S âˆº Î”) âŠ¨ T âˆ¶ Se i â†’
        -------------------------------------------------
        Î“ âŠ¨ Î  S T [ Ïƒ ] â‰ˆ Î  (S [ Ïƒ ]) (T [ q Ïƒ ]) âˆ¶ Se i
Î -[]â€² {_} {Ïƒ} {_} {S} {T} {i} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨S) (âˆ·-cong âŠ¨Î”â‚‚ rel , âŠ¨T) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (Se i) Ï (Se i) Ïâ€²) (Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp (Se i) Ï (Se i) Ïâ€²) (Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | rt@record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                     , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     = record
                        { âŸ¦TâŸ§   = U i
                        ; âŸ¦Tâ€²âŸ§  = U i
                        ; â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ i
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ i
                        ; Tâ‰ˆTâ€²  = -, PERDef.U i<j eq
                        }
                     , record
                         { âŸ¦tâŸ§   = Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§
                         ; âŸ¦tâ€²âŸ§  = Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€²
                         ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§)
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                         ; tâ‰ˆtâ€²  = subst (Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€² âˆˆ_) (sym (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j))
                                         (result (subst (âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) tâ‰ˆtâ€²))
                         }

                  where result : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ ğ•Œ i â†’ Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (sub T (q Ïƒ)) Ïâ€² âˆˆ ğ•Œ i
                        result Sâ‰ˆ = Î  (Î» Îº â†’ ğ•Œ-mon Îº Sâ‰ˆ) step
                          where step : (Îº : UnMoT) â†’ a â‰ˆ aâ€² âˆˆ El i (ğ•Œ-mon Îº Sâ‰ˆ) â†’ Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                step {a} {aâ€²} Îº aâ‰ˆaâ€²
                                  with substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ (âŸ¦âŸ§Ï-mon âŠ¨Î” Îº Ïƒ.Ïƒâ‰ˆÎ´))
                                ...  | Ïƒâ‰ˆÎ´â‚ = answer
                                  where insert : a â‰ˆ aâ€² âˆˆ Elâˆ (RelTyp.Tâ‰ˆTâ€² (rel Ïƒâ‰ˆÎ´â‚))
                                        insert
                                          with rel Ïƒâ‰ˆÎ´â‚
                                        ...  | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
                                             rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâŸ§)
                                                   | âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦Tâ€²âŸ§) (drop-â†¦ _ _) â†˜âŸ¦Tâ€²âŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâ€²âŸ§) = ğ•Œ-irrel (ğ•Œ-mon Îº Sâ‰ˆ) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                                        answer : Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                        answer
                                          with âŠ¨T {Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a} {Ïƒ.âŸ¦Î´âŸ§ [ Îº ] â†¦ aâ€²} (Ïƒâ‰ˆÎ´â‚ , insert)
                                        ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                                             , re = record
                                                      { âŸ¦TâŸ§   = re.âŸ¦tâŸ§
                                                      ; âŸ¦Tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                                      ; â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ (âŸ¦pâŸ§ âŸ¦IâŸ§) (subst (âŸ¦ Ïƒ âŸ§s_â†˜ Ïƒ.âŸ¦Î´âŸ§ [ Îº ]) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§s-mon Îº Ïƒ.â†˜âŸ¦Î´âŸ§))) (âŸ¦vâŸ§ 0)) re.â†˜âŸ¦tâ€²âŸ§
                                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) re.tâ‰ˆtâ€²
                                                      }
                                          where module re = RelExp re


-- -- Î -cong     : âˆ€ {i} â†’
-- --              Î“ âŠ¨ S â‰ˆ Sâ€² âˆ¶ Se i â†’
-- --              S âˆº Î“ âŠ¨ T â‰ˆ Tâ€² âˆ¶ Se i â†’
-- --              --------------------------
-- --              Î“ âŠ¨ Î  S T â‰ˆ Î  Sâ€² Tâ€² âˆ¶ Se i

-- -- Î›-cong     : S âˆº Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
-- --              -----------------------
-- --              Î“ âŠ¨ Î› t â‰ˆ Î› tâ€² âˆ¶ Î  S T
-- -- $-cong     : Î“ âŠ¨ r â‰ˆ râ€² âˆ¶ Î  S T â†’
-- --              Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶ S â†’
-- --              -------------------------------
-- --              Î“ âŠ¨ r $ s â‰ˆ râ€² $ sâ€² âˆ¶ T [| s ]
-- -- Î›-[]       : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
-- --              S âˆº Î” âŠ¨ t âˆ¶ T â†’
-- --              --------------------------------------------
-- --              Î“ âŠ¨ Î› t [ Ïƒ ] â‰ˆ Î› (t [ q Ïƒ ]) âˆ¶ Î  S T [ Ïƒ ]
-- -- $-[]       : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
-- --              Î” âŠ¨ r âˆ¶ Î  S T â†’
-- --              Î” âŠ¨ s âˆ¶ S â†’
-- --              ---------------------------------------------------------
-- --              Î“ âŠ¨ (r $ s) [ Ïƒ ] â‰ˆ r [ Ïƒ ] $ s [ Ïƒ ] âˆ¶ T [ Ïƒ , s [ Ïƒ ] ]
-- -- Î›-Î²        : S âˆº Î“ âŠ¨ t âˆ¶ T â†’
-- --              Î“ âŠ¨ s âˆ¶ S â†’
-- --              ----------------------------------
-- --              Î“ âŠ¨ Î› t $ s â‰ˆ t [| s ] âˆ¶ T [| s ]
-- -- Î›-Î·        : Î“ âŠ¨ t âˆ¶ Î  S T â†’
-- --              ----------------------------------
-- --              Î“ âŠ¨ t â‰ˆ Î› (t [ wk ] $ v 0) âˆ¶ Î  S T
