{-# OPTIONS --without-K --safe #-}

open import Level using ()
open import Axiom.Extensionality.Propositional

module kMLTT.Completeness.Pi (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Data.Nat.Properties

open import Lib
open import kMLTT.Completeness.LogRel

open import kMLTT.Semantics.Properties.Domain fext
open import kMLTT.Semantics.Properties.Evaluation fext
open import kMLTT.Semantics.Properties.PER fext


Î -[]â€² : âˆ€ {i} â†’
        Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
        Î” âŠ¨ S âˆ¶ Se i â†’
        (S âˆº Î”) âŠ¨ T âˆ¶ Se i â†’
        -------------------------------------------------
        Î“ âŠ¨ Î  S T [ Ïƒ ] â‰ˆ Î  (S [ Ïƒ ]) (T [ q Ïƒ ]) âˆ¶ Se i
Î -[]â€² {_} {Ïƒ} {_} {S} {T} {i} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨S) (âˆ·-cong âŠ¨Î”â‚‚ rel , âŠ¨T) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (Se i) Ï (Se i) Ïâ€²) (Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp (Se i) Ï (Se i) Ïâ€²) (Î» rel â†’ RelExp (Î  S T [ Ïƒ ]) Ï (Î  (S [ Ïƒ ]) (T [ q Ïƒ ])) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                     , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                     = record
                        { âŸ¦TâŸ§   = U i
                        ; âŸ¦Tâ€²âŸ§  = U i
                        ; â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ i
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ i
                        ; Tâ‰ˆTâ€²  = -, PERDef.U i<j eq
                        }
                     , record
                         { âŸ¦tâŸ§   = Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§
                         ; âŸ¦tâ€²âŸ§  = Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€²
                         ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ (âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§)
                         ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦tâ€²âŸ§)
                         ; tâ‰ˆtâ€²  = subst (Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (T [ q Ïƒ ]) Ïâ€² âˆˆ_) (sym (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j))
                                         (result (subst (âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) tâ‰ˆtâ€²))
                         }
                  where result : âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ ğ•Œ i â†’ Î  âŸ¦tâŸ§ T Ïƒ.âŸ¦ÏƒâŸ§ â‰ˆ Î  âŸ¦tâ€²âŸ§ (sub T (q Ïƒ)) Ïâ€² âˆˆ ğ•Œ i
                        result Sâ‰ˆ = Î  (Î» Îº â†’ ğ•Œ-mon Îº Sâ‰ˆ) step
                          where step : (Îº : UnMoT) â†’ a â‰ˆ aâ€² âˆˆ El i (ğ•Œ-mon Îº Sâ‰ˆ) â†’ Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                step {a} {aâ€²} Îº aâ‰ˆaâ€²
                                  with substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î”â‚‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚‚ (âŸ¦âŸ§Ï-mon âŠ¨Î” Îº Ïƒ.Ïƒâ‰ˆÎ´))
                                ...  | Ïƒâ‰ˆÎ´â‚ = answer
                                  where insert : a â‰ˆ aâ€² âˆˆ Elâˆ (RelTyp.Tâ‰ˆTâ€² (rel Ïƒâ‰ˆÎ´â‚))
                                        insert
                                          with rel Ïƒâ‰ˆÎ´â‚
                                        ...  | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
                                             rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâŸ§)
                                                   | âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦Tâ€²âŸ§) (drop-â†¦ _ _) â†˜âŸ¦Tâ€²âŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâ€²âŸ§) = ğ•Œ-irrel (ğ•Œ-mon Îº Sâ‰ˆ) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                                        answer : Î RT T (Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a) (T [ q Ïƒ ]) (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                                        answer
                                          with âŠ¨T {Ïƒ.âŸ¦ÏƒâŸ§ [ Îº ] â†¦ a} {Ïƒ.âŸ¦Î´âŸ§ [ Îº ] â†¦ aâ€²} (Ïƒâ‰ˆÎ´â‚ , insert)
                                        ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                                             , re = record
                                                      { âŸ¦TâŸ§   = re.âŸ¦tâŸ§
                                                      ; âŸ¦Tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                                      ; â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ (âŸ¦âˆ˜âŸ§ (âŸ¦pâŸ§ âŸ¦IâŸ§) (subst (âŸ¦ Ïƒ âŸ§s_â†˜ Ïƒ.âŸ¦Î´âŸ§ [ Îº ]) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§s-mon Îº Ïƒ.â†˜âŸ¦Î´âŸ§))) (âŸ¦vâŸ§ 0)) re.â†˜âŸ¦tâ€²âŸ§
                                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) re.tâ‰ˆtâ€²
                                                      }
                                          where module re = RelExp re


Î -congâ€² : âˆ€ {i} â†’
          Î“ âŠ¨ S â‰ˆ Sâ€² âˆ¶ Se i â†’
          (S âˆº Î“) âŠ¨ T â‰ˆ Tâ€² âˆ¶ Se i â†’
          --------------------------
          Î“ âŠ¨ Î  S T â‰ˆ Î  Sâ€² Tâ€² âˆ¶ Se i
Î -congâ€² {_} {S} {Sâ€²} {T} {Tâ€²} {i} (âŠ¨Î“ , Sâ‰ˆSâ€²) (âˆ·-cong âŠ¨Î“â‚ rel , Tâ‰ˆTâ€²) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (Se i) Ï (Se i) Ïâ€²) (Î» rel â†’ RelExp (Î  S T) Ï (Î  Sâ€² Tâ€²) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with Sâ‰ˆSâ€² Ïâ‰ˆÏâ€²
        ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j = record
                                                 { âŸ¦TâŸ§   = U i
                                                 ; âŸ¦Tâ€²âŸ§  = U i
                                                 ; â†˜âŸ¦TâŸ§  = âŸ¦SeâŸ§ i
                                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ i
                                                 ; Tâ‰ˆTâ€²  = -, PERDef.U i<j eq
                                                 }
                                             , record
                                                 { âŸ¦tâŸ§   = Î  âŸ¦tâŸ§ T Ï
                                                 ; âŸ¦tâ€²âŸ§  = Î  âŸ¦tâ€²âŸ§ Tâ€² Ïâ€²
                                                 ; â†˜âŸ¦tâŸ§  = âŸ¦Î âŸ§ â†˜âŸ¦tâŸ§
                                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦tâ€²âŸ§
                                                 ; tâ‰ˆtâ€²  = subst (Î  âŸ¦tâŸ§ T Ï â‰ˆ Î  âŸ¦tâ€²âŸ§ Tâ€² Ïâ€² âˆˆ_) (sym (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j)) (Î  (Î» Îº â†’ ğ•Œ-mon Îº tâ‰ˆtâ€²) result)
                                                 }
          where result : (Îº : UnMoT) â†’ a â‰ˆ aâ€² âˆˆ El i (ğ•Œ-mon Îº tâ‰ˆtâ€²) â†’ Î RT T (Ï [ Îº ] â†¦ a) Tâ€² (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                result {a} {aâ€²} Îº aâ‰ˆaâ€²
                  with substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-mon âŠ¨Î“ Îº Ïâ‰ˆÏâ€²))
                ...  | Ïâ‰ˆÏâ€²â‚ = answer
                  where insert : a â‰ˆ aâ€² âˆˆ Elâˆ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²â‚))
                        insert
                          with rel Ïâ‰ˆÏâ€²â‚
                        ...  | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
                             rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº â†˜âŸ¦tâŸ§) = El-one-sided (ğ•Œ-mon Îº tâ‰ˆtâ€²) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                        answer : Î RT T (Ï [ Îº ] â†¦ a) Tâ€² (Ïâ€² [ Îº ] â†¦ aâ€²) (ğ•Œ i)
                        answer
                          with Tâ‰ˆTâ€² {Ï [ Îº ] â†¦ a} {Ïâ€² [ Îº ] â†¦ aâ€²} (Ïâ‰ˆÏâ€²â‚ , insert)
                        ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                             , re = record
                                      { âŸ¦TâŸ§   = re.âŸ¦tâŸ§
                                      ; âŸ¦Tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                      ; â†˜âŸ¦TâŸ§  = re.â†˜âŸ¦tâŸ§
                                      ; â†˜âŸ¦Tâ€²âŸ§ = re.â†˜âŸ¦tâ€²âŸ§
                                      ; Tâ‰ˆTâ€²  = subst (re.âŸ¦tâŸ§ â‰ˆ re.âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) re.tâ‰ˆtâ€²
                                      }
                          where module re = RelExp re


Î›-congâ€² : âˆ€ {i} â†’
          (S âˆº Î“) âŠ¨ T âˆ¶ Se i â†’
          (S âˆº Î“) âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
          -----------------------
          Î“ âŠ¨ Î› t â‰ˆ Î› tâ€² âˆ¶ Î  S T
Î›-congâ€² {S} {_} {T} {t} {tâ€²} {i} (âˆ·-cong âŠ¨Î“ rel , âŠ¨T) (âˆ·-cong âŠ¨Î“â‚ relâ‚ , tâ‰ˆtâ€²) = âŠ¨Î“â‚ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï â†’ Î£ (RelTyp (Î  S T) Ï (Î  S T) Ïâ€²) (Î» rel â†’ RelExp (Î› t) Ï (Î› tâ€²) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = record
                                 { âŸ¦TâŸ§   = Î  S.âŸ¦TâŸ§ T Ï
                                 ; âŸ¦Tâ€²âŸ§  = Î  S.âŸ¦Tâ€²âŸ§ T Ïâ€²
                                 ; â†˜âŸ¦TâŸ§  = âŸ¦Î âŸ§ S.â†˜âŸ¦TâŸ§
                                 ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ S.â†˜âŸ¦Tâ€²âŸ§
                                 ; Tâ‰ˆTâ€²  = max (projâ‚ S.Tâ‰ˆTâ€²) i , Î  (Î» Îº â†’ ğ•Œ-cumu (mâ‰¤mâŠ”n _ _) (ğ•Œ-mon Îº (projâ‚‚ S.Tâ‰ˆTâ€²))) Î» Îº aâ‰ˆb â†’ projâ‚ (Î res Îº aâ‰ˆb)
                                 }
                             , record
                                 { âŸ¦tâŸ§   = Î› t Ï
                                 ; âŸ¦tâ€²âŸ§  = Î› tâ€² Ïâ€²
                                 ; â†˜âŸ¦tâŸ§  = âŸ¦Î›âŸ§ t
                                 ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦Î›âŸ§ tâ€²
                                 ; tâ‰ˆtâ€²  = Î» Îº aâ‰ˆb â†’ projâ‚‚ (Î res Îº aâ‰ˆb)
                                 }
             where module S = RelTyp (relâ‚ Ïâ‰ˆÏâ€²)
                   insert : (âŠ¨Î“ : âŠ¨ Î“) â†’
                            (rel : âˆ€ {Ï Ïâ€²} â†’ Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ RelTyp S Ï S Ïâ€²) â†’
                            (Îº : UnMoT) (Ïâ‰ˆÏâ€² : drop (Ï [ Îº ] â†¦ a) â‰ˆ drop (Ïâ€² [ Îº ] â†¦ aâ€²) âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï) â†’
                            a â‰ˆ aâ€² âˆˆ El _ (ğ•Œ-cumu (mâ‰¤mâŠ”n _ i) (ğ•Œ-mon Îº (projâ‚‚ S.Tâ‰ˆTâ€²))) â†’
                            a â‰ˆ aâ€² âˆˆ Elâˆ (RelTyp.Tâ‰ˆTâ€² (rel Ïâ‰ˆÏâ€²))
                   insert âŠ¨Î“ rel Îº Ïâ‰ˆÏâ€² aâ‰ˆaâ€²
                     with rel Ïâ‰ˆÏâ€²
                   ...  | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
                        rewrite âŸ¦âŸ§-det (subst (âŸ¦ S âŸ§_â†˜ âŸ¦TâŸ§) (drop-â†¦ _ _) â†˜âŸ¦TâŸ§) (âŸ¦âŸ§-mon Îº S.â†˜âŸ¦TâŸ§) = El-one-sided (ğ•Œ-cumu (mâ‰¤mâŠ”n _ i) (ğ•Œ-mon Îº (projâ‚‚ S.Tâ‰ˆTâ€²))) Tâ‰ˆTâ€² aâ‰ˆaâ€²

                   Î res : (Îº : UnMoT) (aâ‰ˆb : a â‰ˆ b âˆˆ El _ (ğ•Œ-cumu (mâ‰¤mâŠ”n _ i) (ğ•Œ-mon Îº (projâ‚‚ S.Tâ‰ˆTâ€²)))) â†’
                          Î£ (Î RT T (Ï [ Îº ] â†¦ a) T (Ïâ€² [ Îº ] â†¦ b) (ğ•Œ _))
                            Î» rel â†’ Î Ì‚ (Î› t (Ï [ Îº ])) a (Î› tâ€² (Ïâ€² [ Îº ])) b (El _ (Î RT.Tâ‰ˆTâ€² rel))
                   Î res {a} {b} Îº aâ‰ˆb
                     with substâ‚‚ (_â‰ˆ_âˆˆ âŸ¦ âŠ¨Î“â‚ âŸ§Ï) (sym (drop-â†¦ _ _)) (sym (drop-â†¦ _ _)) (âŸ¦âŸ§Ï-mon âŠ¨Î“â‚ Îº Ïâ‰ˆÏâ€²)
                   ...  | Ïâ‰ˆÏâ€²â‚
                        with âŠ¨-irrel âŠ¨Î“â‚ âŠ¨Î“ Ïâ‰ˆÏâ€²â‚
                   ...     | Ïâ‰ˆÏâ€²â‚‚ = answer
                     where answer : Î£ (Î RT T (Ï [ Îº ] â†¦ a) T (Ïâ€² [ Îº ] â†¦ b) (ğ•Œ _))
                                      Î» rel â†’ Î Ì‚ (Î› t (Ï [ Îº ])) a (Î› tâ€² (Ïâ€² [ Îº ])) b (El _ (Î RT.Tâ‰ˆTâ€² rel))
                           answer
                             with âŠ¨T {Ï [ Îº ] â†¦ a} {Ïâ€² [ Îº ] â†¦ b} (Ïâ‰ˆÏâ€²â‚‚ , insert âŠ¨Î“ rel Îº Ïâ‰ˆÏâ€²â‚‚ aâ‰ˆb)
                                | tâ‰ˆtâ€² {Ï [ Îº ] â†¦ a} {Ïâ€² [ Îº ] â†¦ b} (Ïâ‰ˆÏâ€²â‚ , insert âŠ¨Î“â‚ relâ‚ Îº Ïâ‰ˆÏâ€²â‚ aâ‰ˆb)
                           ...  | record { âŸ¦TâŸ§ = .(U i) ; âŸ¦Tâ€²âŸ§ = .(U i) ; â†˜âŸ¦TâŸ§ = (âŸ¦SeâŸ§ .i) ; â†˜âŸ¦Tâ€²âŸ§ = (âŸ¦SeâŸ§ .i) ; Tâ‰ˆTâ€² = _ , PERDef.U i<j eq }
                                , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                                | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
                                , re
                                rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦tâŸ§
                                      | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ = record
                                              { âŸ¦TâŸ§   = âŸ¦tâŸ§
                                              ; âŸ¦Tâ€²âŸ§  = âŸ¦tâ€²âŸ§
                                              ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦tâŸ§
                                              ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§
                                              ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²â‚
                                              }
                                          , record
                                              { fa     = re.âŸ¦tâŸ§
                                              ; faâ€²    = re.âŸ¦tâ€²âŸ§
                                              ; â†˜fa    = Î›âˆ™ re.â†˜âŸ¦tâŸ§
                                              ; â†˜faâ€²   = Î›âˆ™ re.â†˜âŸ¦tâ€²âŸ§
                                              ; faâ‰ˆfaâ€² = ğ•Œ-irrel Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ re.tâ‰ˆtâ€²
                                              }
                             where module re = RelExp re
                                   Tâ‰ˆTâ€²â‚ = ğ•Œ-cumu (mâ‰¤nâŠ”m _ i) (subst (âŸ¦tâŸ§ â‰ˆ âŸ¦tâ€²âŸ§ âˆˆ_) (ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j) tâ‰ˆtâ€²)


$-congâ€² : Î“ âŠ¨ r â‰ˆ râ€² âˆ¶ Î  S T â†’
          Î“ âŠ¨ s â‰ˆ sâ€² âˆ¶ S â†’
          -------------------------------
          Î“ âŠ¨ r $ s â‰ˆ râ€² $ sâ€² âˆ¶ (T [| s ])
$-congâ€² {_} {r} {râ€²} {S} {T} {s} {sâ€²} (âŠ¨Î“ , râ‰ˆrâ€²) (âŠ¨Î“â‚ , sâ‰ˆsâ€²) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (T [| s ]) Ï (T [| s ]) Ïâ€²) (Î» rel â†’ RelExp (r $ s) Ï (râ€² $ sâ€²) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²) | âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
        ...  | Ïâ‰ˆÏ | Ïâ€²â‰ˆÏ
          with râ‰ˆrâ€² Ïâ‰ˆÏâ€²
             | sâ‰ˆsâ€² Ïâ‰ˆÏ
             | sâ‰ˆsâ€² Ïâ€²â‰ˆÏ
             | sâ‰ˆsâ€² (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ...  | record { âŸ¦TâŸ§ = .(Î  _ T _) ; âŸ¦Tâ€²âŸ§ = .(Î  _ T _) ; â†˜âŸ¦TâŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦Î âŸ§ â†˜âŸ¦SâŸ§â€² ; Tâ‰ˆTâ€² = i , PERDef.Î  iA RT }
             , record { âŸ¦tâŸ§ = âŸ¦râŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦râ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦râŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦râ€²âŸ§ ; tâ‰ˆtâ€² = râ‰ˆrâ€² }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€²â‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§â‚‚ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§â‚‚ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚‚ ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€²â‚‚ }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§â‚‚ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§â‚‚ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§â‚‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§â‚‚ ; tâ‰ˆtâ€² = tâ‰ˆtâ€²â‚‚ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = j , Tâ‰ˆTâ€² }
             , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
             rewrite âŸ¦âŸ§-det â†˜âŸ¦SâŸ§ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€² â†˜âŸ¦Tâ€²âŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦Tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§â‚ â†˜âŸ¦tâ€²âŸ§â‚‚
                   | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§â‚ â†˜âŸ¦tâŸ§ = record
                                           { âŸ¦TâŸ§   = RT.âŸ¦TâŸ§
                                           ; âŸ¦Tâ€²âŸ§  = RT.âŸ¦Tâ€²âŸ§
                                           ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§) (subst (Î» x â†’ âŸ¦ T âŸ§ x â†¦ âŸ¦tâŸ§ â†˜ RT.âŸ¦TâŸ§) (Ï-ap-vone _) RT.â†˜âŸ¦TâŸ§)
                                           ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦,âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§â‚‚) (subst (Î» x â†’ âŸ¦ T âŸ§ x â†¦ âŸ¦tâŸ§â‚‚ â†˜ RT.âŸ¦Tâ€²âŸ§) (Ï-ap-vone _) RT.â†˜âŸ¦Tâ€²âŸ§)
                                           ; Tâ‰ˆTâ€²  = -, RT.Tâ‰ˆTâ€²
                                           }
                                       , record
                                           { âŸ¦tâŸ§   = rs.fa
                                           ; âŸ¦tâ€²âŸ§  = rs.faâ€²
                                           ; â†˜âŸ¦tâŸ§  = âŸ¦$âŸ§ â†˜âŸ¦râŸ§ â†˜âŸ¦tâŸ§ (subst (_âˆ™ âŸ¦tâŸ§ â†˜ rs.fa) (D-ap-vone _) rs.â†˜fa)
                                           ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦$âŸ§ â†˜âŸ¦râ€²âŸ§ â†˜âŸ¦tâ€²âŸ§ (subst (_âˆ™ âŸ¦tâ€²âŸ§ â†˜ rs.faâ€²) (D-ap-vone _) rs.â†˜faâ€²)
                                           ; tâ‰ˆtâ€²  = El-transp RTâ€².Tâ‰ˆTâ€² RT.Tâ‰ˆTâ€² rs.faâ‰ˆfaâ€² (sym (âŸ¦âŸ§-det RT.â†˜âŸ¦TâŸ§ RTâ€².â†˜âŸ¦TâŸ§))
                                           }
          where Tâ‰ˆT  = ğ•Œ-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚)
                srel = El-trans Tâ‰ˆTâ€²â‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) Tâ‰ˆT tâ‰ˆtâ€²â‚ (El-sym Tâ‰ˆTâ€²â‚‚ (ğ•Œ-sym Tâ‰ˆTâ€²â‚‚) tâ‰ˆtâ€²â‚‚)

                module RT  = Î RT (RT vone (El-transp Tâ‰ˆT (iA vone) srel (sym (D-ap-vone _))))
                module RTâ€² = Î RT (RT vone (El-transp Tâ‰ˆTâ€² (iA vone) tâ‰ˆtâ€² (sym (D-ap-vone _))))
                module rs  = Î Ì‚ (râ‰ˆrâ€² vone (El-transp Tâ‰ˆTâ€² (iA vone) tâ‰ˆtâ€² (sym (D-ap-vone _))))


-- Î›-[]       : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
--              S âˆº Î” âŠ¨ t âˆ¶ T â†’
--              --------------------------------------------
--              Î“ âŠ¨ Î› t [ Ïƒ ] â‰ˆ Î› (t [ q Ïƒ ]) âˆ¶ Î  S T [ Ïƒ ]
-- $-[]       : Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
--              Î” âŠ¨ r âˆ¶ Î  S T â†’
--              Î” âŠ¨ s âˆ¶ S â†’
--              ---------------------------------------------------------
--              Î“ âŠ¨ (r $ s) [ Ïƒ ] â‰ˆ r [ Ïƒ ] $ s [ Ïƒ ] âˆ¶ T [ Ïƒ , s [ Ïƒ ] ]
-- Î›-Î²        : S âˆº Î“ âŠ¨ t âˆ¶ T â†’
--              Î“ âŠ¨ s âˆ¶ S â†’
--              ----------------------------------
--              Î“ âŠ¨ Î› t $ s â‰ˆ t [| s ] âˆ¶ T [| s ]
-- Î›-Î·        : Î“ âŠ¨ t âˆ¶ Î  S T â†’
--              ----------------------------------
--              Î“ âŠ¨ t â‰ˆ Î› (t [ wk ] $ v 0) âˆ¶ Î  S T
