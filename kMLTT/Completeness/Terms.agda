{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

module kMLTT.Completeness.Terms (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Lib
open import kMLTT.Completeness.LogRel

open import kMLTT.Semantics.Properties.Domain fext
open import kMLTT.Semantics.Properties.PER fext


âŠ¨-lookup-gen : âˆ€ {x}
               (Î“â‰ˆÎ” : âŠ¨ Î“ â‰ˆ Î”) â†’
               x âˆ¶ T âˆˆ! Î“ â†’
               x âˆ¶ Tâ€² âˆˆ! Î” â†’
               Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ Î“â‰ˆÎ” âŸ§Ï â†’
               --------------------------------------------------------
               Î£ (RelTyp T Ï Tâ€² Ïâ€²) Î» rel â†’ RelExp (v x) Ï (v x) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel))
âŠ¨-lookup-gen {T = sub T _} {sub Tâ€² _} {Ï} {Ïâ€²} (âˆ·-cong Î“â‰ˆÎ” rel) here here (Ïâ‰ˆÏâ€² , Ï0â‰ˆÏâ€²0)
  = record
      { âŸ¦TâŸ§   = âŸ¦TâŸ§
      ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
      ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ {!âŸ¦wkâŸ§!} â†˜âŸ¦TâŸ§
      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ {!!} â†˜âŸ¦Tâ€²âŸ§
      ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
      ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ {!!} (subst (âŸ¦ T âŸ§_â†˜ âŸ¦TâŸ§ [ Îº ]) (drop-mon Ï Îº) (nat Îº))
      ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ {!!} (subst (âŸ¦ Tâ€² âŸ§_â†˜ âŸ¦Tâ€²âŸ§ [ Îº ]) (drop-mon Ïâ€² Îº) (natâ€² Îº))
      }
  , record
      { âŸ¦tâŸ§   = _
      ; âŸ¦tâ€²âŸ§  = _
      ; â†˜âŸ¦tâŸ§  = âŸ¦vâŸ§ 0
      ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ 0
      ; tâ‰ˆtâ€²  = Ï0â‰ˆÏâ€²0
      ; nat   = Î» Îº â†’ âŸ¦vâŸ§ 0
      ; natâ€²  = Î» Îº â†’ âŸ¦vâŸ§ 0
      }
  where open RelTyp (rel Ïâ‰ˆÏâ€²)
âŠ¨-lookup-gen {T = sub T _} {sub Tâ€² _} {Ï} {Ïâ€²} (âˆ·-cong Î“â‰ˆÎ” rel) (there TâˆˆÎ“) (there Tâ€²âˆˆÎ”) (Ïâ‰ˆÏâ€² , _)
  with âŠ¨-lookup-gen Î“â‰ˆÎ” TâˆˆÎ“ Tâ€²âˆˆÎ” Ïâ‰ˆÏâ€²
...  | rt , record { â†˜âŸ¦tâŸ§ = âŸ¦vâŸ§ _ ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² ; nat = nat ; natâ€² = natâ€² }
  = record
                   { âŸ¦TâŸ§   = âŸ¦TâŸ§
                   ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
                   ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ {!!} â†˜âŸ¦TâŸ§
                   ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ {!!} â†˜âŸ¦Tâ€²âŸ§
                   ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                   ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ {!!} (subst (âŸ¦ T âŸ§_â†˜ âŸ¦TâŸ§ [ Îº ]) (drop-mon Ï Îº) (rt.nat Îº))
                   ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ {!!} (subst (âŸ¦ Tâ€² âŸ§_â†˜ âŸ¦Tâ€²âŸ§ [ Îº ]) (drop-mon Ïâ€² Îº) (rt.natâ€² Îº))
                   }
               , record
                   { âŸ¦tâŸ§   = _
                   ; âŸ¦tâ€²âŸ§  = _
                   ; â†˜âŸ¦tâŸ§  = âŸ¦vâŸ§ _
                   ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _
                   ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                   ; nat   = Î» Îº â†’ âŸ¦vâŸ§ _
                   ; natâ€²  = Î» Îº â†’ âŸ¦vâŸ§ _
                   }
  where module rt = RelTyp rt
        open rt hiding (nat; natâ€²)


âŠ¨-lookup : âˆ€ {x}
           (âŠ¨Î“ : âŠ¨ Î“) â†’
           x âˆ¶ T âˆˆ! Î“ â†’
           Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’
           --------------------------------------------------------
           Î£ (RelTyp T Ï T Ïâ€²) Î» rel â†’ RelExp (v x) Ï (v x) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel))
âŠ¨-lookup âŠ¨Î“ TâˆˆÎ“ = âŠ¨-lookup-gen âŠ¨Î“ TâˆˆÎ“ TâˆˆÎ“


v-â‰ˆâ€² : âˆ€ {x} â†’
       âŠ¨ Î“ â†’
       x âˆ¶ T âˆˆ! Î“ â†’
       -----------------
       Î“ âŠ¨ v x â‰ˆ v x âˆ¶ T
v-â‰ˆâ€² âŠ¨Î“ TâˆˆÎ“ = âŠ¨Î“ , âŠ¨-lookup âŠ¨Î“ TâˆˆÎ“


[]-congâ€² : Î” âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
           Î“ âŠ¨s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
           ---------------------------------
           Î“ âŠ¨ (t [ Ïƒ ]) â‰ˆ (tâ€² [ Ïƒâ€² ]) âˆ¶ (T [ Ïƒ ])
[]-congâ€² {_} {t} {tâ€²} {T} {_} {Ïƒ} {Ïƒâ€²} (âŠ¨Î” , tâ‰ˆtâ€²) (âŠ¨Î“ , âŠ¨Î”â‚ , Ïƒâ‰ˆÏƒâ€²) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (t [ Ïƒ ]) Ï (tâ€² [ Ïƒâ€² ]) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€²
          with âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€² | âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²
        ...  | Ïâ‰ˆÏ | Ïâ€²â‰ˆÏ
             with Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏ | Ïƒâ‰ˆÏƒâ€² Ïâ€²â‰ˆÏ | Ïƒâ‰ˆÏƒâ€² Ïâ‰ˆÏâ€²
        ...     | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§  ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§  ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§  ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§  ; nat = natâ‚ }
                | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§â€² ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â€² ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€² ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚ ; nat = natâ‚‚ }
                | record { âŸ¦ÏƒâŸ§ = âŸ¦ÏƒâŸ§â€³ ; â†˜âŸ¦ÏƒâŸ§ = â†˜âŸ¦ÏƒâŸ§â€³ ; â†˜âŸ¦Î´âŸ§ = â†˜âŸ¦Ïƒâ€²âŸ§â€³ ; Ïƒâ‰ˆÎ´ = âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚‚ ; natâ€² = natâ€²â‚ƒ }
                rewrite âŸ¦âŸ§s-det â†˜âŸ¦Ïƒâ€²âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€²
                      | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€³ â†˜âŸ¦ÏƒâŸ§
                with âŸ¦âŸ§Ï-transâ€² âŠ¨Î”â‚ âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§ (âŸ¦âŸ§Ï-symâ€² âŠ¨Î”â‚ âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚)
        ...        | Ïƒâ‰ˆÏƒ = help
          where help : Î£ (RelTyp (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (t [ Ïƒ ]) Ï (tâ€² [ Ïƒâ€² ]) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
                help
                  with tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î” Ïƒâ‰ˆÏƒ) | tâ‰ˆtâ€² (âŠ¨-irrel âŠ¨Î”â‚ âŠ¨Î” âŸ¦Ïƒâ‰ˆÏƒâ€²âŸ§â‚‚)
                ... | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§ ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€² ; nat = natâ‚„ ; natâ€² = natâ€²â‚„ } , _
                    | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€²â‚ } , re
                    rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â€² â†˜âŸ¦TâŸ§ = record
                      { âŸ¦TâŸ§   = âŸ¦TâŸ§
                      ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
                      ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§
                      ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦Tâ€²âŸ§
                      ; Tâ‰ˆTâ€²  = _ , Tâ‰ˆTâ€²
                      ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (natâ‚ Îº) (natâ‚„ Îº)
                      ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (natâ‚‚ Îº) (natâ€²â‚„ Îº)
                      }
                  , record
                      { âŸ¦tâŸ§   = âŸ¦tâŸ§
                      ; âŸ¦tâ€²âŸ§  = âŸ¦tâ€²âŸ§
                      ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦tâŸ§
                      ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦Ïƒâ€²âŸ§â€³ â†˜âŸ¦tâ€²âŸ§
                      ; tâ‰ˆtâ€²  = El-one-sided Tâ‰ˆTâ€²â‚ Tâ‰ˆTâ€² re.tâ‰ˆtâ€²
                      ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (natâ‚ Îº) (re.nat Îº)
                      ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (natâ€²â‚ƒ Îº) (re.natâ€² Îº)
                      }
                  where module re = RelExp re
                        open re


[I]â€² : Î“ âŠ¨ t âˆ¶ T â†’
       --------------------
       Î“ âŠ¨ (t [ I ]) â‰ˆ t âˆ¶ T
[I]â€² {_} {t} {T} (âŠ¨Î“ , âŠ¨t) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp T Ï T Ïâ€²) (Î» rel â†’ RelExp (t [ I ]) Ï t Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper Ïâ‰ˆÏâ€²
          with âŠ¨t Ïâ‰ˆÏâ€²
        ...  | rt , re = rt
                       , record
                           { âŸ¦tâŸ§   = âŸ¦tâŸ§
                           ; âŸ¦tâ€²âŸ§  = âŸ¦tâ€²âŸ§
                           ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ âŸ¦IâŸ§ â†˜âŸ¦tâŸ§
                           ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§
                           ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                           ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ âŸ¦IâŸ§ (nat Îº)
                           ; natâ€²  = natâ€²
                           }
          where open RelExp re


-- [p]        : âˆ€ {x} â†’
--              Î” âŠ¨s Ïƒ âˆ¶ S âˆº Î“ â†’
--              x âˆ¶ T âˆˆ! Î“ â†’
--              ---------------------------------------------
--              Î” âŠ¨ v x [ p Ïƒ ] â‰ˆ v (suc x) [ Ïƒ ] âˆ¶ T [ p Ïƒ ]


[âˆ˜]â€² : Î“ âŠ¨s Ï„ âˆ¶ Î“â€² â†’
       Î“â€² âŠ¨s Ïƒ âˆ¶ Î“â€³ â†’
       Î“â€³ âŠ¨ t âˆ¶ T â†’
       ---------------------------------------------
       Î“ âŠ¨ (t [ Ïƒ âˆ˜ Ï„ ]) â‰ˆ (t [ Ïƒ ] [ Ï„ ]) âˆ¶ (T [ Ïƒ âˆ˜ Ï„ ])
[âˆ˜]â€² {_} {Ï„} {_} {Ïƒ} {_} {t} {T} (âŠ¨Î“ , âŠ¨Î“â€² , âŠ¨Ï„) (âŠ¨Î“â€²â‚ , âŠ¨Î“â€³ , âŠ¨Ïƒ) (âŠ¨Î“â€³â‚ , âŠ¨t) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (T [ Ïƒ âˆ˜ Ï„ ]) Ï (T [ Ïƒ âˆ˜ Ï„ ]) Ïâ€²) (Î» rel â†’ RelExp (t [ Ïƒ âˆ˜ Ï„ ]) Ï (t [ Ïƒ ] [ Ï„ ]) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper Ïâ‰ˆÏâ€² = record
                        { âŸ¦TâŸ§   = rt.âŸ¦TâŸ§
                        ; âŸ¦Tâ€²âŸ§  = rt.âŸ¦Tâ€²âŸ§
                        ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§) rt.â†˜âŸ¦TâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§) rt.â†˜âŸ¦Tâ€²âŸ§
                        ; Tâ‰ˆTâ€²  = rt.Tâ‰ˆTâ€²
                        ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ (Ï„.nat Îº) (Ïƒ.nat Îº)) (rt.nat Îº)
                        ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ (Ï„.natâ€² Îº) (Ïƒ.natâ€² Îº)) (rt.natâ€² Îº)
                        }
                    , record
                        { âŸ¦tâŸ§   = re.âŸ¦tâŸ§
                        ; âŸ¦tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                        ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§) re.â†˜âŸ¦tâŸ§
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ Ï„.â†˜âŸ¦Î´âŸ§ (âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ re.â†˜âŸ¦tâ€²âŸ§)
                        ; tâ‰ˆtâ€²  = re.tâ‰ˆtâ€²
                        ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (âŸ¦âˆ˜âŸ§ (Ï„.nat Îº) (Ïƒ.nat Îº)) (re.nat Îº)
                        ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (Ï„.natâ€² Îº) (âŸ¦[]âŸ§ (Ïƒ.natâ€² Îº) (re.natâ€² Îº))
                        }
          where module Ï„ = RelSubsts (âŠ¨Ï„ Ïâ‰ˆÏâ€²)
                module Ïƒ = RelSubsts (âŠ¨Ïƒ (âŠ¨-irrel âŠ¨Î“â€² âŠ¨Î“â€²â‚ Ï„.Ïƒâ‰ˆÎ´))
                âŠ¨tÏ = âŠ¨t (âŠ¨-irrel âŠ¨Î“â€³ âŠ¨Î“â€³â‚ Ïƒ.Ïƒâ‰ˆÎ´)
                rt = projâ‚ âŠ¨tÏ
                re = projâ‚‚ âŠ¨tÏ
                module rt = RelTyp rt
                module re = RelExp re


[,]-v-zeâ€² : âˆ€ {i} â†’
            Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
            Î” âŠ¨ S âˆ¶ Se i â†’
            Î“ âŠ¨ s âˆ¶ (S [ Ïƒ ]) â†’
            --------------------------------
            Î“ âŠ¨ (v 0 [ Ïƒ , s ]) â‰ˆ s âˆ¶ (S [ Ïƒ ])
[,]-v-zeâ€² {_} {Ïƒ} {_} {S} {s} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨S) (âŠ¨Î“â‚ , âŠ¨s) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (S [ Ïƒ ]) Ï (S [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (v 0 [ Ïƒ , s ]) Ï s Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                help : Î£ (RelTyp (S [ Ïƒ ]) Ï (S [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (v 0 [ Ïƒ , s ]) Ï s Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
                help
                  with âŠ¨S (âŠ¨-irrel âŠ¨Î” âŠ¨Î”â‚ Ïƒ.Ïƒâ‰ˆÎ´) | âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
                ...  | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ ._ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ ._ ; Tâ‰ˆTâ€² = _ , U i<j _ }
                     , record { âŸ¦tâŸ§ = âŸ¦tâŸ§ ; âŸ¦tâ€²âŸ§ = âŸ¦tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² ; nat = nat ; natâ€² = natâ€² }
                     | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦Tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ â†˜âŸ¦ÏƒâŸ§â€² â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
                     , re
                     rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j
                           | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§
                           | âŸ¦âŸ§s-det â†˜âŸ¦ÏƒâŸ§â€² Ïƒ.â†˜âŸ¦Î´âŸ§
                           | âŸ¦âŸ§-det â†˜âŸ¦tâŸ§ â†˜âŸ¦TâŸ§
                           | âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§ â†˜âŸ¦TâŸ§â€² = record
                                                    { âŸ¦TâŸ§   = âŸ¦TâŸ§
                                                    ; âŸ¦Tâ€²âŸ§  = âŸ¦Tâ€²âŸ§
                                                    ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ â†˜âŸ¦TâŸ§
                                                    ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ â†˜âŸ¦TâŸ§â€²
                                                    ; Tâ‰ˆTâ€²  = Tâ‰ˆTâ€²
                                                    ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (Ïƒ.nat Îº) (nat Îº)
                                                    ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (Ïƒ.natâ€² Îº) (natâ€² Îº)
                                                    }
                                                , record
                                                    { âŸ¦tâŸ§   = re.âŸ¦tâŸ§
                                                    ; âŸ¦tâ€²âŸ§  = re.âŸ¦tâ€²âŸ§
                                                    ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) (âŸ¦vâŸ§ 0)
                                                    ; â†˜âŸ¦tâ€²âŸ§ = re.â†˜âŸ¦tâ€²âŸ§
                                                    ; tâ‰ˆtâ€²  = re.tâ‰ˆtâ€²
                                                    ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (âŸ¦,âŸ§ (Ïƒ.nat Îº) (re.nat Îº)) (âŸ¦vâŸ§ 0)
                                                    ; natâ€²  = re.natâ€²
                                                    }
                  where module re = RelExp re


[,]-v-suâ€² : âˆ€ {i x} â†’
            Î“ âŠ¨s Ïƒ âˆ¶ Î” â†’
            Î” âŠ¨ S âˆ¶ Se i â†’
            Î“ âŠ¨ s âˆ¶ (S [ Ïƒ ]) â†’
            x âˆ¶ T âˆˆ! Î” â†’
            ---------------------------------------------
            Î“ âŠ¨ (v (suc x) [ Ïƒ , s ]) â‰ˆ (v x [ Ïƒ ]) âˆ¶ (T [ Ïƒ ])
[,]-v-suâ€² {_} {Ïƒ} {_} {S} {s} {T} {_} {x} (âŠ¨Î“ , âŠ¨Î” , âŠ¨Ïƒ) (âŠ¨Î”â‚ , âŠ¨S) (âŠ¨Î“â‚ , âŠ¨s) TâˆˆÎ” = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (v (suc x) [ Ïƒ , s ]) Ï (v x [ Ïƒ ]) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper {Ï} {Ïâ€²} Ïâ‰ˆÏâ€² = help
          where module Ïƒ = RelSubsts (âŠ¨Ïƒ Ïâ‰ˆÏâ€²)
                module re = RelExp (projâ‚‚ (âŠ¨s (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)))
                help : Î£ (RelTyp (T [ Ïƒ ]) Ï (T [ Ïƒ ]) Ïâ€²) (Î» rel â†’ RelExp (v (suc x) [ Ïƒ , s ]) Ï (v x [ Ïƒ ]) Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
                help
                  with âŠ¨-lookup âŠ¨Î” TâˆˆÎ” Ïƒ.Ïƒâ‰ˆÎ´
                ... | rtâ€² , record { â†˜âŸ¦tâŸ§ = âŸ¦vâŸ§ _ ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦vâŸ§ _ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² }
                    = record
                        { âŸ¦TâŸ§   = rtâ€².âŸ¦TâŸ§
                        ; âŸ¦Tâ€²âŸ§  = rtâ€².âŸ¦Tâ€²âŸ§
                        ; â†˜âŸ¦TâŸ§  = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ rtâ€².â†˜âŸ¦TâŸ§
                        ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ rtâ€².â†˜âŸ¦Tâ€²âŸ§
                        ; Tâ‰ˆTâ€²  = rtâ€².Tâ‰ˆTâ€²
                        ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (Ïƒ.nat Îº) (rtâ€².nat Îº)
                        ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (Ïƒ.natâ€² Îº) (rtâ€².natâ€² Îº)
                        }
                    , record
                        { âŸ¦tâŸ§   = lookup Ïƒ.âŸ¦ÏƒâŸ§ x
                        ; âŸ¦tâ€²âŸ§  = lookup Ïƒ.âŸ¦Î´âŸ§ x
                        ; â†˜âŸ¦tâŸ§  = âŸ¦[]âŸ§ (âŸ¦,âŸ§ Ïƒ.â†˜âŸ¦ÏƒâŸ§ re.â†˜âŸ¦tâŸ§) (âŸ¦vâŸ§ _)
                        ; â†˜âŸ¦tâ€²âŸ§ = âŸ¦[]âŸ§ Ïƒ.â†˜âŸ¦Î´âŸ§ (âŸ¦vâŸ§ _)
                        ; tâ‰ˆtâ€²  = tâ‰ˆtâ€²
                        ; nat   = Î» Îº â†’ âŸ¦[]âŸ§ (âŸ¦,âŸ§ (Ïƒ.nat Îº) (re.nat Îº)) (âŸ¦vâŸ§ _)
                        ; natâ€²  = Î» Îº â†’ âŸ¦[]âŸ§ (Ïƒ.natâ€² Îº) (âŸ¦vâŸ§ _)
                        }
                    where module rtâ€² = RelTyp rtâ€²


â‰ˆ-convâ€² : âˆ€ {i} â†’
          Î“ âŠ¨ s â‰ˆ t âˆ¶ S â†’
          Î“ âŠ¨ S â‰ˆ T âˆ¶ Se i â†’
          --------------------
          Î“ âŠ¨ s â‰ˆ t âˆ¶ T
â‰ˆ-convâ€² {_} {s} {t} {S} {T} (âŠ¨Î“ , sâ‰ˆt) (âŠ¨Î“â‚ , Sâ‰ˆT) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp T Ï T Ïâ€²) (Î» rel â†’ RelExp s Ï t Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper Ïâ‰ˆÏâ€²
          with Sâ‰ˆT (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²) | Sâ‰ˆT (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²) | sâ‰ˆt Ïâ‰ˆÏâ€²
        ... | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ ._ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ ._ ; Tâ‰ˆTâ€² = _ , U i<j _ }
            , record { âŸ¦tâ€²âŸ§ = âŸ¦TâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦SâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦TâŸ§ ; tâ‰ˆtâ€² = âŸ¦Sâ‰ˆTâŸ§ ; natâ€² = natâ€²â‚ }
            | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ ._ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ ._ ; Tâ‰ˆTâ€² = _ , U i<jâ€² _ }
            , record { âŸ¦tâ€²âŸ§ = âŸ¦TâŸ§â€² ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦SâŸ§â€² ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦TâŸ§â€² ; tâ‰ˆtâ€² = âŸ¦Sâ‰ˆTâŸ§â€² ; natâ€² = natâ€²â‚‚ }
            | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦SâŸ§â€³ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§â€³ ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€² }
            , re
            rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<j
                  | ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<jâ€²
                  | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€² â†˜âŸ¦SâŸ§
                  | âŸ¦âŸ§-det â†˜âŸ¦SâŸ§â€³ â†˜âŸ¦SâŸ§ = record
                                          { âŸ¦TâŸ§   = âŸ¦TâŸ§â€²
                                          ; âŸ¦Tâ€²âŸ§  = âŸ¦TâŸ§
                                          ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦TâŸ§â€²
                                          ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§
                                          ; Tâ‰ˆTâ€²  = _ , ğ•Œ-trans (ğ•Œ-sym âŸ¦Sâ‰ˆTâŸ§â€²) âŸ¦Sâ‰ˆTâŸ§
                                          ; nat   = natâ€²â‚‚
                                          ; natâ€²  = natâ€²â‚
                                          }
                                      , record
                                          { âŸ¦tâŸ§   = âŸ¦tâŸ§
                                          ; âŸ¦tâ€²âŸ§  = âŸ¦tâ€²âŸ§
                                          ; â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâŸ§
                                          ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§
                                          ; tâ‰ˆtâ€²  = El-one-sidedâ€² âŸ¦Sâ‰ˆTâŸ§ (ğ•Œ-trans (ğ•Œ-sym âŸ¦Sâ‰ˆTâŸ§â€²) âŸ¦Sâ‰ˆTâŸ§) (El-one-sided Tâ‰ˆTâ€² âŸ¦Sâ‰ˆTâŸ§ tâ‰ˆtâ€²)
                                          ; nat   = nat
                                          ; natâ€²  = natâ€²
                                          }
          where open RelExp re


â‰ˆ-symâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
         ----------------
         Î“ âŠ¨ tâ€² â‰ˆ t âˆ¶ T
â‰ˆ-symâ€² {_} {t} {tâ€²} {T} (âŠ¨Î“ , tâ‰ˆtâ€²) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp T Ï T Ïâ€²) (Î» rel â†’ RelExp tâ€² Ï t Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper Ïâ‰ˆÏâ€²
          with tâ‰ˆtâ€² (âŸ¦âŸ§Ï-symâ€² âŠ¨Î“ Ïâ‰ˆÏâ€²)
        ...  | rt , re = record
                           { âŸ¦TâŸ§   = âŸ¦Tâ€²âŸ§
                           ; âŸ¦Tâ€²âŸ§  = âŸ¦TâŸ§
                           ; â†˜âŸ¦TâŸ§  = â†˜âŸ¦Tâ€²âŸ§
                           ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦TâŸ§
                           ; Tâ‰ˆTâ€²  = _ , ğ•Œ-sym (projâ‚‚ Tâ‰ˆTâ€²)
                           ; nat   = rt.natâ€²
                           ; natâ€²  = rt.nat
                           }
                       , record
                           { âŸ¦tâŸ§   = âŸ¦tâ€²âŸ§
                           ; âŸ¦tâ€²âŸ§  = âŸ¦tâŸ§
                           ; â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâ€²âŸ§
                           ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâŸ§
                           ; tâ‰ˆtâ€²  = El-sym (projâ‚‚ Tâ‰ˆTâ€²) (ğ•Œ-sym (projâ‚‚ Tâ‰ˆTâ€²)) re.tâ‰ˆtâ€²
                           ; nat   = re.natâ€²
                           ; natâ€²  = re.nat
                           }
          where module rt = RelTyp rt
                module re = RelExp re
                open rt
                open re


â‰ˆ-transâ€² : Î“ âŠ¨ t â‰ˆ tâ€² âˆ¶ T â†’
           Î“ âŠ¨ tâ€² â‰ˆ tâ€³ âˆ¶ T â†’
           ------ ------------
           Î“ âŠ¨ t â‰ˆ tâ€³ âˆ¶ T
â‰ˆ-transâ€² {_} {t} {tâ€²} {T} {tâ€³} (âŠ¨Î“ , tâ‰ˆtâ€²) (âŠ¨Î“â‚ , tâ€²â‰ˆtâ€³) = âŠ¨Î“ , helper
  where helper : Ï â‰ˆ Ïâ€² âˆˆ âŸ¦ âŠ¨Î“ âŸ§Ï â†’ Î£ (RelTyp T Ï T Ïâ€²) (Î» rel â†’ RelExp t Ï tâ€³ Ïâ€² (Elâˆ (RelTyp.Tâ‰ˆTâ€² rel)))
        helper Ïâ‰ˆÏâ€²
          with tâ‰ˆtâ€² (âŸ¦âŸ§Ï-refl âŠ¨Î“ âŠ¨Î“ Ïâ‰ˆÏâ€²) | tâ€²â‰ˆtâ€³ (âŠ¨-irrel âŠ¨Î“ âŠ¨Î“â‚ Ïâ‰ˆÏâ€²)
        ... | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§ ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€² }
            , record { âŸ¦tâŸ§ = âŸ¦tâŸ§   ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€²âŸ§ ; tâ‰ˆtâ€² = tâ‰ˆtâ€² ; nat = nat }
            | rt@record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â€² ; Tâ‰ˆTâ€² = _ , Tâ‰ˆTâ€²â‚ }
            , record { âŸ¦tâ€²âŸ§ = âŸ¦tâ€³âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâ€²âŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€³âŸ§ ; tâ‰ˆtâ€² = tâ€²â‰ˆtâ€³ ; natâ€² = natâ€² }
            rewrite âŸ¦âŸ§-det â†˜âŸ¦tâ€²âŸ§â‚ â†˜âŸ¦tâ€²âŸ§
                  | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§ â†˜âŸ¦TâŸ§â€² = rt
                                      , record
                                          { âŸ¦tâŸ§   = âŸ¦tâŸ§
                                          ; âŸ¦tâ€²âŸ§  = âŸ¦tâ€³âŸ§
                                          ; â†˜âŸ¦tâŸ§  = â†˜âŸ¦tâŸ§
                                          ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦tâ€³âŸ§
                                          ; tâ‰ˆtâ€²  = El-transâ€² Tâ‰ˆTâ€²â‚ (El-one-sided Tâ‰ˆTâ€² Tâ‰ˆTâ€²â‚ tâ‰ˆtâ€²) tâ€²â‰ˆtâ€³
                                          ; nat   = nat
                                          ; natâ€²  = natâ€²
                                          }
