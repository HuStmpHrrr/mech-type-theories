{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

module kMLTT.Soundness.Substitutions (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Lib
open import Data.Nat.Properties

open import kMLTT.Statics.Properties
open import kMLTT.Semantics.Properties.Domain fext
open import kMLTT.Semantics.Properties.PER fext
open import kMLTT.Soundness.LogRel
open import kMLTT.Soundness.ToSyntax fext
open import kMLTT.Soundness.Contexts fext
open import kMLTT.Soundness.Properties.LogRel fext
open import kMLTT.Soundness.Properties.Substitutions fext
open import kMLTT.Soundness.Cumulativity fext


s-Iâ€² : âŠ© Î“ â†’
       ------------
       Î“ âŠ©s I âˆ¶ Î“
s-Iâ€² âŠ©Î“ = record
  { âŠ©Î“   = âŠ©Î“
  ; âŠ©Î“â€²  = âŠ©Î“
  ; krip = helper
  }
  where helper : Î” âŠ¢s Ïƒ âˆ¶ âŠ©Î“ Â® Ï â†’ GluSubsts Î” I âŠ©Î“ Ïƒ Ï
        helper {Ï = Ï} Ïƒâˆ¼Ï = record
          { âŸ¦Ï„âŸ§    = Ï
          ; â†˜âŸ¦Ï„âŸ§   = âŸ¦IâŸ§
          ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = sÂ®-resp-sâ‰ˆ âŠ©Î“ Ïƒâˆ¼Ï (s-â‰ˆ-sym (I-âˆ˜ (sÂ®â‡’âŠ¢s âŠ©Î“ Ïƒâˆ¼Ï)))
          }

s-wkâ€² : âŠ© T âˆº Î“ â†’
        ------------------
        T âˆº Î“ âŠ©s wk âˆ¶ Î“
s-wkâ€² âŠ©TÎ“@(âŠ©âˆº âŠ©Î“ âŠ¢T gT) = record
  { âŠ©Î“   = âŠ©TÎ“
  ; âŠ©Î“â€²  = âŠ©Î“
  ; krip = helper
  }
  where helper : Î” âŠ¢s Ïƒ âˆ¶ âŠ©TÎ“ Â® Ï â†’ GluSubsts Î” wk âŠ©Î“ Ïƒ Ï
        helper {Ï = Ï} Ïƒâˆ¼Ï = record
          { âŸ¦Ï„âŸ§    = drop Ï
          ; â†˜âŸ¦Ï„âŸ§   = âŸ¦wkâŸ§
          ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = sÂ®-resp-sâ‰ˆ âŠ©Î“ step (s-â‰ˆ-sym â‰ˆpÏƒ)
          }
          where open Gluâˆº Ïƒâˆ¼Ï

s-âˆ˜â€² : Î“ âŠ©s Ï„ âˆ¶ Î“â€² â†’
       Î“â€² âŠ©s Ïƒ âˆ¶ Î“â€³ â†’
       ----------------
       Î“ âŠ©s Ïƒ âˆ˜ Ï„ âˆ¶ Î“â€³
s-âˆ˜â€² {_} {Ï„} {_} {Ïƒ} âŠ©Ï„ âŠ©Ïƒ = record
  { âŠ©Î“   = âŠ©Ï„.âŠ©Î“
  ; âŠ©Î“â€²  = âŠ©Ïƒ.âŠ©Î“â€²
  ; krip = helper
  }
  where module âŠ©Ï„ = _âŠ©s_âˆ¶_ âŠ©Ï„
        module âŠ©Ïƒ = _âŠ©s_âˆ¶_ âŠ©Ïƒ
        âŠ¢Ï„ = âŠ©sâ‡’âŠ¢s âŠ©Ï„
        âŠ¢Ïƒ = âŠ©sâ‡’âŠ¢s âŠ©Ïƒ
        helper : Î” âŠ¢s Ïƒâ€² âˆ¶ âŠ©Ï„.âŠ©Î“ Â® Ï â†’ GluSubsts Î” (Ïƒ âˆ˜ Ï„) âŠ©Ïƒ.âŠ©Î“â€² Ïƒâ€² Ï
        helper {_} {Ïƒâ€²} {Ï} Ïƒâ€²âˆ¼Ï = record
          { âŸ¦Ï„âŸ§    = Ïƒ.âŸ¦Ï„âŸ§
          ; â†˜âŸ¦Ï„âŸ§   = âŸ¦âˆ˜âŸ§ Ï„.â†˜âŸ¦Ï„âŸ§ Ïƒ.â†˜âŸ¦Ï„âŸ§
          ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = sÂ®-resp-sâ‰ˆ âŠ©Ïƒ.âŠ©Î“â€² Ïƒ.Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ (s-â‰ˆ-sym (âˆ˜-assoc âŠ¢Ïƒ âŠ¢Ï„ (sÂ®â‡’âŠ¢s âŠ©Ï„.âŠ©Î“ Ïƒâ€²âˆ¼Ï)))
          }
          where module Ï„ = GluSubsts (âŠ©Ï„.krip Ïƒâ€²âˆ¼Ï)
                module Ïƒ = GluSubsts (âŠ©Ïƒ.krip (sÂ®-irrel âŠ©Ï„.âŠ©Î“â€² âŠ©Ïƒ.âŠ©Î“ Ï„.Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§))

s-,â€² : âˆ€ {i} â†’
       Î“ âŠ©s Ïƒ âˆ¶ Î” â†’
       Î” âŠ© T âˆ¶ Se i â†’
       Î“ âŠ© t âˆ¶ T [ Ïƒ ] â†’
       -------------------
       Î“ âŠ©s Ïƒ , t âˆ¶ T âˆº Î”
s-,â€² {_} {Ïƒ} {_} {T} {t} {i} âŠ©Ïƒ âŠ©T âŠ©t = record
  { âŠ©Î“   = âŠ©Ïƒ.âŠ©Î“
  ; âŠ©Î“â€²  = âŠ©TÎ”
  ; krip = helper
  }
  where module âŠ©Ïƒ = _âŠ©s_âˆ¶_ âŠ©Ïƒ
        module âŠ©T = _âŠ©_âˆ¶_ âŠ©T
        module âŠ©t = _âŠ©_âˆ¶_ âŠ©t
        âŠ¢Ïƒ  = âŠ©sâ‡’âŠ¢s âŠ©Ïƒ
        âŠ¢t  = âŠ©â‡’âŠ¢-tm âŠ©t
        âŠ¢T  = âŠ©â‡’âŠ¢-tm âŠ©T
        âŠ©TÎ” = âŠ¢âˆºâ€² âŠ©T
        âŠ¢TÎ” = âŠ©â‡’âŠ¢ âŠ©TÎ”
        helper : Î”â€² âŠ¢s Ï„ âˆ¶ âŠ©Ïƒ.âŠ©Î“ Â® Ï â†’ GluSubsts Î”â€² (Ïƒ , t) âŠ©TÎ” Ï„ Ï
        helper {_} {Ï„} {Ï} Ï„âˆ¼Ï
          with âŠ©Ïƒ.krip Ï„âˆ¼Ï
             | âŠ©t.krip (sÂ®-irrel âŠ©Ïƒ.âŠ©Î“ âŠ©t.âŠ©Î“ Ï„âˆ¼Ï)
        ...  | ÏƒÏ„@record { âŸ¦Ï„âŸ§ = âŸ¦Ï„âŸ§ ; â†˜âŸ¦Ï„âŸ§ = â†˜âŸ¦Ï„âŸ§ ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ }
             | record { âŸ¦TâŸ§ = âŸ¦TâŸ§ ; âŸ¦tâŸ§ = âŸ¦tâŸ§ ; â†˜âŸ¦TâŸ§ = âŸ¦[]âŸ§ â†˜Ïâ€² â†˜âŸ¦TâŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦tâŸ§ ; Tâˆˆğ•Œ = Tâˆˆğ•Œ ; tâˆ¼âŸ¦tâŸ§ = tâˆ¼âŸ¦tâŸ§ }
             with âŠ©T.krip (sÂ®-irrel âŠ©Ïƒ.âŠ©Î“â€² âŠ©T.âŠ©Î“ Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§)
        ... | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ .i ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§â€² ; Tâˆˆğ•Œ = U i<l _ ; tâˆ¼âŸ¦tâŸ§ = Tâˆ¼âŸ¦TâŸ§ }
             rewrite Glu-wellfounded-â‰¡ i<l
                   | âŸ¦âŸ§s-det â†˜Ïâ€² â†˜âŸ¦Ï„âŸ§
                   | âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â€² â†˜âŸ¦TâŸ§ = record
              { âŸ¦Ï„âŸ§    = âŸ¦Ï„âŸ§ â†¦ âŸ¦tâŸ§
              ; â†˜âŸ¦Ï„âŸ§   = âŸ¦,âŸ§ â†˜âŸ¦Ï„âŸ§ â†˜âŸ¦tâŸ§
              ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = record
                { âŠ¢Ïƒ   = s-âˆ˜ âŠ¢Ï„ âŠ¢Ïƒ,t
                ; pÏƒ   = Ïƒ âˆ˜ Ï„
                ; v0Ïƒ  = t [ Ï„ ]
                ; âŸ¦TâŸ§  = âŸ¦TâŸ§
                ; â‰ˆpÏƒ  = s-â‰ˆ-trans (p-âˆ˜ âŠ¢Ïƒ,t âŠ¢Ï„) (âˆ˜-cong (s-â‰ˆ-refl âŠ¢Ï„) (p-, âŠ¢Ïƒ âŠ¢T âŠ¢t))
                ; â‰ˆv0Ïƒ = let open ER
                         in â‰ˆ-conv (begin
                                     v 0 [ (Ïƒ , t) âˆ˜ Ï„ ] â‰ˆâŸ¨ â‰ˆ-conv ([âˆ˜] âŠ¢Ï„ âŠ¢Ïƒ,t (vlookup âŠ¢TÎ” here))
                                                                   eq âŸ©
                                     v 0 [ Ïƒ , t ] [ Ï„ ] â‰ˆâŸ¨ []-cong ([,]-v-ze âŠ¢Ïƒ âŠ¢T âŠ¢t) (s-â‰ˆ-refl âŠ¢Ï„) âŸ©
                                     t [ Ï„ ]             âˆ)
                                   ([âˆ˜]-Se âŠ¢T âŠ¢Ïƒ âŠ¢Ï„)
                ; â†˜âŸ¦TâŸ§ = subst (âŸ¦ _ âŸ§_â†˜ _) dropâ‰¡ â†˜âŸ¦TâŸ§
                ; Tâˆˆğ•Œ  = T.Aâˆˆğ•Œ -- Tâˆˆğ•Œâ€²
                ; tâˆ¼Ï0 = Â®El-master Tâˆˆğ•Œ T.Aâˆˆğ•Œ T.Aâˆˆğ•Œ T.rel tâˆ¼âŸ¦tâŸ§ ([âˆ˜]-Se âŠ¢T âŠ¢Ïƒ âŠ¢Ï„)
                ; step = subst (_ âŠ¢s _ âˆ˜ _ âˆ¶ _ Â®_) dropâ‰¡ (sÂ®-irrel âŠ©Ïƒ.âŠ©Î“â€² âŠ©T.âŠ©Î“ Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§)
                }
              }
          where module T = GluU Tâˆ¼âŸ¦TâŸ§
                âŠ¢Ï„    = sÂ®â‡’âŠ¢s âŠ©Ïƒ.âŠ©Î“ Ï„âˆ¼Ï
                âŠ¢Ïƒ,t  = s-, âŠ¢Ïƒ âŠ¢T âŠ¢t
                dropâ‰¡ = sym (drop-â†¦ âŸ¦Ï„âŸ§ âŸ¦tâŸ§)
                eq    = begin
                  T [ wk ] [ (Ïƒ , t) âˆ˜ Ï„ ] â‰ˆâŸ¨ [âˆ˜]-Se âŠ¢T (s-wk âŠ¢TÎ”) (s-âˆ˜ âŠ¢Ï„ âŠ¢Ïƒ,t) âŸ©
                  T [ p ((Ïƒ , t) âˆ˜ Ï„) ]    â‰ˆâŸ¨ []-cong-Seâ€³ âŠ¢T (p-âˆ˜ âŠ¢Ïƒ,t âŠ¢Ï„) âŸ©
                  T [ p (Ïƒ , t) âˆ˜ Ï„ ]      â‰ˆâŸ¨ []-cong-Seâ€³ âŠ¢T (âˆ˜-cong (s-â‰ˆ-refl âŠ¢Ï„) (p-, âŠ¢Ïƒ âŠ¢T âŠ¢t)) âŸ©
                  T [ Ïƒ âˆ˜ Ï„ ]              â‰ˆË˜âŸ¨ [âˆ˜]-Se âŠ¢T âŠ¢Ïƒ âŠ¢Ï„ âŸ©
                  T [ Ïƒ ] [ Ï„ ]            âˆ
                  where open ER

s-ï¼›â€² : âˆ€ {n} Î¨s â†’
       Î“ âŠ©s Ïƒ âˆ¶ Î” â†’
       âŠ© Î¨s ++âº Î“ â†’
       len Î¨s â‰¡ n â†’
       -----------------------------
       Î¨s ++âº Î“ âŠ©s Ïƒ ï¼› n âˆ¶ [] âˆ·âº Î”
s-ï¼›â€² {_} {Ïƒ} {n = n} Î¨s âŠ©Ïƒ âŠ©Î¨sÎ“ refl = record
  { âŠ©Î“   = âŠ©Î¨sÎ“
  ; âŠ©Î“â€²  = âŠ©Îº âŠ©Ïƒ.âŠ©Î“â€²
  ; krip = helper
  }
  where module âŠ©Ïƒ = _âŠ©s_âˆ¶_ âŠ©Ïƒ
        âŠ¢Î¨sÎ“ = âŠ©â‡’âŠ¢ âŠ©Î¨sÎ“
        âŠ¢Ïƒ   = âŠ©sâ‡’âŠ¢s âŠ©Ïƒ
        helper : Î”â€² âŠ¢s Ï„ âˆ¶ âŠ©Î¨sÎ“ Â® Ï â†’ GluSubsts Î”â€² (Ïƒ ï¼› n) (âŠ©Îº âŠ©Ïƒ.âŠ©Î“â€²) Ï„ Ï
        helper {_} {Ï„} {Ï} Ï„âˆ¼Ï
          with âˆ¥-sÂ®â€² Î¨s âŠ©Î¨sÎ“ Ï„âˆ¼Ï
        ...  | Î¨sâ€² , Î”â€³ , refl , eql , âŠ¢Î“â‚ , Ï„âˆ¼Ïâˆ¥ = record
          { âŸ¦Ï„âŸ§    = ext âŸ¦Ï„âŸ§ (O Ï n)
          ; â†˜âŸ¦Ï„âŸ§   = âŸ¦ï¼›âŸ§ â†˜âŸ¦Ï„âŸ§
          ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = record
            { âŠ¢Ïƒ   = s-âˆ˜ âŠ¢Ï„ (s-ï¼› Î¨s âŠ¢Ïƒ âŠ¢Î¨sÎ“ refl)
            ; Î¨sâ»  = Î¨sâ€²
            ; Î“âˆ¥   = Î”â€³
            ; Ïƒâˆ¥   = Ïƒ âˆ˜ Ï„ âˆ¥ n
            ; Î“â‰¡   = refl
            ; â‰ˆÏƒâˆ¥  = subst (Î» x â†’ _ âŠ¢s Ïƒ âˆ˜ Ï„ âˆ¥ x â‰ˆ _ âˆ˜ Ï„ âˆ¥ n âˆ¶ _) (sym (+-identityÊ³ n)) (s-â‰ˆ-refl (s-âˆ˜ âŠ¢Ï„âˆ¥ âŠ¢Ïƒ))
            ; Oâ‰¡   = trans (cong (O Ï„) (+-identityÊ³ n)) (sÂ®-resp-O n âŠ©Î¨sÎ“ Ï„âˆ¼Ï (length-<-++âº Î¨s))
            ; lenâ‰¡ = trans eql (sym (cong (O Ï„) (+-identityÊ³ n)))
            ; step = Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§
            }
          }
          where open GluSubsts (âŠ©Ïƒ.krip (sÂ®-irrel âŠ¢Î“â‚ âŠ©Ïƒ.âŠ©Î“ Ï„âˆ¼Ïâˆ¥))
                âŠ¢Ï„  = sÂ®â‡’âŠ¢s âŠ©Î¨sÎ“ Ï„âˆ¼Ï
                âŠ¢Ï„âˆ¥ = sÂ®â‡’âŠ¢s âŠ¢Î“â‚ Ï„âˆ¼Ïâˆ¥


s-convâ€² : Î“ âŠ©s Ïƒ âˆ¶ Î” â†’
          âŠ¢ Î” â‰ˆ Î”â€² â†’
          -------------
          Î“ âŠ©s Ïƒ âˆ¶ Î”â€²
s-convâ€² {_} {Ïƒ} âŠ©Ïƒ Î”â‰ˆÎ”â€²
  with presup-âŠ¢â‰ˆ Î”â‰ˆÎ”â€²
...  | _ , âŠ¢Î”â€² = record
  { âŠ©Î“   = âŠ©Ïƒ.âŠ©Î“
  ; âŠ©Î“â€²  = âŠ©Î”â€²
  ; krip = helper
  }
  where module âŠ©Ïƒ = _âŠ©s_âˆ¶_ âŠ©Ïƒ
        âŠ©Î”â€² = âŠ©-resp-â‰ˆ âŠ©Ïƒ.âŠ©Î“â€² Î”â‰ˆÎ”â€²
        helper : Î”â€³ âŠ¢s Ï„ âˆ¶ âŠ©Ïƒ.âŠ©Î“ Â® Ï â†’ GluSubsts Î”â€³ Ïƒ âŠ©Î”â€² Ï„ Ï
        helper {_} {Ï„} Ï„âˆ¼Ï = record
          { âŸ¦Ï„âŸ§    = âŸ¦Ï„âŸ§
          ; â†˜âŸ¦Ï„âŸ§   = â†˜âŸ¦Ï„âŸ§
          ; Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ = sÂ®-resp-â‰ˆâ€² âŠ©Ïƒ.âŠ©Î“â€² âŠ©Î”â€² Ï„Ïƒâˆ¼âŸ¦Ï„âŸ§ Î”â‰ˆÎ”â€²
          }
          where open GluSubsts (âŠ©Ïƒ.krip Ï„âˆ¼Ï)
