{-# OPTIONS --without-K --safe #-}

open import Axiom.Extensionality.Propositional

-- prove that the gluing model is cumulative
module kMLTT.Soundness.Properties.Substitutions (fext : âˆ€ {â„“ â„“â€²} â†’ Extensionality â„“ â„“â€²) where

open import Lib
open import Data.Nat.Properties as â„•â‚š
open import Data.List.Properties as Lâ‚š

open import kMLTT.Statics.Properties as Sta
open import kMLTT.Semantics.Readback
open import kMLTT.Semantics.Realizability fext
open import kMLTT.Semantics.Properties.Domain fext as Sem
open import kMLTT.Semantics.Properties.Evaluation fext
open import kMLTT.Semantics.Properties.PER fext
open import kMLTT.Completeness.LogRel
open import kMLTT.Completeness.Contexts fext
open import kMLTT.Completeness.Fundamental fext
open import kMLTT.Soundness.LogRel
open import kMLTT.Soundness.Properties.LogRel fext
open import kMLTT.Soundness.Properties.Mt fext


sÂ®â‡’âŠ¢s : (âŠ¢Î” : âŠ¢ Î”) â†’
         Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
         -----------------
         Î“ âŠ¢s Ïƒ âˆ¶ Î”
sÂ®â‡’âŠ¢s âŠ¢[]      Ïƒâˆ¼Ï = Ïƒâˆ¼Ï
sÂ®â‡’âŠ¢s (âŠ¢Îº _)   Ïƒâˆ¼Ï = GluÎº.âŠ¢Ïƒ Ïƒâˆ¼Ï
sÂ®â‡’âŠ¢s (âŠ¢âˆº _ _) Ïƒâˆ¼Ï = Gluâˆº.âŠ¢Ïƒ Ïƒâˆ¼Ï


sÂ®â‡’âŸ¦âŸ§Ï : (âŠ¢Î” : âŠ¢ Î”) â†’
          Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
          --------------------------
          Ï âˆˆâ€² âŸ¦ fundamental-âŠ¢Î“ âŠ¢Î” âŸ§Ï
sÂ®â‡’âŸ¦âŸ§Ï âŠ¢[] Ïƒâˆ¼Ï       = _
sÂ®â‡’âŸ¦âŸ§Ï (âŠ¢Îº âŠ¢Î”) Ïƒâˆ¼Ï
  with sÂ®â‡’âŸ¦âŸ§Ï âŠ¢Î” (GluÎº.step Ïƒâˆ¼Ï)
...  | Ïâˆˆ        = Ïâˆˆ , refl
sÂ®â‡’âŸ¦âŸ§Ï {_} {_} {_} {Ï} (âŠ¢âˆº âŠ¢Î” âŠ¢T) Ïƒâˆ¼Ï
  with fundamental-âŠ¢Î“ âŠ¢Î” | fundamental-âŠ¢t âŠ¢T | sÂ®â‡’âŸ¦âŸ§Ï âŠ¢Î” (Gluâˆº.step Ïƒâˆ¼Ï)
...  | âŠ¨Î” | âŠ¨T | Ïâˆˆ = Ïâˆˆ , helper
  where
    open Gluâˆº Ïƒâˆ¼Ï

    helper : lookup Ï 0 âˆˆâ€² El _ (RelTyp.Tâ‰ˆTâ€² (âˆº-cong-helper âŠ¨T âŠ¨Î” Ïâˆˆ))
    helper
      with âˆº-cong-helper âŠ¨T âŠ¨Î” Ïâˆˆ
    ...  | record { â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦Tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; Tâ‰ˆTâ€² = Tâ‰ˆTâ€² }
        rewrite âŸ¦âŸ§-det â†˜âŸ¦TâŸ§â‚ â†˜âŸ¦TâŸ§
              | âŸ¦âŸ§-det â†˜âŸ¦Tâ€²âŸ§â‚ â†˜âŸ¦TâŸ§ = ğ•Œ-irrel Tâˆˆğ•Œ Tâ‰ˆTâ€² (Â®Elâ‡’âˆˆEl Tâˆˆğ•Œ tâˆ¼Ï0)

sÂ®â‡’âŸ¦âŸ§Ïâ€² : (âŠ¢Î” : âŠ¢ Î”) â†’
           Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
           --------------------------
           Î£ (âŠ¨ Î”) Î» âŠ¨Î” â†’ Ï âˆˆâ€² âŸ¦ âŠ¨Î” âŸ§Ï
sÂ®â‡’âŸ¦âŸ§Ïâ€² âŠ¢Î” Ïƒâˆ¼Ï = fundamental-âŠ¢Î“ âŠ¢Î” , sÂ®â‡’âŸ¦âŸ§Ï âŠ¢Î” Ïƒâˆ¼Ï


sÂ®-resp-sâ‰ˆ : (âŠ¢Î” : âŠ¢ Î”) â†’
              Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
              Î“ âŠ¢s Ïƒ â‰ˆ Ïƒâ€² âˆ¶ Î” â†’
              -------------------
              Î“ âŠ¢s Ïƒâ€² âˆ¶ âŠ¢Î” Â® Ï
sÂ®-resp-sâ‰ˆ                      âŠ¢[]     Ïƒâˆ¼Ï Ïƒâ‰ˆÏƒâ€² = projâ‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ Ïƒâ‰ˆÏƒâ€²)))
sÂ®-resp-sâ‰ˆ {_} {Î“} {_} {Ï} {Ïƒâ€²} (âŠ¢Îº âŠ¢Î”) Ïƒâˆ¼Ï Ïƒâ‰ˆÏƒâ€² = helper
  where
    module gluÎº = GluÎº Ïƒâˆ¼Ï
    open gluÎº

    helper : Î“ âŠ¢s Ïƒâ€² âˆ¶ âŠ¢Îº âŠ¢Î” Â® Ï
    helper = record
             { gluÎº
             ; âŠ¢Ïƒ = projâ‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ Ïƒâ‰ˆÏƒâ€²)))
             ; â‰ˆÏƒâˆ¥ = s-â‰ˆ-trans (s-â‰ˆ-sym (âˆ¥-resp-â‰ˆâ€³ Î¨sâ» L.[ [] ] (subst (_âŠ¢s _ â‰ˆ _ âˆ¶ _) Î“â‰¡ Ïƒâ‰ˆÏƒâ€²) lenâ‰¡)) â‰ˆÏƒâˆ¥
             ; Oâ‰¡ = trans (sym (O-resp-â‰ˆ 1 Ïƒâ‰ˆÏƒâ€²)) Oâ‰¡
             ; lenâ‰¡ = trans lenâ‰¡ (O-resp-â‰ˆ 1 Ïƒâ‰ˆÏƒâ€²)
             }
sÂ®-resp-sâ‰ˆ {_} {Î“} {_} {Ï} {Ïƒâ€²} âŠ¢TÎ”@(âŠ¢âˆº âŠ¢Î” _) Ïƒâˆ¼Ï Ïƒâ‰ˆÏƒâ€² = helper
  where
    module gluâˆº = Gluâˆº Ïƒâˆ¼Ï
    open gluâˆº

    Ïƒâ€²â‰ˆÏƒ = s-â‰ˆ-sym Ïƒâ‰ˆÏƒâ€²
    âŠ¢Ïƒâ€² = projâ‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ Ïƒâ‰ˆÏƒâ€²)))

    helper : Î“ âŠ¢s Ïƒâ€² âˆ¶ âŠ¢âˆº âŠ¢Î” âŠ¢T Â® Ï
    helper = record
             { gluâˆº
             ; âŠ¢Ïƒ = âŠ¢Ïƒâ€²
             ; â‰ˆpÏƒ = s-â‰ˆ-trans (p-cong (projâ‚‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ Ïƒâ‰ˆÏƒâ€²)))) Ïƒâ€²â‰ˆÏƒ) â‰ˆpÏƒ
             ; â‰ˆv0Ïƒ = â‰ˆ-trans (â‰ˆ-conv ([]-cong (â‰ˆ-refl (vlookup âŠ¢TÎ” here)) Ïƒâ€²â‰ˆÏƒ) (â‰ˆ-trans (â‰ˆ-trans ([âˆ˜]-Se âŠ¢T (s-wk âŠ¢TÎ”) âŠ¢Ïƒâ€²) ([]-cong-Seâ€³ âŠ¢T (âˆ˜-cong Ïƒâ€²â‰ˆÏƒ (wk-â‰ˆ âŠ¢TÎ”)))) ([]-cong-Seâ€³ âŠ¢T â‰ˆpÏƒ))) â‰ˆv0Ïƒ
             }


sÂ®-resp-â‰ˆ : (âŠ¢Î” : âŠ¢ Î”) â†’
             Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
             âŠ¢ Î” â‰ˆ Î”â€² â†’
             -------------------
             Î£ (âŠ¢ Î”â€²) Î» âŠ¢Î”â€² â†’ Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î”â€² Â® Ï
sÂ®-resp-â‰ˆ âŠ¢[] Ïƒâˆ¼Ï []-â‰ˆ = âŠ¢[] , Ïƒâˆ¼Ï
sÂ®-resp-â‰ˆ (âŠ¢Îº âŠ¢Î”) Ïƒâˆ¼Ï (Îº-cong Î”â‰ˆÎ”â€²)
  with sÂ®-resp-â‰ˆ âŠ¢Î” (GluÎº.step Ïƒâˆ¼Ï) Î”â‰ˆÎ”â€²
...  | âŠ¢Î”â€² , Ïƒâˆ¼Ïâ€² = âŠ¢Îº âŠ¢Î”â€²
                   , record
                     { gluÎº
                     ; âŠ¢Ïƒ = s-conv âŠ¢Ïƒ (Îº-cong Î”â‰ˆÎ”â€²)
                     ; â‰ˆÏƒâˆ¥ = s-â‰ˆ-conv â‰ˆÏƒâˆ¥ Î”â‰ˆÎ”â€²
                     ; step = Ïƒâˆ¼Ïâ€²
                     }
  where
    open module gluÎº = GluÎº Ïƒâˆ¼Ï
sÂ®-resp-â‰ˆ {(_ âˆ· Î¨) âˆ· Î¨s} {Î“} (âŠ¢âˆº âŠ¢Î” _) Ïƒâˆ¼Ï (âˆº-cong {i = i} Î”â‰ˆÎ”â€² Tâ‰ˆTâ€²)
  with sÂ®-resp-â‰ˆ âŠ¢Î” (Gluâˆº.step Ïƒâˆ¼Ï) Î”â‰ˆÎ”â€² | fundamental-tâ‰ˆtâ€² Tâ‰ˆTâ€² | presup-â‰ˆ Tâ‰ˆTâ€²
...  | âŠ¢Î”â€² , Ïƒâˆ¼Ïâ€²
     | âŠ¨Î”â‚ , _ , Trelâ‚
     | _ , _ , âŠ¢Tâ€² , _
    with Trelâ‚ (âŠ¨-irrel (fundamental-âŠ¢Î“ âŠ¢Î”) âŠ¨Î”â‚ (sÂ®â‡’âŸ¦âŸ§Ï âŠ¢Î” (Gluâˆº.step Ïƒâˆ¼Ï)))
...    | record { â†˜âŸ¦TâŸ§ = âŸ¦SeâŸ§ _ ; â†˜âŸ¦Tâ€²âŸ§ = âŸ¦SeâŸ§ _ ; Tâ‰ˆTâ€² = U i<n _ }
       , record { âŸ¦tâ€²âŸ§ = âŸ¦Tâ€²âŸ§ ; â†˜âŸ¦tâŸ§ = â†˜âŸ¦TâŸ§â‚ ; â†˜âŸ¦tâ€²âŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚ ; tâ‰ˆtâ€² = Tâ‰ˆTâ€²â‚ }
      rewrite ğ•Œ-wellfounded-â‰¡-ğ•Œ _ i<n
            | âŸ¦âŸ§-det (Gluâˆº.â†˜âŸ¦TâŸ§ Ïƒâˆ¼Ï) â†˜âŸ¦TâŸ§â‚ = âŠ¢âˆº âŠ¢Î”â€² (ctxeq-tm Î”â‰ˆÎ”â€² (projâ‚ (projâ‚‚ (projâ‚‚ (presup-â‰ˆ Tâ‰ˆTâ€²)))))
                   , record
                       { âŠ¢Ïƒ   = s-conv âŠ¢Ïƒ (âˆº-cong Î”â‰ˆÎ”â€² Tâ‰ˆTâ€²)
                       ; pÏƒ   = pÏƒ
                       ; v0Ïƒ  = v0Ïƒ
                       ; âŸ¦TâŸ§  = âŸ¦Tâ€²âŸ§
                       ; lvl  = lvlâ€²
                       ; âŠ¢T   = ctxeq-tm Î”â‰ˆÎ”â€² (lift-âŠ¢-Se âŠ¢Tâ€² iâ‰¤lvlâ€²)
                       ; â‰ˆpÏƒ  = s-â‰ˆ-conv â‰ˆpÏƒ Î”â‰ˆÎ”â€²
                       ; â‰ˆv0Ïƒ = â‰ˆ-conv â‰ˆv0Ïƒ ([]-cong-Seâ€² Tâ‰ˆTâ€² âŠ¢pÏƒ)
                       ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦Tâ€²âŸ§â‚
                       ; Tâˆˆğ•Œ  = Tâ€²âˆˆğ•Œ
                       -- we need a Â®El-one-sidedâ€² which operates on the right-side type
                       ; tâˆ¼Ï0 = Â®El-resp-Tâ‰ˆ Tâ€²âˆˆğ•Œ
                                            {!tâˆ¼Ï0!}
                                            ([]-cong-Seâ€² (lift-âŠ¢â‰ˆ-Se Tâ‰ˆTâ€² iâ‰¤lvlâ€²) âŠ¢pÏƒ)
                       ; step = Ïƒâˆ¼Ïâ€²
                       }
                     -- -- we need a Â®El-one-sidedâ€² which operates on the right-side type
                     -- ; tâˆ¼Ï0 = Â®El-resp-Tâ‰ˆ Tâ€²âˆˆğ•Œ (Â®El-one-sided (ğ•Œ-cumu (mâ‰¤mâŠ”n _ _) (ğ•Œ-sym Tâ‰ˆTâ€²â‚)) Tâ€²âˆˆğ•Œ {!!}) ([]-cong-Seâ€² (lift-âŠ¢â‰ˆ-Se Tâ‰ˆTâ€² (mâ‰¤mâŠ”n _ _)) âŠ¢pÏƒ)
  where
    open module gluâˆº = Gluâˆº Ïƒâˆ¼Ï

    lvlâ€²   = max i lvl
    iâ‰¤lvlâ€² = mâ‰¤mâŠ”n i lvl
    Tâ€²âˆˆğ•Œ : âŸ¦Tâ€²âŸ§ âˆˆâ€² ğ•Œ lvlâ€²
    Tâ€²âˆˆğ•Œ   = ğ•Œ-cumu iâ‰¤lvlâ€² (ğ•Œ-refl (ğ•Œ-sym Tâ‰ˆTâ€²â‚))

    âŠ¢pÏƒ : Î“ âŠ¢s pÏƒ âˆ¶ Î¨ âˆ· Î¨s
    âŠ¢pÏƒ = projâ‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ â‰ˆpÏƒ)))


sÂ®-resp-O : âˆ€ n â†’
             (âŠ¢Î” : âŠ¢ Î”) â†’
             Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
             n < len Î” â†’
             --------------------
             O Ïƒ n â‰¡ O Ï n
sÂ®-resp-O {_} {_} {_} {_} 0       âŠ¢Î”        Ïƒâˆ¼Ï n<Î”       = refl
sÂ®-resp-O {_} {_} {_} {Ï} (suc n) âŠ¢[]       Ïƒâˆ¼Ï (sâ‰¤s ())
sÂ®-resp-O {_} {_} {Ïƒ} {Ï} (suc n) (âŠ¢Îº âŠ¢Î”)   Ïƒâˆ¼Ï (sâ‰¤s n<Î”) = trans (Sta.O-+ Ïƒ 1 _) (congâ‚‚ _+_ Oâ‰¡ (trans (O-resp-â‰ˆ n â‰ˆÏƒâˆ¥) (sÂ®-resp-O n âŠ¢Î” step n<Î”)))
  where
    open GluÎº Ïƒâˆ¼Ï
sÂ®-resp-O {_} {_} {Ïƒ} {_} (suc n) (âŠ¢âˆº âŠ¢Î” x) Ïƒâˆ¼Ï n<Î”       = trans (O-resp-â‰ˆ (suc n) â‰ˆpÏƒ) (sÂ®-resp-O (suc n) âŠ¢Î” step n<Î”)
  where
    open Gluâˆº Ïƒâˆ¼Ï


âˆ¥-sÂ® : âˆ€ n â†’
        (âŠ¢Î” : âŠ¢ Î”) â†’
        Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
        n < len Î” â†’
        -----------------------------------------------
        âˆƒâ‚‚ Î» Î¨s Î¨sâ€² â†’ âˆƒâ‚‚ Î» Î“â€² Î”â€² â†’
           Î“ â‰¡ Î¨s ++âº Î“â€² Ã— Î” â‰¡ Î¨sâ€² ++âº Î”â€²
         Ã— len Î¨s â‰¡ O Ïƒ n Ã— len Î¨sâ€² â‰¡ n
         Ã— Î£ (âŠ¢ Î”â€²) Î» âŠ¢Î”â€² â†’ Î“â€² âŠ¢s Ïƒ âˆ¥ n âˆ¶ âŠ¢Î”â€² Â® Ï âˆ¥ n
âˆ¥-sÂ®                 0       âŠ¢Î”         Ïƒâˆ¼Ï n<Î”       = [] , []
                                                       , _ , _
                                                       , refl , refl
                                                       , refl , refl
                                                       , âŠ¢Î” , Ïƒâˆ¼Ï
âˆ¥-sÂ®                 (suc n) âŠ¢[]        Ïƒâˆ¼Ï (sâ‰¤s ())
âˆ¥-sÂ® {Î”} {Î“} {Ïƒ} {Ï} (suc n) (âŠ¢Îº âŠ¢Î”)    Ïƒâˆ¼Ï (sâ‰¤s n<Î”) = helper
  where
    open GluÎº Ïƒâˆ¼Ï

    helper : âˆƒâ‚‚ Î» Î¨s Î¨sâ€² â†’
             âˆƒâ‚‚ Î» Î“â€² Î”â€² â†’
                  Î“ â‰¡ Î¨s ++âº Î“â€² Ã— Î” â‰¡ Î¨sâ€² ++âº Î”â€²
                Ã— len Î¨s â‰¡ O Ïƒ (suc n) Ã— len Î¨sâ€² â‰¡ suc n
                Ã— Î£ (âŠ¢ Î”â€²) Î» âŠ¢Î”â€² â†’ Î“â€² âŠ¢s Ïƒ âˆ¥ suc n âˆ¶ âŠ¢Î”â€² Â® Ï âˆ¥ suc n
    helper
      with âˆ¥-sÂ® n âŠ¢Î” step n<Î”
    ...  | Î¨s , Î¨sâ€² , _ , _ , refl , refl , Î¨sâ‰¡OÏƒâˆ¥ , refl , âŠ¢Î”â€² , Ïƒâˆ¥âˆ¼Ïâˆ¥
          rewrite Sta.âˆ¥-+ Ïƒ 1 (len Î¨sâ€²)   = Î¨sâ» ++ Î¨s , _ âˆ· Î¨sâ€²
                                          , _ , _
                                          , trans Î“â‰¡ (sym (++-++âº Î¨sâ»)) , refl
                                          , trans (length-++ Î¨sâ») (trans (congâ‚‚ _+_
                                                                                lenâ‰¡
                                                                                (trans Î¨sâ‰¡OÏƒâˆ¥ (sym (O-resp-â‰ˆ (len Î¨sâ€²) â‰ˆÏƒâˆ¥))))
                                                                         (sym (Sta.O-+ Ïƒ 1 _))) , refl
                                          , âŠ¢Î”â€² , sÂ®-resp-sâ‰ˆ âŠ¢Î”â€² Ïƒâˆ¥âˆ¼Ïâˆ¥ (âˆ¥-resp-â‰ˆâ€³ Î¨s Î¨sâ€² (s-â‰ˆ-sym â‰ˆÏƒâˆ¥) Î¨sâ‰¡OÏƒâˆ¥)
âˆ¥-sÂ® {Î”} {Î“} {Ïƒ} {Ï} (suc n) (âŠ¢âˆº âŠ¢Î” âŠ¢T) Ïƒâˆ¼Ï n<Î”     = helper
  where
    open Gluâˆº Ïƒâˆ¼Ï

    helper : âˆƒâ‚‚ Î» Î¨s Î¨sâ€² â†’
             âˆƒâ‚‚ Î» Î“â€² Î”â€² â†’
                  Î“ â‰¡ Î¨s ++âº Î“â€² Ã— Î” â‰¡ Î¨sâ€² ++âº Î”â€²
                Ã— len Î¨s â‰¡ O Ïƒ (suc n) Ã— len Î¨sâ€² â‰¡ suc n
                Ã— Î£ (âŠ¢ Î”â€²) Î» âŠ¢Î”â€² â†’ Î“â€² âŠ¢s Ïƒ âˆ¥ suc n âˆ¶ âŠ¢Î”â€² Â® Ï âˆ¥ suc n
    helper
      with âˆ¥-sÂ® (suc n) âŠ¢Î” step n<Î”
    ...  | Î¨s , Î¨â€² âˆ· Î¨sâ€² , _ , _ , refl , refl , Î¨sâ‰¡OpÏƒ , refl , âŠ¢Î”â€² , pÏƒâˆ¼drop[Ï]
        rewrite O-resp-â‰ˆ (suc (len Î¨sâ€²)) â‰ˆpÏƒ = Î¨s , (_ âˆ· Î¨â€²) âˆ· Î¨sâ€²
                                             , _ , _
                                             , refl , refl
                                             , Î¨sâ‰¡OpÏƒ , refl
                                             , âŠ¢Î”â€² , sÂ®-resp-sâ‰ˆ âŠ¢Î”â€² pÏƒâˆ¼drop[Ï] (s-â‰ˆ-trans (âˆ¥-resp-â‰ˆâ€³ Î¨s (Î¨â€² âˆ· Î¨sâ€²) (s-â‰ˆ-sym â‰ˆpÏƒ) Î¨sâ‰¡OpÏƒ) (I-âˆ˜ (âˆ¥-âŠ¢sâ€³ Î¨s ((_ âˆ· Î¨â€²) âˆ· Î¨sâ€²) âŠ¢Ïƒ (trans Î¨sâ‰¡OpÏƒ (sym (O-resp-â‰ˆ (suc (len Î¨sâ€²)) â‰ˆpÏƒ))))))

âˆ¥-sÂ®â€² : âˆ€ Î¨s â†’
        (âŠ¢Î¨sÎ” : âŠ¢ Î¨s ++âº Î”) â†’
        Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î¨sÎ” Â® Ï â†’
        -----------------------------------------------
        âˆƒâ‚‚ Î» Î¨sâ€² Î“â€² â†’
           Î“ â‰¡ Î¨sâ€² ++âº Î“â€²
         Ã— len Î¨sâ€² â‰¡ O Ïƒ (len Î¨s)
         Ã— Î£ (âŠ¢ Î”) Î» âŠ¢Î” â†’ Î“â€² âŠ¢s Ïƒ âˆ¥ (len Î¨s) âˆ¶ âŠ¢Î” Â® Ï âˆ¥ (len Î¨s)
âˆ¥-sÂ®â€² Î¨s âŠ¢Î¨sÎ” Ïƒâˆ¼Ï
  with âˆ¥-sÂ® (len Î¨s) âŠ¢Î¨sÎ” Ïƒâˆ¼Ï (length-<-++âº Î¨s)
... | Î¨sâ€² , Î¨sâ‚ , _ , _ , Î“â‰¡Î¨sâ€²Î“â€² , Î¨sÎ”â‰¡Î¨sâ‚Î”â‚ , Î¨sâ€²â‰¡OÏƒ , Î¨sâ‰¡Î¨sâ‚ , âŠ¢Î”â‚ , Ïƒâˆ¥â‰ˆ
    rewrite ++âº-cancelË¡â€² Î¨s Î¨sâ‚ Î¨sÎ”â‰¡Î¨sâ‚Î”â‚ (sym Î¨sâ‰¡Î¨sâ‚) = Î¨sâ€² , _ , Î“â‰¡Î¨sâ€²Î“â€² , Î¨sâ€²â‰¡OÏƒ , âŠ¢Î”â‚ , Ïƒâˆ¥â‰ˆ

âˆ¥-sÂ®â€³ : âˆ€ Î¨s Î¨sâ€² â†’
        (âŠ¢Î¨sâ€²Î” : âŠ¢ Î¨sâ€² ++âº Î”) â†’
        Î¨s ++âº Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î¨sâ€²Î” Â® Ï â†’
        len Î¨s â‰¡ O Ïƒ (len Î¨sâ€²) â†’
        -----------------------------------------------
        Î£ (âŠ¢ Î”) Î» âŠ¢Î” â†’ Î“ âŠ¢s Ïƒ âˆ¥ (len Î¨sâ€²) âˆ¶ âŠ¢Î” Â® Ï âˆ¥ (len Î¨sâ€²)
âˆ¥-sÂ®â€³ Î¨s Î¨sâ€² âŠ¢Î¨sâ€²Î” Ïƒâˆ¼Ï Î¨sâ‰¡OÏƒ
  with âˆ¥-sÂ®â€² Î¨sâ€² âŠ¢Î¨sâ€²Î” Ïƒâˆ¼Ï
... | Î¨sâ‚ , _ , Î¨sÎ“â‰¡Î¨sâ‚Î“â‚ , Î¨sâ‰¡OÏƒâ‚ , âŠ¢Î”â‚ , Ïƒâˆ¥â‰ˆ
    rewrite ++âº-cancelË¡â€² Î¨s Î¨sâ‚ Î¨sÎ“â‰¡Î¨sâ‚Î“â‚ (trans Î¨sâ‰¡OÏƒ (sym Î¨sâ‰¡OÏƒâ‚)) = âŠ¢Î”â‚ , Ïƒâˆ¥â‰ˆ


sÂ®-irrel : (âŠ¢Î” âŠ¢Î”â€² : âŠ¢ Î”) â†’
           Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
           ------------------
           Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î”â€² Â® Ï
sÂ®-irrel âŠ¢[] âŠ¢[] Ïƒâˆ¼Ï              = Ïƒâˆ¼Ï
sÂ®-irrel (âŠ¢Îº âŠ¢Î”) (âŠ¢Îº âŠ¢Î”â€²) Ïƒâˆ¼Ï     = record
  { âŠ¢Ïƒ   = âŠ¢Ïƒ
  ; Î¨sâ»  = Î¨sâ»
  ; Î“âˆ¥   = Î“âˆ¥
  ; Ïƒâˆ¥   = Ïƒâˆ¥
  ; Î“â‰¡   = Î“â‰¡
  ; â‰ˆÏƒâˆ¥  = â‰ˆÏƒâˆ¥
  ; Oâ‰¡   = Oâ‰¡
  ; lenâ‰¡ = lenâ‰¡
  ; step = sÂ®-irrel âŠ¢Î” âŠ¢Î”â€² step
  }
  where open GluÎº Ïƒâˆ¼Ï
sÂ®-irrel (âŠ¢âˆº âŠ¢Î” _) (âŠ¢âˆº âŠ¢Î”â€² _) Ïƒâˆ¼Ï = record
  { âŠ¢Ïƒ   = âŠ¢Ïƒ
  ; pÏƒ   = pÏƒ
  ; v0Ïƒ  = v0Ïƒ
  ; âŸ¦TâŸ§  = âŸ¦TâŸ§
  ; lvl  = lvl
  ; âŠ¢T   = âŠ¢T
  ; â‰ˆpÏƒ  = â‰ˆpÏƒ
  ; â‰ˆv0Ïƒ = â‰ˆv0Ïƒ
  ; â†˜âŸ¦TâŸ§ = â†˜âŸ¦TâŸ§
  ; Tâˆˆğ•Œ  = Tâˆˆğ•Œ
  ; tâˆ¼Ï0 = tâˆ¼Ï0
  ; step = sÂ®-irrel âŠ¢Î” âŠ¢Î”â€² step
  }
  where open Gluâˆº Ïƒâˆ¼Ï


sÂ®-mon : (âŠ¢Î” : âŠ¢ Î”) â†’
         Î“â€² âŠ¢r Ï„ âˆ¶ Î“ â†’
         Î“ âŠ¢s Ïƒ âˆ¶ âŠ¢Î” Â® Ï â†’
         ------------------
         Î“â€² âŠ¢s Ïƒ âˆ˜ Ï„ âˆ¶ âŠ¢Î” Â® Ï [ mt Ï„ ]
sÂ®-mon âŠ¢[] âŠ¢Ï„ Ïƒâˆ¼Ï = s-âˆ˜ (âŠ¢râ‡’âŠ¢s âŠ¢Ï„) Ïƒâˆ¼Ï
sÂ®-mon {_} {Î“â€²} {Ï„} {Î“} {Ïƒ} {Ï} (âŠ¢Îº âŠ¢Î”) âŠ¢Ï„ Ïƒâˆ¼Ï
  with chop Î“â€² (O-<-len (O Ïƒ 1) (âŠ¢râ‡’âŠ¢s âŠ¢Ï„) (O-<-len 1 (GluÎº.âŠ¢Ïƒ Ïƒâˆ¼Ï) (sâ‰¤s (sâ‰¤s zâ‰¤n))))
...  | Î¨sâ€² , Î“â€²â‚ , refl , eql = record
  { âŠ¢Ïƒ   = s-âˆ˜ âŠ¢Ï„â€² âŠ¢Ïƒ
  ; Î¨sâ»  = Î¨sâ€²
  ; Î“âˆ¥   = Î“â€²â‚
  ; Ïƒâˆ¥   = Ïƒâˆ¥ âˆ˜ Ï„ âˆ¥ O Ïƒ 1
  ; Î“â‰¡   = refl
  ; â‰ˆÏƒâˆ¥  = âˆ˜-cong (s-â‰ˆ-refl âŠ¢Ï„âˆ¥â€²) â‰ˆÏƒâˆ¥
  ; Oâ‰¡   = trans (cong (O Ï„) Oâ‰¡) (O-resp-mt Ï„ (projâ‚ (Ï 0)))
  ; lenâ‰¡ = eql
  ; step = helper
  }
  where open GluÎº Ïƒâˆ¼Ï
        âŠ¢Ï„â€²  = âŠ¢râ‡’âŠ¢s âŠ¢Ï„
        âŠ¢Ï„âˆ¥-helper : Î¨sâ€² ++âº Î“â€²â‚ âŠ¢r Ï„ âˆ¶ Î“ â†’ Î“â€²â‚ âŠ¢r Ï„ âˆ¥ O Ïƒ 1 âˆ¶ Î“âˆ¥
        âŠ¢Ï„âˆ¥-helper âŠ¢Ï„
          rewrite sym lenâ‰¡
                | Î“â‰¡ = âŠ¢r-âˆ¥â€³ Î¨sâ€² Î¨sâ» âŠ¢Ï„ eql
        âŠ¢Ï„âˆ¥  = âŠ¢Ï„âˆ¥-helper âŠ¢Ï„
        âŠ¢Ï„âˆ¥â€² = âŠ¢râ‡’âŠ¢s âŠ¢Ï„âˆ¥

        helper : Î“â€²â‚ âŠ¢s Ïƒâˆ¥ âˆ˜ Ï„ âˆ¥ O Ïƒ 1 âˆ¶ âŠ¢Î” Â® ((Ï [ mt Ï„ ]) âˆ¥ 1)
        helper
          with sÂ®-mon âŠ¢Î” âŠ¢Ï„âˆ¥ step
        ...  | rel
             rewrite Ï-âˆ¥-[] Ï (mt Ï„) 1
                   | sym (sÂ®-resp-O 1 (âŠ¢Îº âŠ¢Î”) Ïƒâˆ¼Ï ((sâ‰¤s (sâ‰¤s zâ‰¤n))))
                   | mt-âˆ¥ Ï„ (O Ïƒ 1) = rel

sÂ®-mon {_} {Î“â€²} {Ï„} {Î“} {Ïƒ} {Ï} (âŠ¢âˆº {_} {T} âŠ¢Î” _) âŠ¢Ï„ Ïƒâˆ¼Ï = record
  { âŠ¢Ïƒ   = âŠ¢ÏƒÏ„
  ; pÏƒ   = pÏƒ âˆ˜ Ï„
  ; v0Ïƒ  = v0Ïƒ [ Ï„ ]
  ; âŸ¦TâŸ§  = âŸ¦TâŸ§ [ mt Ï„ ]
  ; lvl  = lvl
  ; âŠ¢T   = âŠ¢T
  ; â‰ˆpÏƒ  = â‰ˆpÏƒÏ„
  ; â‰ˆv0Ïƒ = â‰ˆ-trans (â‰ˆ-conv ([âˆ˜] âŠ¢Ï„â€² âŠ¢Ïƒ (vlookup (âŠ¢âˆº âŠ¢Î” âŠ¢T) here))
                           (â‰ˆ-trans ([âˆ˜]-Se âŠ¢T (s-wk (âŠ¢âˆº âŠ¢Î” âŠ¢T)) âŠ¢ÏƒÏ„)
                                    ([]-cong-Seâ€³ âŠ¢T â‰ˆpÏƒÏ„)))
                   (â‰ˆ-conv ([]-cong â‰ˆv0Ïƒ (s-â‰ˆ-refl âŠ¢Ï„â€²))
                           ([âˆ˜]-Se âŠ¢T âŠ¢pÏƒ âŠ¢Ï„â€²))
  ; â†˜âŸ¦TâŸ§ = subst (âŸ¦ T âŸ§_â†˜ âŸ¦TâŸ§ [ mt Ï„ ]) (drop-mon Ï (mt Ï„)) (âŸ¦âŸ§-mon (mt Ï„) â†˜âŸ¦TâŸ§)
  ; Tâˆˆğ•Œ  = TÏ„âˆˆğ•Œ
  ; tâˆ¼Ï0 = Â®El-resp-Tâ‰ˆ TÏ„âˆˆğ•Œ (Â®El-mon Tâˆˆğ•Œ TÏ„âˆˆğ•Œ tâˆ¼Ï0 âŠ¢Ï„) ([âˆ˜]-Se âŠ¢T âŠ¢pÏƒ âŠ¢Ï„â€²)
  ; step = helper
  }
  where open Gluâˆº Ïƒâˆ¼Ï
        âŠ¢Ï„â€²  = âŠ¢râ‡’âŠ¢s âŠ¢Ï„
        âŠ¢ÏƒÏ„  = s-âˆ˜ âŠ¢Ï„â€² âŠ¢Ïƒ
        â‰ˆpÏƒÏ„ = s-â‰ˆ-trans (p-âˆ˜ âŠ¢Ïƒ âŠ¢Ï„â€²) (âˆ˜-cong (s-â‰ˆ-refl âŠ¢Ï„â€²) â‰ˆpÏƒ)
        âŠ¢pÏƒ  = projâ‚ (projâ‚‚ (projâ‚‚ (presup-s-â‰ˆ â‰ˆpÏƒ)))
        TÏ„âˆˆğ•Œ = ğ•Œ-mon (mt Ï„) Tâˆˆğ•Œ

        helper : Î“â€² âŠ¢s pÏƒ âˆ˜ Ï„ âˆ¶ âŠ¢Î” Â® drop (mtran-Envs Ï (mt Ï„))
        helper
          rewrite sym (drop-mon Ï (mt Ï„)) = sÂ®-mon âŠ¢Î” âŠ¢Ï„ step
